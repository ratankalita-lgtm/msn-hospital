<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medical Records - MSN Hospital</title>
    <link rel="stylesheet" href="style.css">
    <style>
        body { background-color: #f4f6f8; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        .container { max-width: 100%; height: 100%; display: flex; flex-direction: column; padding: 0; }
        
        /* HEADER */
        .hospital-header { padding: 10px 20px; background: white; border-bottom: 1px solid #ddd; flex-shrink: 0; }
        
        /* LAYOUT */
        .layout-grid { display: grid; grid-template-columns: 350px 1fr; height: 100%; overflow: hidden; }
        
        /* SIDEBAR (List) */
        .sidebar { background: white; border-right: 1px solid #ddd; display: flex; flex-direction: column; height: 100%; }
        .search-box { padding: 15px; background: #f8f9fa; border-bottom: 1px solid #eee; }
        .search-box input { width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 4px; }
        .history-list { flex: 1; overflow-y: auto; padding: 10px; }
        
        /* VISIT CARD */
        .visit-card { background: white; border: 1px solid #eee; border-radius: 6px; padding: 12px; margin-bottom: 8px; cursor: pointer; transition: 0.2s; border-left: 4px solid transparent; }
        .visit-card:hover { background: #f1f8ff; }
        .visit-card.active { background: #e3f2fd; border-left-color: #007bff; border-color: #b6d4fe; }
        .v-date { font-weight: bold; color: #333; font-size: 1.05em; }
        .v-doc { font-size: 0.85em; color: #666; margin-top: 2px; }
        .v-type { font-size: 0.75em; background: #eee; padding: 2px 6px; border-radius: 4px; float: right; }
        .v-pid { font-size: 0.75em; color: #999; margin-top: 4px; }

        /* MAIN CONTENT (Details) */
        .main-content { padding: 30px; overflow-y: auto; background: #f4f6f8; }
        .record-paper { background: white; max-width: 900px; margin: 0 auto; padding: 40px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); min-height: 800px; }
        
        /* TABLES */
        .clinical-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.95em; }
        .clinical-table th { text-align: left; background: #f8f9fa; padding: 10px; border-bottom: 2px solid #ddd; color: #555; }
        .clinical-table td { padding: 10px; border-bottom: 1px solid #eee; vertical-align: top; }
        .clinical-table tr:last-child td { border-bottom: none; }
        
        /* SECTIONS */
        .rec-header { display: flex; justify-content: space-between; border-bottom: 2px solid #007bff; padding-bottom: 20px; margin-bottom: 20px; }
        .rec-section { margin-bottom: 30px; }
        .rec-title { font-size: 0.9em; font-weight: bold; color: #007bff; text-transform: uppercase; border-bottom: 1px solid #eee; padding-bottom: 5px; margin-bottom: 10px; }
        
        .field-label { font-weight: bold; color: #555; font-size: 0.9em; width: 120px; display: inline-block; }
        .field-val { color: #000; }
        .row-item { margin-bottom: 8px; }

        /* PRINT BUTTON */
        .fab-print { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; background: #007bff; color: white; border-radius: 50%; border: none; box-shadow: 0 4px 10px rgba(0,0,0,0.3); font-size: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .fab-print:hover { transform: scale(1.1); background: #0056b3; }
        
        /* SPINNER */
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="container">
    <header class="hospital-header">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <div style="display:flex; align-items:center; gap:10px;">
                <img src="logo.png" style="height:40px;" onerror="this.style.display='none'">
                <div><h3 style="margin:0;">Medical Records</h3><small class="text-muted">Central Archive</small></div>
            </div>
            <div>
                <a href="index.html" class="btn ghost small">Back Home</a>
            </div>
        </div>
    </header>

    <div class="layout-grid">
        <div class="sidebar">
            <div class="search-box">
                <input type="text" id="search_input" placeholder="Enter Patient ID (P-25...) or Phone" onkeypress="handleEnter(event)">
                <button class="btn small" onclick="searchPatient()" style="width:100%; margin-top:10px;">Search Records</button>
            </div>
            <div id="history-list" class="history-list">
                <div style="text-align:center; color:#999; margin-top:20px;">
                    Enter Search Term<br>to view history
                </div>
            </div>
        </div>

        <div class="main-content">
            <div id="record-viewer" class="record-paper hidden">
                </div>
            <div id="empty-state" style="text-align:center; margin-top:150px; color:#aaa;">
                <h1>üìÇ</h1>
                <p>Select a visit from the left to view details.</p>
            </div>
        </div>
    </div>
    
    <button class="fab-print hidden" id="print-fab" onclick="printRecord()" title="Print this Record">üñ®Ô∏è</button>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, getDocs, query, where, orderBy, getDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = { apiKey: "AIzaSyBne_-4FcG5DjtUDVwdd1K-XDsHjX0JOEo", authDomain: "msn-hospital.firebaseapp.com", projectId: "msn-hospital", storageBucket: "msn-hospital.firebasestorage.app", messagingSenderId: "525072218332", appId: "1:525072218332:web:5940ec924f59db675adc19", measurementId: "G-FXXZ7STWDJ" };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let allVisits = [];
    let currentVisitData = null;

    window.handleEnter = (e) => { if(e.key === 'Enter') searchPatient(); }

    window.searchPatient = async () => {
        const term = document.getElementById('search_input').value.trim();
        if(!term) return;

        const listDiv = document.getElementById('history-list');
        listDiv.innerHTML = '<div style="text-align:center; padding:20px;"><div class="spinner"></div> Finding Records...</div>';

        try {
            let phoneToSearch = term;
            
            // 1. If searching by PID, first get the Phone Number from Patient DB
            // This links split records (different PIDs, same person)
            if(term.toUpperCase().startsWith('P-')) {
                const patRef = doc(db, "patients", term.toUpperCase());
                const patSnap = await getDoc(patRef);
                if(patSnap.exists() && patSnap.data().phone) {
                    phoneToSearch = patSnap.data().phone;
                    console.log("Resolved PID to Phone:", phoneToSearch);
                } else {
                    // Fallback: Just search by PID if patient doc missing
                    phoneToSearch = null; 
                }
            }

            // 2. Query Visits
            // Priority: Search by Phone (aggregates all PIDs). Fallback: Search by PID.
            let q;
            if(phoneToSearch && /^\d{10}$/.test(phoneToSearch)) {
                q = query(collection(db, "visits"), where("phone", "==", phoneToSearch));
            } else {
                q = query(collection(db, "visits"), where("pid", "==", term.toUpperCase()));
            }

            const snap = await getDocs(q);
            
            if(snap.empty) {
                listDiv.innerHTML = '<div style="text-align:center; padding:20px; color:#dc3545;">No records found.</div>';
                return;
            }

            // 3. Client-side Sort (Newest First)
            allVisits = snap.docs.map(d => ({...d.data(), id: d.id}));
            allVisits.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

            renderList();

        } catch (e) {
            console.error(e);
            listDiv.innerHTML = `<div style="padding:15px; color:red;">Error: ${e.message}</div>`;
        }
    };

    function renderList() {
        const listDiv = document.getElementById('history-list');
        listDiv.innerHTML = `<div style="padding:10px; background:#e9ecef; font-size:0.8em; font-weight:bold; color:#666;">FOUND ${allVisits.length} VISITS</div>`;

        allVisits.forEach((v, index) => {
            const div = document.createElement('div');
            div.className = `visit-card ${index === 0 ? 'active' : ''}`; // Auto-select first
            
            // Format Date
            let dateDisplay = v.date;
            if(v.isoDate) {
                const parts = v.isoDate.split('-');
                dateDisplay = `${parts[2]}/${parts[1]}/${parts[0]}`;
            }

            div.innerHTML = `
                <span class="v-type">${v.type || 'OPD'}</span>
                <div class="v-date">${dateDisplay}</div>
                <div class="v-doc">${v.doctor || 'Unassigned'}</div>
                <div class="v-pid">${v.pid}</div>
            `;
            div.onclick = () => loadRecord(v, div);
            listDiv.appendChild(div);

            if(index === 0) loadRecord(v, div);
        });
    }

    function loadRecord(v, cardElem) {
        currentVisitData = v;
        
        // UI Highlight
        document.querySelectorAll('.visit-card').forEach(c => c.classList.remove('active'));
        if(cardElem) cardElem.classList.add('active');

        document.getElementById('empty-state').classList.add('hidden');
        document.getElementById('record-viewer').classList.remove('hidden');
        document.getElementById('print-fab').classList.remove('hidden');

        // Helpers
        const safe = (obj, path) => path.split('.').reduce((a, c) => a && a[c], obj) || '-';
        const docD = v.doctorData || {};
        const opto = v.optoData || {};

        // Build Medicine Table
        let medRows = '<tr><td colspan="5" style="text-align:center; color:#999;">No medicines.</td></tr>';
        if(docD.meds && docD.meds.length > 0) {
            medRows = docD.meds.map(m => `<tr><td>${m.name}</td><td>${m.eye}</td><td>${m.dose}</td><td>${m.freq}</td><td>${m.duration}</td></tr>`).join('');
        }

        // Slit Lamp Rows
        const slRows = [
            {l: 'Lids', od: safe(opto, 'slitlamp.od.lids'), os: safe(opto, 'slitlamp.os.lids')},
            {l: 'Conjunctiva', od: safe(opto, 'slitlamp.od.conj'), os: safe(opto, 'slitlamp.os.conj')},
            {l: 'Cornea', od: safe(opto, 'slitlamp.od.corn'), os: safe(opto, 'slitlamp.os.corn')},
            {l: 'AC', od: safe(opto, 'slitlamp.od.ac'), os: safe(opto, 'slitlamp.os.ac')},
            {l: 'Pupil', od: safe(opto, 'slitlamp.od.pupil'), os: safe(opto, 'slitlamp.os.pupil')},
            {l: 'Lens', od: safe(opto, 'slitlamp.lens_od'), os: safe(opto, 'slitlamp.lens_os')}
        ].map(r => `<tr><td>${r.l}</td><td>${r.od}</td><td>${r.os}</td></tr>`).join('');

        // Inject Content
        document.getElementById('record-viewer').innerHTML = `
            <div class="rec-header">
                <div>
                    <h1 style="margin:0; color:#333;">${v.patientName}</h1>
                    <div style="margin-top:5px; color:#555;">PID: <strong>${v.pid}</strong> | Age: ${v.age}Y / ${v.gender}</div>
                    <div style="font-size:0.9em; color:#777;">${v.address || ''} | ${v.phone || ''}</div>
                </div>
                <div style="text-align:right;">
                    <h3 style="margin:0; color:#007bff;">${v.date}</h3>
                    <div>${v.doctor || 'Unassigned'}</div>
                    <div class="badge" style="background:#28a745; display:inline-block; margin-top:5px;">${v.type || 'OPD'}</div>
                </div>
            </div>

            <div class="rec-section">
                <div class="rec-title">Clinical Findings (Optometry)</div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                    <div>
                        <div class="row-item"><span class="field-label">Chief Complaint:</span> ${safe(opto, 'history.complaint')}</div>
                        <div class="row-item"><span class="field-label">History:</span> ${safe(opto, 'history.ocular_hx')}</div>
                        <div class="row-item"><span class="field-label">Systemic:</span> ${safe(opto, 'history.systemic')}</div>
                    </div>
                    <div>
                        <table class="clinical-table" style="margin-top:0;">
                            <tr><th>Test</th><th>OD (Right)</th><th>OS (Left)</th></tr>
                            <tr><td><b>Vision (Dist)</b></td><td>${safe(opto, 'va.od.dist')}</td><td>${safe(opto, 'va.os.dist')}</td></tr>
                            <tr><td><b>Vision (Near)</b></td><td>${safe(opto, 'va.od.near')}</td><td>${safe(opto, 'va.os.near')}</td></tr>
                            <tr><td><b>IOP</b></td><td>${safe(opto, 'slitlamp.iop_od')} mmHg</td><td>${safe(opto, 'slitlamp.iop_os')} mmHg</td></tr>
                        </table>
                    </div>
                </div>
            </div>

            <div class="rec-section">
                <div class="rec-title">Refraction (Final)</div>
                <table class="clinical-table">
                    <thead><tr><th>Eye</th><th>Sph</th><th>Cyl</th><th>Axis</th><th>Add</th><th>VA</th></tr></thead>
                    <tbody>
                        <tr><td>OD</td><td>${safe(opto, 'refraction.od.sph')}</td><td>${safe(opto, 'refraction.od.cyl')}</td><td>${safe(opto, 'refraction.od.ax')}</td><td>${safe(opto, 'refraction.od.add')}</td><td>${safe(opto, 'refraction.od.va')}</td></tr>
                        <tr><td>OS</td><td>${safe(opto, 'refraction.os.sph')}</td><td>${safe(opto, 'refraction.os.cyl')}</td><td>${safe(opto, 'refraction.os.ax')}</td><td>${safe(opto, 'refraction.os.add')}</td><td>${safe(opto, 'refraction.os.va')}</td></tr>
                    </tbody>
                </table>
            </div>

            <div class="rec-section">
                <div class="rec-title">Slit Lamp Examination</div>
                <table class="clinical-table">
                    <thead><tr><th>Structure</th><th>OD</th><th>OS</th></tr></thead>
                    <tbody>${slRows}</tbody>
                </table>
                <div style="margin-top:5px; font-style:italic; color:#666;">Note: ${safe(opto, 'slitlamp.remarks')}</div>
            </div>

            <div class="rec-section" style="background:#f9f9f9; padding:15px; border-left:4px solid #007bff;">
                <div class="rec-title" style="border:none; margin:0 0 10px 0;">Doctor's Notes</div>
                <div style="margin-bottom:10px;"><span class="field-label">Diagnosis:</span> <strong>${docD.diagnosis || '-'}</strong></div>
                <div><span class="field-label">Advice:</span> <span style="white-space: pre-wrap;">${docD.advice || '-'}</span></div>
            </div>

            <div class="rec-section">
                <div class="rec-title">Prescription (Rx)</div>
                <table class="clinical-table">
                    <thead><tr><th>Medicine</th><th>Eye</th><th>Dose</th><th>Freq</th><th>Dur</th></tr></thead>
                    <tbody>${medRows}</tbody>
                </table>
            </div>
            
            <div style="text-align:right; font-size:0.8em; color:#999; border-top:1px solid #eee; padding-top:10px;">
                Record Generated: ${new Date().toLocaleString()}
            </div>
        `;
    }

    window.printRecord = () => {
        if(!currentVisitData) return;
        const content = document.getElementById('record-viewer').innerHTML;
        const win = window.open('', '', 'width=900,height=1000');
        win.document.write(`<html><head><title>${currentVisitData.patientName} - Record</title><link rel="stylesheet" href="style.css"><style>body{padding:40px; background:white; font-family:sans-serif;} .hidden{display:none;} table{width:100%; border-collapse:collapse;} th,td{border-bottom:1px solid #ddd; padding:8px; text-align:left;}</style></head><body>${content}</body></html>`);
        win.document.close();
        win.onload = function() { win.print(); win.close(); };
    }
</script>

</body>
</html>