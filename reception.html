<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reception - MSN Hospital</title>
    <link rel="stylesheet" href="style.css">
    <style>
        :root { --primary: #007bff; --warning: #ffc107; --danger: #dc3545; --success: #28a745; }
        body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg, #f0f2f5); color: var(--text, #333); }
        .hidden { display: none !important; }
        #search-result li { cursor: pointer; transition: background 0.2s; padding: 12px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; }
        #search-result li:hover { background-color: rgba(0,0,0,0.05); }
        .search-grid { display: grid; grid-template-columns: 1fr 1fr auto; gap: 10px; align-items: end; }
        .loading { color: var(--primary); font-weight: bold; text-align: center; padding: 10px; }
        .warning-box { background: #fff3cd; color: #856404; padding: 10px; border: 1px solid #ffeeba; border-radius: 6px; margin-bottom: 15px; font-weight: bold; display: none; align-items: center; gap: 10px; }
        .warning-box.active { display: flex; }
        .stats-breakdown { display: flex; gap: 10px; margin-top: 10px; }
        .mini-stat { flex: 1; padding: 8px; border-radius: 6px; text-align: center; border: 1px solid var(--border); font-size: 0.85em; background: var(--white); }
        .dropdown { position: relative; display: inline-block; }
        .dropdown-menu { display: none; position: absolute; right: 0; background: var(--white); box-shadow: 0 4px 12px rgba(0,0,0,0.15); border-radius: 6px; z-index: 100; min-width: 160px; border: 1px solid var(--border); }
        .dropdown:hover .dropdown-menu { display: block; }
        .dropdown-item { padding: 10px 15px; cursor: pointer; display: block; width: 100%; text-align: left; border: none; background: none; transition: 0.2s; color: var(--text); }
        .dropdown-item:hover { background-color: rgba(0,0,0,0.05); }
        .appt-row { transition: 0.2s; border-bottom: 1px solid var(--border); }
        .appt-row:hover { background-color: rgba(0,0,0,0.02); }
        .btn-checkin { background: #28a745; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.85em; display:flex; align-items:center; gap:5px; }
        .btn-cancel { background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.85em; margin-left: 5px; }
    </style>
</head>
<body>
<div id="toast-container"></div>
<div class="container">
    <header class="hospital-header">
        <img src="logo.png" alt="Logo" class="hospital-logo" onerror="this.style.display='none'">
        <div class="hospital-info">
            <h2>MSN Cataract and IOL Hospital</h2>
            <p class="text-muted">Reception Desk | <a href="index.html" style="text-decoration:none; color:var(--primary);">Back to Home</a></p>
        </div>
        <div style="margin-left:auto; font-size:0.8em; text-align:right; color:var(--text);">
            <div>Shortcuts:</div>
            <div><b>F1</b> Search | <b>F2</b> New | <b>Ctrl+S</b> Save</div>
        </div>
    </header>

    <div class="stats-row">
        <div class="stat-card blue">
            <span class="stat-number" id="stat-total">0</span>
            <span class="stat-label">Total DB</span>
        </div>
        <div class="stat-card green" style="flex:2; display:block; padding:10px 20px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                <span class="stat-label" style="margin:0;">Today's OPD</span>
                <span class="stat-number" id="stat-today" style="font-size:1.5em;">0</span>
            </div>
            <div class="stats-breakdown" id="stats-breakdown">
                <div class="mini-stat">Waiting <strong>0</strong></div>
                <div class="mini-stat">In-Clinic <strong>0</strong></div>
                <div class="mini-stat">Done <strong>0</strong></div>
            </div>
        </div>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 20px;">
        <div style="display:flex; flex-direction:column; gap:20px;">
            
            <section class="card" style="border-top: 4px solid #ffc107;">
                <h3>1. Search Patient (F1)</h3>
                <div class="search-grid">
                    <div><label>Patient ID</label><input id="search_pid" type="text" placeholder="P..." style="text-transform: uppercase;"></div>
                    <div><label>Phone</label><input id="search_phone" type="tel" placeholder="98..." pattern="[0-9]{10}" inputmode="numeric"></div>
                    <button type="button" onclick="searchPatient()" class="btn secondary">Find</button>
                </div>
                <ul id="search-result" style="margin-top:10px; max-height: 200px; overflow-y:auto; padding:0;"></ul>
            </section>

            <section class="card" style="border-top: 4px solid #007bff;">
                <h3 style="margin-bottom: 15px;">2. Patient Details (F2)</h3>
                <div id="age-warning-box" class="warning-box"></div>
                
                <form id="registrationForm" onsubmit="return false;">
                    <div class="row">
                        <div class="col"><label>Patient ID</label><input id="patient_id" type="text" placeholder="New" readonly style="background:rgba(0,123,255,0.1); color:var(--primary); font-weight:bold;"></div>
                        <div class="col"><label>Date of Birth</label><input id="dob" type="date" onchange="calculateAge(this.value)"></div>
                    </div>
                    <div class="row">
                        <div class="col wide">
                            <label>Full Name <span style="color:red">*</span></label>
                            <input id="name" type="text" required placeholder="Name" autocomplete="off">
                        </div>
                        <div class="col">
                            <label>Age</label>
                            <input id="age" type="number" placeholder="0" style="width:60px;" oninput="checkAge(this.value)">
                        </div>
                        <div class="col"><label>Sex</label><select id="gender"><option>Male</option><option>Female</option><option>Other</option></select></div>
                    </div>
                    <div class="row">
                        <div class="col wide"><label>Guardian / C/O</label><input id="guardian" type="text"></div>
                        <div class="col">
                            <label>Phone <span style="color:red">*</span></label>
                            <input id="phone" type="tel" required maxlength="10" pattern="[0-9]{10}" inputmode="numeric">
                            <div id="phone-error" class="error-text" style="color:red; font-size:0.8em; display:none;"></div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col narrow"><label>Pin</label><input id="pincode" type="text"></div>
                        <div class="col"><label>District</label><input id="district" type="text" value="Nagaon"></div>
                        <div class="col wide"><label>Address</label><input id="address" type="text" list="local-places"><datalist id="local-places"></datalist></div>
                    </div>
                    
                    <div class="row" style="padding: 10px; border: 1px solid var(--success); border-radius:4px; background:rgba(40,167,69,0.05);">
                        <div class="col wide">
                            <label style="color:var(--success); font-weight:bold;">Assign Doctor</label>
                            <select id="assigned_doctor" required>
                                <option value="Dr. Jayanta Boroowa">Dr. Jayanta Boroowa</option>
                                <option value="Dr. Pratibha Chauhan Paul">Dr. Pratibha Chauhan Paul</option>
                                <option value="Dr. Nilutpal Borah">Dr. Nilutpal Borah</option>
                                <option value="Dr. Nilakshi Baruah">Dr. Nilakshi Baruah</option>
                                <option value="Dr. Sanjay Kr Buragohain">Dr. Sanjay Kr Buragohain</option>
                            </select>
                        </div>
                        <div class="col"><label>Type</label><select id="visit_type" onchange="updateFee(this.value)"><option value="New Case">New Case</option><option value="Review">Review</option><option value="Surgery">Surgery</option></select></div>
                        <div class="col"><label>Fee (‚Çπ)</label><input id="fee" type="number" value="500"></div>
                    </div>

                    <div class="actions" style="margin-top:15px; display:flex; gap:10px;">
                        <button type="button" class="btn" id="saveBtn" onclick="savePatient()">üíæ Save (Ctrl+S)</button>
                        <button type="button" id="printLastBtn" class="btn warning hidden" onclick="printLastSlip()">üñ®Ô∏è Slip (F5)</button>
                        <button type="button" id="updateBtn" class="btn info hidden" onclick="updatePatientOnly()">Update Info</button>
                        <button type="button" class="btn ghost" onclick="resetForm()">Reset</button>
                    </div>
                </form>
            </section>
        </div>

        <div style="display:flex; flex-direction:column; gap:20px;">
            <section class="card">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h3>Today's OPD List</h3>
                    <div style="font-size:0.8em; color:green;">‚óè Live Sync Active</div>
                </div>
                <table id="patients-table" style="margin-top:15px; width:100%;">
                    <thead><tr><th>OPD</th><th>PID</th><th>Name</th><th>Doctor</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody><tr><td colspan="6" class="loading">Connecting...</td></tr></tbody>
                </table>
            </section>

            <section class="card" style="border-top: 4px solid #6f42c1;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h3>üìÖ Appointment Schedule</h3>
                    <input type="date" id="appt_date_picker" onchange="loadAppointments(this.value)" style="padding:5px;">
                </div>
                
                <div style="background:rgba(0,0,0,0.03); padding:10px; border-radius:6px; margin-bottom:10px;">
                    <div style="display:flex; gap:10px; margin-bottom:5px;">
                        <input id="appt_new_name" placeholder="Patient Name" style="flex:2;">
                        <input id="appt_new_phone" placeholder="Phone" style="flex:1;" pattern="[0-9]{10}">
                    </div>
                    <div style="display:flex; gap:10px;">
                        <select id="appt_new_doc" style="flex:2;">
                            <option value="">-- Select Doctor --</option>
                            <option value="Dr. Jayanta Boroowa">Dr. Jayanta Boroowa</option>
                            <option value="Dr. Pratibha Chauhan Paul">Dr. Pratibha Chauhan Paul</option>
                            <option value="Dr. Nilutpal Borah">Dr. Nilutpal Borah</option>
                            <option value="Dr. Nilakshi Baruah">Dr. Nilakshi Baruah</option>
                            <option value="Dr. Sanjay Kr Buragohain">Dr. Sanjay Kr Buragohain</option>
                        </select>
                        <button class="btn small info" onclick="bookManualAppointment()" style="flex:1;">+ Book</button>
                    </div>
                </div>

                <div style="max-height:300px; overflow-y:auto;">
                    <table id="appointments-table" style="width:100%; font-size:0.9em; border-collapse: collapse;">
                        <thead style="background:rgba(0,0,0,0.05);"><tr><th style="padding:8px;">Type</th><th style="padding:8px;">Patient</th><th style="padding:8px;">Doctor</th><th style="padding:8px;">Action</th></tr></thead>
                        <tbody><tr><td colspan="4" style="text-align:center; padding:10px; color:#666;">Select a date to view appointments.</td></tr></tbody>
                    </table>
                </div>
            </section>
        </div>
    </div>
</div>

<div class="theme-toggle-wrapper">
    <button class="theme-btn" onclick="setTheme('light')" title="Light">‚òÄÔ∏è</button>
    <button class="theme-btn" onclick="setTheme('dark')" title="Dark">üåô</button>
    <button class="theme-btn" onclick="setTheme('high-contrast')" title="Contrast">üëÅÔ∏è</button>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, updateDoc, doc, onSnapshot, query, where, getDocs, setDoc, getCountFromServer, getDoc } 
    from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = { apiKey: "AIzaSyBne_-4FcG5DjtUDVwdd1K-XDsHjX0JOEo", authDomain: "msn-hospital.firebaseapp.com", projectId: "msn-hospital", storageBucket: "msn-hospital.firebasestorage.app", messagingSenderId: "525072218332", appId: "1:525072218332:web:5940ec924f59db675adc19", measurementId: "G-FXXZ7STWDJ" };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    window.db = db; window.updateDoc = updateDoc; window.doc = doc; 

    let todayVisits = [];
    let lastSavedData = null; 
    const nagaonPlaces = ["Nagaon Town", "Haibargaon", "Raha", "Kampur", "Dhing", "Rupahi", "Samaguri", "Kaliabor", "Jakhalabandha", "Hojai", "Lanka", "Doboka", "Lumding", "Batadrava", "Juria"];

    window.addEventListener('load', async () => {
        const dl = document.getElementById('local-places');
        nagaonPlaces.forEach(p => { const o = document.createElement('option'); o.value = p; dl.appendChild(o); });
        try { const coll = collection(db, "patients"); const snapshot = await getCountFromServer(coll); document.getElementById('stat-total').innerText = snapshot.data().count; } catch (e) {}
        
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('appt_date_picker').value = today;
        loadAppointments(today);
    });

    document.addEventListener('keydown', function(e) {
        if ((e.ctrlKey || e.metaKey) && e.key === 's') { e.preventDefault(); document.getElementById('saveBtn').click(); }
        if (e.key === 'F1') { e.preventDefault(); document.getElementById('search_pid').focus(); }
        if (e.key === 'F2') { e.preventDefault(); resetForm(); document.getElementById('name').focus(); }
        if (e.key === 'F5') { e.preventDefault(); if(lastSavedData) printLastSlip(); }
    });

    window.showToast = function(msg, type='info') {
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.innerText = msg;
        toast.style.cssText = `position:fixed; top:20px; right:20px; background:${type==='error'?'#dc3545':'#28a745'}; color:white; padding:10px 20px; border-radius:4px; z-index:10000; animation:slideIn 0.3s ease;`;
        document.getElementById('toast-container').appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }

    function getTodayISO() { const d = new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }

    const q = query(collection(db, "visits"), where("isoDate", "==", getTodayISO()));
    
    onSnapshot(q, (snapshot) => {
        todayVisits = [];
        const tbody = document.querySelector('#patients-table tbody');
        tbody.innerHTML = '';
        let stats = { waiting: 0, clinic: 0, done: 0, total: 0 };

        snapshot.docs.forEach(doc => { 
            const d = { ...doc.data(), id: doc.id };
            todayVisits.push(d);
            if(d.status !== 'Cancelled') {
                stats.total++;
                if(d.status === 'Waiting') stats.waiting++;
                else if(['With Doctor','Investigation','Report Ready'].includes(d.status)) stats.clinic++;
                else if(d.status === 'Completed') stats.done++;
            }
        });
        
        todayVisits.sort((a,b) => (a.timestamp || 0) - (b.timestamp || 0));
        document.getElementById('stat-today').innerText = stats.total;
        document.getElementById('stats-breakdown').innerHTML = `<div class="mini-stat" style="color:#d39e00">Waiting <strong>${stats.waiting}</strong></div><div class="mini-stat" style="color:#0d6efd">In-Clinic <strong>${stats.clinic}</strong></div><div class="mini-stat" style="color:#198754">Done <strong>${stats.done}</strong></div>`;

        if (todayVisits.length === 0) { tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px;">No patients yet today.</td></tr>'; return; }

        todayVisits.forEach(v => {
            const tr = document.createElement('tr');
            let badgeClass = 'waiting';
            if(v.status === 'With Doctor') badgeClass = 'doc';
            else if(v.status === 'Investigation') badgeClass = 'investigation';
            else if(v.status === 'Report Ready') badgeClass = 'report';
            else if(v.status === 'Completed') badgeClass = 'completed';
            else if(v.status === 'Cancelled') badgeClass = 'cancelled';

            tr.innerHTML = `<td><strong>${v.opdId}</strong></td><td>${v.pid}</td><td>${v.patientName}<br><small>${v.age}Y / ${v.gender}</small></td><td>${v.doctor || '-'}</td><td><span class="badge ${badgeClass}">${v.status}</span></td><td><div class="dropdown"><button class="btn small info">Options ‚ñº</button><div class="dropdown-menu"><button class="dropdown-item" onclick="window.printSlip('${v.patientName}', '${v.opdId}', '${v.doctor}', '${v.pid}', '${v.age}', '${v.gender}')">üñ®Ô∏è Print Slip</button><button class="dropdown-item" onclick="window.quickAction('${v.id}', 'Waiting')">‚è≥ Set Waiting</button><button class="dropdown-item danger" onclick="window.quickAction('${v.id}', 'Cancelled')">üö´ Cancel</button></div></div></td>`;
            tbody.appendChild(tr);
        });
    });

    window.quickAction = async function(id, status) {
        if(!confirm(`Change status to ${status}?`)) return;
        try { await updateDoc(doc(db, "visits", id), { status: status }); } 
        catch(e) { alert("Error: " + e.message); }
    };

    // --- APPOINTMENTS ---
    window.loadAppointments = async function(dateStr) {
        const tbody = document.querySelector('#appointments-table tbody');
        tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:10px;">Loading...</td></tr>';
        
        try {
            const q = query(collection(db, "appointments"), where("date", "==", dateStr));
            const snap = await getDocs(q);
            if (snap.empty) { tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:10px; color:#666;">No appointments for this date.</td></tr>'; return; }
            
            tbody.innerHTML = '';
            const appts = snap.docs.map(doc => ({...doc.data(), id: doc.id}));
            appts.sort((a,b) => (a.createdAt || "").localeCompare(b.createdAt || "")); 
            
            appts.forEach(a => {
                if(a.status === 'Cancelled') return;
                const tr = document.createElement('tr');
                tr.className = 'appt-row';
                let typeBadge = a.type === 'Follow-up' ? '<span class="badge" style="background:#17a2b8;">Follow-up</span>' : '<span class="badge" style="background:#6c757d;">New</span>';
                
                let actionBtns = '';
                if(a.status !== 'Arrived') {
                    actionBtns = `<div style="display:flex;"><button class="btn-checkin" onclick="checkInPatient('${a.id}', '${a.patientName}', '${a.pid||''}', '${a.phone||''}', '${a.doctor||''}')" title="Mark Arrived">‚úÖ Arrived</button><button class="btn-cancel" onclick="cancelAppointment('${a.id}')" title="Cancel">‚úï</button></div>`;
                } else { actionBtns = `<span style="color:green; font-weight:bold;">‚úî Checked In</span>`; }

                tr.innerHTML = `<td style="padding:8px;">${typeBadge}</td><td style="padding:8px;"><strong>${a.patientName}</strong><br><small>${a.phone || '-'}</small></td><td style="padding:8px;">${a.doctor || '<span style="color:#999">Unassigned</span>'}</td><td style="padding:8px;">${actionBtns}</td>`;
                
                tr.onclick = (e) => {
                    if(e.target.tagName === 'BUTTON') return;
                    fillForm({ name: a.patientName, phone: a.phone, id: a.pid||"", age: "", gender: "" });
                    if(a.doctor) document.getElementById('assigned_doctor').value = a.doctor;
                };
                tbody.appendChild(tr);
            });
        } catch (e) { console.error(e); }
    };

    window.bookManualAppointment = async function() {
        const name = document.getElementById('appt_new_name').value;
        const phone = document.getElementById('appt_new_phone').value;
        const date = document.getElementById('appt_date_picker').value;
        const docName = document.getElementById('appt_new_doc').value;
        
        if(!name || !date || !phone) { showToast("Name, Phone, and Date are required.", 'error'); return; }
        
        try {
            let linkedPid = ""; let finalName = name;
            const q = query(collection(db, "patients"), where("phone", "==", phone));
            const snap = await getDocs(q);
            if (!snap.empty) {
                const p = snap.docs[0].data();
                linkedPid = p.id;
                finalName = p.name;
                showToast("Found existing patient! Linking ID...", "info");
            }

            await addDoc(collection(db, "appointments"), {
                patientName: finalName, pid: linkedPid, phone: phone, date: date,
                type: linkedPid ? "Follow-up" : "New",
                status: "Scheduled", doctor: docName || "Unassigned", createdBy: "Reception", createdAt: new Date().toISOString()
            });
            
            showToast("Appointment Booked!", 'success');
            document.getElementById('appt_new_name').value = ""; document.getElementById('appt_new_phone').value = "";
            loadAppointments(date);
        } catch(e) { alert("Error: " + e.message); }
    };

    window.checkInPatient = async function(apptId, name, pid, phone, doctor) {
        if(!confirm(`Check-in ${name} and add to OPD Queue?`)) return;
        
        document.getElementById('name').value = name;
        document.getElementById('phone').value = phone;
        if(doctor) document.getElementById('assigned_doctor').value = doctor;
        
        if(!pid && phone) {
             const q = query(collection(db, "patients"), where("phone", "==", phone));
             const snap = await getDocs(q);
             if (!snap.empty) { pid = snap.docs[0].data().id; }
        }

        if(pid) {
            document.getElementById('patient_id').value = pid;
            loadPatientById(pid);
        } else {
            document.getElementById('patient_id').value = "New";
            document.getElementById('visit_type').value = "New Case";
            updateFee("New Case");
        }
        
        try {
            await updateDoc(doc(db, "appointments", apptId), { status: "Arrived" });
            loadAppointments(document.getElementById('appt_date_picker').value); 
            showToast("Patient data loaded. Review and click SAVE.", 'success');
        } catch(e) { console.error(e); }
    };

    window.cancelAppointment = async function(id) {
        if(!confirm("Cancel this appointment?")) return;
        try { await updateDoc(doc(db, "appointments", id), { status: "Cancelled" }); loadAppointments(document.getElementById('appt_date_picker').value); } catch(e) { alert(e.message); }
    };

    async function checkDuplicate(phone) {
        const pid = document.getElementById('patient_id').value;
        if(pid && pid !== "New" && pid !== "") {} 

        const q = query(collection(db, "patients"), where("phone", "==", String(phone)));
        const snap = await getDocs(q);
        if (!snap.empty) {
            const p = snap.docs[0].data();
            if (p.id === pid) return null; 

            document.getElementById('phone').classList.add('invalid');
            document.getElementById('phone-error').innerText = `‚ö†Ô∏è Duplicate: ${p.name} (${p.id})`;
            document.getElementById('phone-error').style.display = 'block';
            return p;
        } else {
            document.getElementById('phone').classList.remove('invalid');
            document.getElementById('phone-error').style.display = 'none';
            return null;
        }
    }
    document.getElementById('phone').addEventListener('blur', (e) => checkDuplicate(e.target.value));

    window.searchPatient = async function() {
        const pid = document.getElementById('search_pid').value.trim().toUpperCase();
        const phone = document.getElementById('search_phone').value.trim();
        const resDiv = document.getElementById('search-result');
        
        if(!pid && !phone) return;
        resDiv.innerHTML = '<li style="color:#666; justify-content:center;">Searching...</li>';
        
        try {
            let p = null;
            if(pid) {
                const docRef = doc(db, "patients", pid);
                const snap = await getDoc(docRef);
                if(snap.exists()) p = snap.data();
            } else if(phone) {
                const q = query(collection(db, "patients"), where("phone", "==", String(phone)));
                const snap = await getDocs(q);
                if(!snap.empty) p = snap.docs[0].data();
            }

            resDiv.innerHTML = '';
            if(!p) { resDiv.innerHTML = '<li style="color:red; justify-content:center;">No patient found.</li>'; return; }
            
            const li = document.createElement('li');
            li.innerHTML = `<div><strong>${p.name}</strong> <small>(${p.age}Y/${p.gender})</small><br><span style="font-size:0.8em; color:#555;">${p.phone} | ${p.address||''}</span></div><div style="text-align:right;"><span class="badge" style="background:#eee; color:#333;">${p.id}</span></div>`;
            li.onclick = () => { fillForm(p); };
            resDiv.appendChild(li);
        } catch (e) { resDiv.innerHTML = '<li style="color:red">Error searching DB</li>'; }
    }

    window.loadPatientById = async function(pid) {
        try {
            const d = await getDoc(doc(db, "patients", pid));
            if(d.exists()) fillForm(d.data());
        } catch(e) { console.error(e); }
    }

    function fillForm(p) {
        document.getElementById('patient_id').value = p.id || ""; 
        document.getElementById('name').value = p.name || ""; 
        document.getElementById('age').value = p.age || ""; 
        document.getElementById('dob').value = p.dob || ''; 
        document.getElementById('gender').value = p.gender || "Male"; 
        document.getElementById('phone').value = p.phone || ""; 
        document.getElementById('address').value = p.address || ''; 
        document.getElementById('guardian').value = p.guardian || ''; 
        document.getElementById('district').value = p.district || 'Nagaon'; 
        document.getElementById('pincode').value = p.pincode || ''; 
        
        if(p.id) {
            document.getElementById('visit_type').value = "Review";
            updateFee("Review");
            document.getElementById('updateBtn').classList.remove('hidden'); 
        } else {
            document.getElementById('visit_type').value = "New Case";
            updateFee("New Case");
        }
        
        if(p.age) window.checkAge(p.age);
    }

    window.updateFee = function(type) {
        const feeBox = document.getElementById('fee');
        if(type === 'Review') feeBox.value = 300;
        else feeBox.value = 500;
    }

    window.savePatient = async function() {
        if (!document.getElementById('updateBtn').classList.contains('hidden')) {
            if(!confirm("‚ö†Ô∏è Patient loaded. Create a NEW VISIT for today?\n(Click Cancel to just update patient info)")) return;
        }

        const name = document.getElementById('name').value; const phone = document.getElementById('phone').value; const doctor = document.getElementById('assigned_doctor').value;
        if(!name || !phone || !doctor) { alert("Please fill Name, Phone, and select a Doctor."); return; }
        if(!/^\d{10}$/.test(phone)) { alert("Phone number must be exactly 10 digits."); return; }

        const isEditMode = !document.getElementById('updateBtn').classList.contains('hidden');
        if(!isEditMode) {
            const dup = await checkDuplicate(phone);
            if(dup && !confirm(`‚ö†Ô∏è Patient ${dup.name} already exists with this phone.\n\nCreate duplicate entry anyway?`)) return;
        }
        
        const pidInput = document.getElementById('patient_id').value;
        if(pidInput && pidInput !== 'New') {
             const alreadyBooked = todayVisits.find(v => v.pid === pidInput && v.status !== 'Cancelled');
             if(alreadyBooked) {
                 alert(`‚ö†Ô∏è This patient is already booked today (OPD ${alreadyBooked.opdId}).`);
                 return;
             }
        }

        const btn = document.getElementById('saveBtn'); btn.innerText = "Processing..."; btn.disabled = true;
        try {
            const age = document.getElementById('age').value; const gender = document.getElementById('gender').value; const dob = document.getElementById('dob').value;
            const isNew = !pidInput || pidInput === 'New' || pidInput === ''; let finalPid = pidInput;
            
            if(isNew) {
                const yr = new Date().getFullYear().toString().substr(-2);
                let isUnique = false;
                while(!isUnique) {
                    const rnd = Math.floor(1000 + Math.random() * 9000); 
                    finalPid = `P-${yr}${rnd}`;
                    const d = await getDoc(doc(db, "patients", finalPid));
                    if(!d.exists()) isUnique = true;
                }
                
                await setDoc(doc(db, "patients", finalPid), { id: finalPid, name, age, gender, phone: String(phone), dob, address: document.getElementById('address').value, guardian: document.getElementById('guardian').value, district: document.getElementById('district').value, pincode: document.getElementById('pincode').value, createdAt: new Date().toISOString() });
            }

            const opdId = Math.floor(10000 + Math.random() * 90000).toString();
            
            await addDoc(collection(db, "visits"), {
                pid: finalPid, patientName: name, age, gender, phone: String(phone),
                address: document.getElementById('address').value,
                doctor, opdId, status: "Waiting",
                date: new Date().toLocaleDateString('en-GB'), isoDate: getTodayISO(),
                type: document.getElementById('visit_type').value, fee: document.getElementById('fee').value, timestamp: Date.now()
            });

            showToast("‚úÖ Saved! OPD ID: " + opdId, "success");
            lastSavedData = { name, opdId, doctor, pid: finalPid, age, gender }; document.getElementById('printLastBtn').classList.remove('hidden'); document.getElementById('saveBtn').innerText = "Saved ‚úÖ";
        } catch(e) { alert("Error: " + e.message); btn.innerText = "üíæ Save (Ctrl+S)"; btn.disabled = false; } 
    }

    window.printLastSlip = function() { if(!lastSavedData) return; window.printSlip(lastSavedData.name, lastSavedData.opdId, lastSavedData.doctor, lastSavedData.pid, lastSavedData.age, lastSavedData.gender); if(confirm("Slip Printed. Clear form?")) resetForm(); };
    
    window.updatePatientOnly = async function() {
        const pid = document.getElementById('patient_id').value; if(!pid || pid === 'New') return;
        try {
            const btn = document.getElementById('updateBtn'); btn.innerText = "Updating...";
            await updateDoc(doc(db, "patients", pid), { name: document.getElementById('name').value, age: document.getElementById('age').value, phone: String(document.getElementById('phone').value), gender: document.getElementById('gender').value, dob: document.getElementById('dob').value, address: document.getElementById('address').value, district: document.getElementById('district').value, pincode: document.getElementById('pincode').value, guardian: document.getElementById('guardian').value });
            alert("Patient Details Updated!"); btn.innerText = "Update Info";
        } catch(e) { alert(e.message); }
    }

    window.printSlip = function(name, opd, docName, pid, age, sex) {
        const win = window.open('', '', 'width=400,height=500');
        win.document.write(`<html><body style="font-family:sans-serif; text-align:center; padding:20px;"><img src="logo.png" style="width:80px;"><h3>MSN Cataract & IOL Hospital</h3><p>OPD SLIP</p><hr><h1 style="font-size:3em; margin:10px 0;">${opd}</h1><p><strong>Date:</strong> ${new Date().toLocaleDateString('en-GB')}</p><p><strong>Name:</strong> ${name}</p><p><strong>PID:</strong> ${pid} &nbsp;|&nbsp; <strong>${age}Y / ${sex}</strong></p><p><strong>Doctor:</strong> ${docName}</p><hr><small>Please wait for your turn.</small></body></html>`);
        win.document.close(); win.onload = function() { win.print(); win.close(); };
    }

    window.resetForm = function() { document.getElementById('registrationForm').reset(); document.getElementById('patient_id').value = ""; document.getElementById('search-result').innerHTML = ""; document.getElementById('updateBtn').classList.add('hidden'); document.getElementById('printLastBtn').classList.add('hidden'); document.getElementById('saveBtn').innerText = "üíæ Save (Ctrl+S)"; document.getElementById('saveBtn').disabled = false; document.getElementById('age-warning-box').className = "warning-box"; document.getElementById('phone').classList.remove('invalid'); document.getElementById('phone-error').style.display='none'; document.getElementById('age').readOnly=false; lastSavedData = null; }
    
    window.calculateAge = function(dob) { if(!dob) return; const d = new Date(dob); const diff = Date.now() - d.getTime(); const age = Math.abs(new Date(diff).getUTCFullYear() - 1970); document.getElementById('age').value = age; document.getElementById('age').readOnly = true; window.checkAge(age); }
    window.checkAge = function(age) { const box = document.getElementById('age-warning-box'); if(!age) { box.className="warning-box"; return; } if(age < 12) { box.innerText = "‚ö†Ô∏è Paediatric Patient (Child)"; box.className="warning-box active"; } else if(age >= 60) { box.innerText = "‚ö†Ô∏è Senior Citizen"; box.className="warning-box active"; } else { box.className="warning-box"; } }
</script>
<script>
    const savedTheme = localStorage.getItem('app-theme') || 'light';
    document.documentElement.setAttribute('data-theme', savedTheme);
    updateActiveButton(savedTheme);

    window.setTheme = function(theme) {
        document.documentElement.setAttribute('data-theme', theme);
        localStorage.setItem('app-theme', theme);
        updateActiveButton(theme);
    }

    function updateActiveButton(theme) {
        document.querySelectorAll('.theme-btn').forEach(btn => btn.classList.remove('active'));
        const icons = { 'light': '‚òÄÔ∏è', 'dark': 'üåô', 'high-contrast': 'üëÅÔ∏è' };
        Array.from(document.querySelectorAll('.theme-btn')).find(b => b.innerText.includes(icons[theme]))?.classList.add('active');
    }
</script>
</body>
</html>