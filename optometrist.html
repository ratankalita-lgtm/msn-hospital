<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Optometrist - MSN Hospital</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .hidden { display: none; }
        .small-input { width: 100%; text-align: center; padding: 5px; border: 1px solid #ccc; border-radius: 4px; }
        .opto-grid { display: grid; grid-template-columns: 150px 1fr 1fr; gap: 10px; align-items: center; padding: 8px 0; border-bottom: 1px solid #f0f0f0; }
        .opto-grid.header { font-weight: bold; background-color: #f8f9fa; border-bottom: 2px solid #dee2e6; padding: 10px 5px; }
        .opto-grid.pgp { grid-template-columns: 100px 1fr 1fr 1fr 1fr; }
        .opto-grid.refraction { grid-template-columns: 100px 1fr 1fr 1fr 1fr 1fr; }
        .status-waiting { color: #856404; background-color: #fff3cd; padding: 2px 6px; border-radius: 4px; font-size: 0.9em; }
        .added-item { display: inline-block; background: #e9ecef; padding: 4px 8px; margin: 4px 4px 4px 0; border-radius: 15px; font-size: 0.9em; border: 1px solid #ced4da; }
        .remove-x { color: red; margin-left: 6px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <header class="hospital-header">
        <img src="logo.png" alt="Logo" class="hospital-logo" onerror="this.style.display='none'">
        <div><h2>Optometrist Workstation</h2><p class="text-muted">Clinical Workup & Refraction</p></div>
    </header>

    <section class="card" id="queue-view">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 15px;">
            <h3>Patients Waiting</h3>
            <div style="display:flex; gap:10px; align-items:center;"><span style="font-size:0.8em; color:green;">● Live Sync Active</span><button class="btn ghost small" onclick="location.reload()">Refresh</button></div>
        </div>
        <table id="opto-queue-table"><thead><tr><th>OPD No</th><th>PID</th><th>Name</th><th>Address</th><th>Age/Sex</th><th>Status</th><th>Action</th></tr></thead><tbody><tr><td colspan="7" style="text-align:center; padding:20px;">Connecting...</td></tr></tbody></table>
    </section>

    <section class="form-container hidden" id="workup-view">
        <div style="background:#e3f2fd; padding:15px; margin-bottom:20px; border-radius:6px; border-left: 5px solid #007bff; display:flex; justify-content:space-between; align-items:center;">
            <div><h3 id="p-header" style="margin:0; color:#007bff">Patient Name</h3><p id="p-details" style="margin:5px 0 0 0; color:#555;">PID: - </p></div>
            <button class="btn ghost small" onclick="closeWorkup()">Back to Queue</button>
        </div>

        <form id="optoForm">
            <fieldset><legend>Clinical History</legend>
                <div class="row"><div class="col wide"><label>Chief Complaint</label><textarea id="chief_complaint" rows="2"></textarea></div><div class="col wide"><label>Ocular / Medical History</label><textarea id="ocular_history" rows="2"></textarea></div></div>
                <div class="row" style="align-items: flex-end;"><div class="col"><label>Systemic Diseases</label><select id="sys_select"><option value="">-- Select --</option><option value="Diabetes (DM)">Diabetes (DM)</option><option value="Hypertension (HTN)">Hypertension (HTN)</option><option value="Cardiac">Cardiac</option><option value="Asthma">Asthma</option><option value="Thyroid">Thyroid</option><option value="Other">Other</option></select></div><div class="col narrow"><label>Duration</label><input id="sys_duration" type="text" placeholder="e.g. 5 yrs"></div><div class="col narrow"><button type="button" class="btn small" onclick="addSystemicDisease()">+ Add</button></div><div class="col"><label>Allergies</label><input id="allergies" type="text"></div></div>
                <div id="sys_disease_list" style="margin-top:5px; margin-bottom:10px;"></div>
            </fieldset>

            <fieldset><legend>Previous Glasses (PGP)</legend>
                <div class="opto-grid pgp header"><div>Eye</div><div>Sph</div><div>Cyl</div><div>Axis</div><div>Add</div></div>
                <div class="opto-grid pgp"><div>Right (OD)</div><input id="pgp_sph_od" class="small-input"><input id="pgp_cyl_od" class="small-input"><input id="pgp_ax_od" class="small-input"><input id="pgp_add_od" class="small-input"></div>
                <div class="opto-grid pgp"><div>Left (OS)</div><input id="pgp_sph_os" class="small-input"><input id="pgp_cyl_os" class="small-input"><input id="pgp_ax_os" class="small-input"><input id="pgp_add_os" class="small-input"></div>
            </fieldset>

            <fieldset><legend>Visual Acuity</legend>
                <div class="opto-grid header"><div>Test</div><div>Right Eye (OD)</div><div>Left Eye (OS)</div></div>
                <div class="opto-grid"><div>Distance (Unaided)</div><input id="va_od_dist" class="small-input"><input id="va_os_dist" class="small-input"></div>
                <div class="opto-grid"><div>With Rx</div><input id="va_od_rx" class="small-input"><input id="va_os_rx" class="small-input"></div>
                <div class="opto-grid"><div>Pinhole</div><input id="va_od_ph" class="small-input"><input id="va_os_ph" class="small-input"></div>
                <div class="opto-grid"><div>Near</div><input id="va_od_near" class="small-input" value="N6"><input id="va_os_near" class="small-input" value="N6"></div>
            </fieldset>

            <fieldset><legend>Refraction</legend>
                <div class="opto-grid refraction header"><div>Eye</div><div>Sph</div><div>Cyl</div><div>Axis</div><div>Add</div><div>Final VA</div></div>
                <div class="opto-grid refraction"><div><strong>OD</strong></div><input id="rx_sph_od" class="small-input"><input id="rx_cyl_od" class="small-input"><input id="rx_ax_od" class="small-input"><input id="rx_add_od" class="small-input"><input id="rx_va_od" class="small-input"></div>
                <div class="opto-grid refraction"><div><strong>OS</strong></div><input id="rx_sph_os" class="small-input"><input id="rx_cyl_os" class="small-input"><input id="rx_ax_os" class="small-input"><input id="rx_add_os" class="small-input"><input id="rx_va_os" class="small-input"></div>
            </fieldset>

            <fieldset><legend>Examination</legend>
                <div class="opto-grid header"><div>Exam</div><div>Right Eye</div><div>Left Eye</div></div>
                <div class="opto-grid"><div>External</div><input id="ext_od" class="small-input" value="WNL"><input id="ext_os" class="small-input" value="WNL"></div>
                <div class="opto-grid"><div>EOM</div><input id="eom_od" class="small-input" value="Full/Free"><input id="eom_os" class="small-input" value="Full/Free"></div>
                <div class="opto-grid"><div>Cover Test (Dist)</div><input id="ct_dist_od" class="small-input" value="Ortho"><input id="ct_dist_os" class="small-input" value="Ortho"></div>
                <div class="opto-grid"><div>Cover Test (Near)</div><input id="ct_near_od" class="small-input" value="Ortho"><input id="ct_near_os" class="small-input" value="Ortho"></div>
                
                <div class="opto-grid header" style="margin-top:10px;"><div>Slit Lamp</div><div>Right Eye</div><div>Left Eye</div></div>
                <div class="opto-grid"><div>Lids</div><input id="sl_lids_od" value="NAD"><input id="sl_lids_os" value="NAD"></div>
                <div class="opto-grid"><div>Conjunctiva</div><input id="sl_conj_od" value="Clear"><input id="sl_conj_os" value="Clear"></div>
                <div class="opto-grid"><div>Cornea</div><input id="sl_corn_od" value="Clear"><input id="sl_corn_os" value="Clear"></div>
                <div class="opto-grid"><div>AC</div><input id="sl_ac_od" value="Normal"><input id="sl_ac_os" value="Normal"></div>
                <div class="opto-grid"><div>Pupil</div><input id="sl_pupil_od" value="R R R"><input id="sl_pupil_os" value="R R R"></div>
                <div class="opto-grid"><div>Lens</div><input id="sl_lens_od" class="small-input"><input id="sl_lens_os" class="small-input"></div>
                <div class="opto-grid"><div><strong>IOP (mmHg)</strong></div><input id="sl_iop_od" type="number" class="small-input"><input id="sl_iop_os" type="number" class="small-input"></div>
                <div class="row" style="margin-top:10px;"><div class="col wide"><label>Remarks</label><input id="sl_remarks" type="text"></div></div>
            </fieldset>
            
            <div class="row" style="background:#fff3cd; padding:10px; margin-top:15px;">
                <div class="col wide"><label style="font-weight:bold;">Dilation</label>
                    <select id="dilation_instruct"><option value="None">-- Select --</option><option value="Dilate">Dilate</option><option value="Dilate after consultation">Dilate after consultation</option><option value="Do not dilate">Do not dilate</option></select>
                </div>
            </div>

            <div class="actions" style="margin-top: 20px;">
                <button type="button" class="btn" onclick="saveWorkup()">Save & Send to Doctor</button>
                <button type="button" class="btn info" onclick="printRx()">Print Spectacle Rx</button>
                <button type="button" class="btn ghost" onclick="closeWorkup()">Cancel</button>
            </div>
        </form>
    </section>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, doc, updateDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBne_-4FcG5DjtUDVwdd1K-XDsHjX0JOEo",
        authDomain: "msn-hospital.firebaseapp.com",
        projectId: "msn-hospital",
        storageBucket: "msn-hospital.firebasestorage.app",
        messagingSenderId: "525072218332",
        appId: "1:525072218332:web:5940ec924f59db675adc19",
        measurementId: "G-FXXZ7STWDJ"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let currentVisit = null;
    let allVisits = [];
    let allPatients = []; 
    let systemicDiseasesList = [];

    onSnapshot(collection(db, "patients"), (snapshot) => {
        allPatients = snapshot.docs.map(doc => doc.data());
        if(allVisits.length > 0) renderQueue();
    });

    const todayIso = new Date().toLocaleDateString('en-CA');
    onSnapshot(collection(db, "visits"), (snapshot) => {
        allVisits = snapshot.docs.map(doc => ({ ...doc.data(), firebaseId: doc.id }));
        renderQueue();
    });

    function renderQueue() {
        const tbody = document.querySelector('#opto-queue-table tbody');
        if (!tbody) return;
        tbody.innerHTML = '';
        const queue = allVisits.filter(v => {
            const isToday = (v.isoDate && v.isoDate === todayIso) || (v.date === new Date().toLocaleDateString());
            return isToday && v.status === 'Waiting';
        });
        if (queue.length === 0) { tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:20px;">No patients waiting.</td></tr>'; return; }

        queue.forEach(v => {
            const patientData = allPatients.find(p => p.id === v.pid);
            const address = patientData ? patientData.address : '-';
            const tr = document.createElement('tr');
            tr.innerHTML = `<td><strong>${v.opdId}</strong></td><td>${v.pid}</td><td>${v.patientName}</td><td>${address}</td><td>${v.age}Y/${v.gender}</td><td><span class="status-waiting">${v.status}</span></td><td><button class="btn small" onclick="window.loadPatient('${v.firebaseId}')">Workup</button></td>`;
            tbody.appendChild(tr);
        });
    }

    window.loadPatient = function(firebaseId) {
        currentVisit = allVisits.find(v => v.firebaseId === firebaseId);
        if(!currentVisit) return;
        document.getElementById('queue-view').classList.add('hidden');
        document.getElementById('workup-view').classList.remove('hidden');
        document.getElementById('p-header').innerText = currentVisit.patientName;
        document.getElementById('p-details').innerText = `PID: ${currentVisit.pid}`;
        document.getElementById('optoForm').reset();
        systemicDiseasesList = [];
        renderSysList();
    };

    window.closeWorkup = function() {
        document.getElementById('workup-view').classList.add('hidden');
        document.getElementById('queue-view').classList.remove('hidden');
        currentVisit = null;
    };

    window.addSystemicDisease = function() {
        const d = document.getElementById('sys_select').value;
        const dur = document.getElementById('sys_duration').value;
        if(!d) return;
        systemicDiseasesList.push({ name: d, dur: dur });
        renderSysList();
    };
    window.removeSysDisease = function(index) { systemicDiseasesList.splice(index, 1); renderSysList(); };
    function renderSysList() {
        const c = document.getElementById('sys_disease_list'); c.innerHTML = '';
        systemicDiseasesList.forEach((item, index) => {
            c.innerHTML += `<span class="added-item">${item.name} (${item.dur}) <span class="remove-x" onclick="removeSysDisease(${index})">×</span></span>`;
        });
    }

    function v(id) { return document.getElementById(id) ? document.getElementById(id).value : ""; }

    window.saveWorkup = async function() {
        if(!currentVisit) return;
        
        let systemicString = systemicDiseasesList.map(x => `${x.name} (${x.dur})`).join(', ');

        const optoData = {
            history: {
                complaint: v('chief_complaint'),
                ocular_hx: v('ocular_history'),
                systemic: systemicString || "None",
                allergies: v('allergies')
            },
            pgp: {
                od: { sph: v('pgp_sph_od'), cyl: v('pgp_cyl_od'), ax: v('pgp_ax_od'), add: v('pgp_add_od') },
                os: { sph: v('pgp_sph_os'), cyl: v('pgp_cyl_os'), ax: v('pgp_ax_os'), add: v('pgp_add_os') }
            },
            va: {
                od: { dist: v('va_od_dist'), rx: v('va_od_rx'), ph: v('va_od_ph'), near: v('va_od_near') },
                os: { dist: v('va_os_dist'), rx: v('va_os_rx'), ph: v('va_os_ph'), near: v('va_os_near') }
            },
            external: {
                od: { ext: v('ext_od'), eom: v('eom_od'), ct_dist: v('ct_dist_od'), ct_near: v('ct_near_od') },
                os: { ext: v('ext_os'), eom: v('eom_os'), ct_dist: v('ct_dist_os'), ct_near: v('ct_near_os') }
            },
            refraction: {
                od: { sph: v('rx_sph_od'), cyl: v('rx_cyl_od'), ax: v('rx_ax_od'), add: v('rx_add_od'), va: v('rx_va_od') },
                os: { sph: v('rx_sph_os'), cyl: v('rx_cyl_os'), ax: v('rx_ax_os'), add: v('rx_add_os'), va: v('rx_va_os') }
            },
            slitlamp: {
                iop_od: v('sl_iop_od'), iop_os: v('sl_iop_os'), 
                lens_od: v('sl_lens_od'), lens_os: v('sl_lens_os'),
                remarks: v('sl_remarks'),
                od: { lids: v('sl_lids_od'), conj: v('sl_conj_od'), corn: v('sl_corn_od'), ac: v('sl_ac_od'), pupil: v('sl_pupil_od') },
                os: { lids: v('sl_lids_os'), conj: v('sl_conj_os'), corn: v('sl_corn_os'), ac: v('sl_ac_os'), pupil: v('sl_pupil_os') }
            },
            plan: {
                dilation: v('dilation_instruct')
            }
        };

        try {
            const btn = document.querySelector('.btn'); btn.innerText = "Saving...";
            await updateDoc(doc(db, "visits", currentVisit.firebaseId), {
                optoData: optoData,
                status: "With Doctor"
            });
            alert("Success! Sent to Doctor.");
            closeWorkup();
        } catch(e) {
            alert("Error saving: " + e.message);
        } finally {
            document.querySelector('.btn').innerText = "Save & Send to Doctor";
        }
    };

    window.printRx = function() {
        if(!currentVisit) return;
        const n = currentVisit.patientName;
        const d = new Date().toLocaleDateString();
        const win = window.open('', '', 'width=750,height=500');
        
        const content = `
            <html><head><base href="${window.location.href}">
            <style>body{font-family:sans-serif;padding:30px;} .rx-table{width:100%;border-collapse:collapse;margin-top:15px;} .rx-table th,.rx-table td{border:1px solid #999;padding:10px;text-align:center;} </style>
            </head><body onload="setTimeout(function(){window.print()}, 800)">
                <div style="text-align:center;border-bottom:3px solid #004085;padding-bottom:10px;margin-bottom:20px;">
                    <img src="logo.png" style="width:100px;" onload="window.print();window.close();">
                    <h2 style="color:#004085;margin:0;">MSN Cataract and IOL Hospital</h2>
                    <p style="margin:2px;">Tilak Deka Road, Nagaon, Assam | Phone: 8486887503</p>
                </div>
                <h3 style="text-align:center;text-decoration:underline;">Spectacle Prescription</h3>
                <p><strong>Name:</strong> ${n} &nbsp;&nbsp; <strong>Date:</strong> ${d}</p>
                <table class="rx-table">
                    <thead><tr><th>Eye</th><th>Sph</th><th>Cyl</th><th>Axis</th><th>Add</th><th>VA</th></tr></thead>
                    <tbody>
                        <tr><td>OD</td><td>${v('rx_sph_od')}</td><td>${v('rx_cyl_od')}</td><td>${v('rx_ax_od')}</td><td>${v('rx_add_od')}</td><td>${v('rx_va_od')}</td></tr>
                        <tr><td>OS</td><td>${v('rx_sph_os')}</td><td>${v('rx_cyl_os')}</td><td>${v('rx_ax_os')}</td><td>${v('rx_add_os')}</td><td>${v('rx_va_os')}</td></tr>
                    </tbody>
                </table>
                <br><br>
                <div style="text-align:center;">______________________________<br>Signature (Optometrist)</div>
            </body></html>`;
        win.document.write(content);
        win.document.close();
    };
</script>

</body>
</html>