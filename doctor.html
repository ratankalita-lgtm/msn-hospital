<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doctor Console - MSN Hospital</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .hidden { display: none; }
        .row { display: flex; gap: 10px; margin-bottom: 10px; }
        .col { flex: 1; display: flex; flex-direction: column; }
        textarea { width: 100%; box-sizing: border-box; }
        input { box-sizing: border-box; width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;}
        select { padding: 8px; border-radius: 4px; border:1px solid #ccc;}
        .med-row input { margin-bottom: 5px; }
        
        .print-control { display: flex; align-items: center; gap: 5px; font-size: 0.9em; color: #555; }
        .template-bar { display: flex; gap: 5px; margin-bottom: 5px; }
        .template-bar select { flex: 1; font-size: 0.9em; padding: 4px; }
        .template-bar button { padding: 4px 8px; font-size: 0.8em; cursor: pointer; background: #e9ecef; border: 1px solid #ced4da; border-radius: 4px; }

        details.opto-box { background: #fff3cd; border: 1px solid #ffeeba; border-radius: 4px; padding: 10px; margin-bottom: 15px; }
        details.opto-box summary { cursor: pointer; font-weight: bold; color: #856404; list-style: none; display: flex; align-items: center; gap: 5px; }
        
        .opto-grid-view { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 10px; font-size: 0.95em; color: #333; border-top: 1px solid #ffeeba; padding-top: 10px; }
        .opto-section h5 { margin: 0 0 5px 0; color: #555; text-transform: uppercase; font-size: 0.8em; border-bottom: 1px solid #ddd; }
        .opto-data-row { display: flex; justify-content: space-between; margin-bottom: 4px; border-bottom: 1px dashed #eee; padding-bottom: 2px; }
        .sl-grid { display: grid; grid-template-columns: 80px 1fr 1fr; gap: 5px; font-size: 0.9em; margin-top: 5px; }
        .sl-grid div { border-bottom: 1px solid #eee; padding: 2px; }
    </style>
</head>
<body>

<div class="container">
    <header class="hospital-header">
        <img src="logo.png" alt="Logo" class="hospital-logo" onerror="this.style.display='none'">
        <div>
            <h2>Doctor Console</h2>
            <p class="text-muted" id="welcome-msg">Welcome</p>
        </div>
        <button class="btn ghost small" onclick="logout()" style="margin-left:auto;">Change Doctor</button>
    </header>

    <section id="doc-queue-section" class="card">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3>My Patients Queue</h3>
            <span style="color:green; font-size:0.8em;">‚óè Live Sync Active</span>
        </div>
        <table id="doc-queue" style="width:100%; margin-top:10px; border-collapse: collapse;">
            <thead>
                <tr style="background:#f8f9fa; text-align:left;">
                    <th style="padding:8px;">OPD</th>
                    <th>Patient</th>
                    <th>Type</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                <tr><td colspan="4" style="text-align:center; padding:20px;">Loading...</td></tr>
            </tbody>
        </table>
    </section>

    <section id="consult-section" class="card hidden">
        <div style="background:#e3f2fd; padding:15px; border-left:5px solid #007bff; margin-bottom:15px; display:flex; justify-content:space-between;">
            <div>
                <h2 id="p-name" style="margin:0; color:#007bff;">-</h2>
                <small id="p-info" style="color:#555;">-</small>
            </div>
            <button class="btn ghost" onclick="cancelConsult()">Back</button>
        </div>
        
        <details class="opto-box" id="opto-details">
            <summary>üëÅÔ∏è View Optometrist Workup</summary>
            <div id="opto-content" class="opto-grid-view"></div>
        </details>

        <form onsubmit="event.preventDefault(); window.saveConsult();">
            <div class="row">
                <div class="col">
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                        <label>Diagnosis</label>
                        <label class="print-control"><input type="checkbox" id="chk_diagnosis" checked> Print on Rx</label>
                    </div>
                    <textarea id="diagnosis" rows="2"></textarea>
                </div>
            </div>

            <div class="row">
                <div class="col">
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                        <label>Advice / Plan</label>
                        <label class="print-control"><input type="checkbox" id="chk_advice" checked> Print on Rx</label>
                    </div>
                    <div class="template-bar">
                        <select id="advice_templates" onchange="applyTemplate(this.value)">
                            <option value="">-- Select Template --</option>
                        </select>
                        <button type="button" onclick="addNewTemplate()">+ Add New</button>
                        <button type="button" onclick="deleteTemplate()" style="color:red;">Del</button>
                    </div>
                    <textarea id="advice" rows="4"></textarea>
                </div>
            </div>

            <div style="display:flex; justify-content:space-between; align-items:center; margin-top:10px; margin-bottom:5px;">
                <h4>Medicines (Rx)</h4>
                <label class="print-control"><input type="checkbox" id="chk_meds" checked> Print on Rx</label>
            </div>
            <table id="med-table" style="width:100%;">
                <thead><tr><th>Medicine</th><th>Dose</th><th>Freq</th><th>Dur</th><th></th></tr></thead>
                <tbody></tbody>
            </table>
            <button type="button" class="btn small" onclick="window.addMedRow()" style="margin-top:5px;">+ Add Med</button>

            <div class="actions" style="margin-top:20px; border-top:1px solid #eee; padding-top:15px; display:flex; gap:10px;">
                <button type="submit" class="btn" style="flex:1;">Save & Finish</button>
                <button type="button" class="btn" onclick="window.printRx()" style="background-color: #17a2b8; color: white; border:none; flex:1;">üñ®Ô∏è Print Rx</button>
            </div>
        </form>
    </section>
</div>

<datalist id="med-list">
    <option value="Moxifloxacin Eye Drop">
    <option value="Prednisolone Acetate">
    <option value="Carboxymethylcellulose (CMC)">
    <option value="Timolol Maleate">
    <option value="Nepafenac Eye Drop">
    <option value="Tropicamide + Phenylephrine">
    <option value="Atropine Ointment">
    <option value="Ciprofloxacin">
    <option value="Multivitamin Tablet">
    <option value="Paracetamol 500mg">
    <option value="Olopatadine Eye Drop">
    <option value="Brimonidine Tartrate">
    <option value="Dorzolamide">
    <option value="Latanoprost">
    <option value="Sodium Hyaluronate">
</datalist>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, doc, updateDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBne_-4FcG5DjtUDVwdd1K-XDsHjX0JOEo",
        authDomain: "msn-hospital.firebaseapp.com",
        projectId: "msn-hospital",
        storageBucket: "msn-hospital.firebasestorage.app",
        messagingSenderId: "525072218332",
        appId: "1:525072218332:web:5940ec924f59db675adc19",
        measurementId: "G-FXXZ7STWDJ"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    window.db = db; 
    window.doc = doc; 
    window.updateDoc = updateDoc;

    let db_visits = [];
    let currentVisit = null;
    let loggedInDoctor = "";

    const doctorProfiles = {
        "Dr. Jayanta Boroowa": { qual: "D.O.M.S", reg: "Regd. No ‚Äì 7048", desig: "Medical Director" },
        "Dr. Pratibha Chauhan Paul": { qual: "M.B.B.S., D.O.M.S.", reg: "Regd. No. AMC 25792", desig: "Fellow in Comprehensive Ophthalmology, Oculoplasty & Orbit<br>Trained in SICS & PHACO Surgery" },
        "Dr. Nilutpal Borah": { qual: "MS", reg: "Regd. No. 10139", desig: "Specialist Medical Retina & Diabetic Eye Diseases" },
        "Dr. Nilakshi Baruah": { qual: "M.B.B.S., M.S., F.M.R.F", reg: "Regd. No. 17425", desig: "Fellow of Cornea, Anterior Segment & Refractive Surgery" },
        "Dr. Sanjay Kr Buragohain": { qual: "MS, DNB", reg: "Regd. No. 11863", desig: "Specialist Neuro‚ÄìOphthalmology & Glaucoma" }
    };

    window.onload = function() {
        loggedInDoctor = localStorage.getItem('loggedInDoctor');
        if(!loggedInDoctor) { alert("Please login first."); window.location.href = 'index.html'; return; }
        document.getElementById('welcome-msg').innerText = "Logged in as: " + loggedInDoctor;
        startDoctorSync();
        loadTemplates();
    };

    window.logout = function() { localStorage.removeItem('loggedInDoctor'); window.location.href = 'index.html'; };

    // --- TEMPLATES ---
    window.loadTemplates = function() {
        const select = document.getElementById('advice_templates');
        select.innerHTML = '<option value="">-- Select Template --</option>';
        const saved = JSON.parse(localStorage.getItem('templates_' + loggedInDoctor)) || [];
        saved.forEach(t => {
            const opt = document.createElement('option'); opt.value = t.text; opt.text = t.name; select.appendChild(opt);
        });
    };
    window.applyTemplate = function(text) {
        if(!text) return;
        const box = document.getElementById('advice');
        if(!box.value.includes(text)) box.value = box.value ? box.value + "\n" + text : text;
        document.getElementById('advice_templates').value = "";
    };
    window.addNewTemplate = function() {
        const name = prompt("Template Name:"); if(!name) return;
        const text = document.getElementById('advice').value.trim(); if(!text) return;
        const saved = JSON.parse(localStorage.getItem('templates_' + loggedInDoctor)) || [];
        saved.push({name, text});
        localStorage.setItem('templates_' + loggedInDoctor, JSON.stringify(saved));
        loadTemplates();
    };
    window.deleteTemplate = function() {
        if(confirm("Delete?")) {
            const val = document.getElementById('advice_templates').value;
            let saved = JSON.parse(localStorage.getItem('templates_' + loggedInDoctor)) || [];
            saved = saved.filter(t => t.text !== val);
            localStorage.setItem('templates_' + loggedInDoctor, JSON.stringify(saved));
            loadTemplates();
        }
    };

    // --- SYNC ---
    function startDoctorSync() {
        onSnapshot(collection(db, "visits"), (snapshot) => {
            db_visits = snapshot.docs.map(doc => ({ ...doc.data(), firebaseId: doc.id }));
            renderQueue(); 
        });
    }

    function renderQueue() {
        const tbody = document.querySelector('#doc-queue tbody');
        if(!tbody) return;
        tbody.innerHTML = '';
        const todayIso = new Date().toLocaleDateString('en-CA'); 
        const queue = db_visits.filter(v => {
            const isToday = (v.isoDate && v.isoDate === todayIso) || (v.date === new Date().toLocaleDateString());
            const isWaiting = ['Waiting', 'With Doctor'].includes(v.status);
            return isToday && isWaiting && v.doctor === loggedInDoctor;
        });

        if(queue.length === 0) { tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px;">No patients found.</td></tr>'; return; }

        queue.forEach(v => {
            const tr = document.createElement('tr');
            if(v.status === 'With Doctor') tr.style.background = "#e8f0fe";
            tr.innerHTML = `<td>${v.opdId}</td><td><strong>${v.patientName}</strong><br><small>${v.age}Y/${v.gender}</small></td><td>${v.type}</td><td><button class="btn small" onclick="window.startConsult('${v.opdId}')">${v.status === 'With Doctor' ? 'Resume' : 'Consult'}</button></td>`;
            tbody.appendChild(tr);
        });
    }

    // --- START CONSULT ---
    window.startConsult = function(opdId) {
        currentVisit = db_visits.find(v => v.opdId === opdId);
        if(!currentVisit) return;

        document.getElementById('doc-queue-section').classList.add('hidden');
        document.getElementById('consult-section').classList.remove('hidden');
        document.getElementById('p-name').innerText = currentVisit.patientName;
        document.getElementById('p-info').innerText = `PID: ${currentVisit.pid}`;

        const d = currentVisit.optoData || {};
        const safe = (obj, path) => path.split('.').reduce((acc, part) => acc && acc[part], obj) || '-';

        document.getElementById('opto-content').innerHTML = `
            <div class="opto-section">
                <h5>Clinical History</h5>
                <div class="opto-data-row"><span><strong>CO:</strong> ${safe(d, 'history.complaint')}</span></div>
                <div class="opto-data-row"><span><strong>Ocular Hx:</strong> ${safe(d, 'history.ocular_hx')}</span></div>
                <div class="opto-data-row"><span><strong>Systemic:</strong> ${safe(d, 'history.systemic')}</span></div>
                <div class="opto-data-row"><span><strong>Allergies:</strong> ${safe(d, 'history.allergies')}</span></div>
            </div>

            <div class="opto-section">
                <h5>Previous Glasses (PGP)</h5>
                <div class="opto-data-row"><span>OD: ${safe(d, 'pgp.od.sph')}/${safe(d, 'pgp.od.cyl')} x${safe(d, 'pgp.od.ax')} Add ${safe(d, 'pgp.od.add')}</span></div>
                <div class="opto-data-row"><span>OS: ${safe(d, 'pgp.os.sph')}/${safe(d, 'pgp.os.cyl')} x${safe(d, 'pgp.os.ax')} Add ${safe(d, 'pgp.os.add')}</span></div>
            </div>
            
            <div class="opto-section">
                <h5>Visual Acuity & Refraction</h5>
                <div class="opto-data-row"><span><strong>Unaided:</strong> OD ${safe(d, 'va.od.dist')} | OS ${safe(d, 'va.os.dist')}</span></div>
                <div class="opto-data-row"><span><strong>Pin Hole:</strong> OD ${safe(d, 'va.od.ph')} | OS ${safe(d, 'va.os.ph')}</span></div>
                <div style="font-weight:bold; color:#0056b3; margin-top:5px;">Refraction (Final)</div>
                <div class="opto-data-row"><span>OD: ${safe(d, 'refraction.od.sph')}/${safe(d, 'refraction.od.cyl')} x ${safe(d, 'refraction.od.ax')} (${safe(d, 'refraction.od.va')})</span></div>
                <div class="opto-data-row"><span>OS: ${safe(d, 'refraction.os.sph')}/${safe(d, 'refraction.os.cyl')} x ${safe(d, 'refraction.os.ax')} (${safe(d, 'refraction.os.va')})</span></div>
            </div>

            <div class="opto-section">
                <h5>External Exam</h5>
                <div class="opto-data-row"><span><strong>Ext:</strong> ${safe(d, 'external.od.ext')} | ${safe(d, 'external.os.ext')}</span></div>
                <div class="opto-data-row"><span><strong>EOM:</strong> ${safe(d, 'external.od.eom')} | ${safe(d, 'external.os.eom')}</span></div>
                <div class="opto-data-row"><span><strong>Cover (Dist):</strong> ${safe(d, 'external.od.ct_dist')} | ${safe(d, 'external.os.ct_dist')}</span></div>
                <div class="opto-data-row"><span><strong>Cover (Near):</strong> ${safe(d, 'external.od.ct_near')} | ${safe(d, 'external.os.ct_near')}</span></div>
            </div>

            <div class="opto-section" style="grid-column: span 2; border-top:1px dashed #ccc; padding-top:5px;">
                <h5>Slit Lamp Examination</h5>
                <div class="sl-grid">
                    <div><strong>Structure</strong></div><div><strong>OD (Right)</strong></div><div><strong>OS (Left)</strong></div>
                    <div>Lids</div><div>${safe(d, 'slitlamp.od.lids')}</div><div>${safe(d, 'slitlamp.os.lids')}</div>
                    <div>Conjunctiva</div><div>${safe(d, 'slitlamp.od.conj')}</div><div>${safe(d, 'slitlamp.os.conj')}</div>
                    <div>Cornea</div><div>${safe(d, 'slitlamp.od.corn')}</div><div>${safe(d, 'slitlamp.os.corn')}</div>
                    <div>A.C.</div><div>${safe(d, 'slitlamp.od.ac')}</div><div>${safe(d, 'slitlamp.os.ac')}</div>
                    <div>Pupil</div><div>${safe(d, 'slitlamp.od.pupil')}</div><div>${safe(d, 'slitlamp.os.pupil')}</div>
                </div>

                <div class="opto-data-row" style="margin-top:10px;">
                    <span><strong>IOP:</strong> OD: ${safe(d, 'slitlamp.iop_od')} / OS: ${safe(d, 'slitlamp.iop_os')} mmHg</span>
                    <span><strong>Lens:</strong> OD: ${safe(d, 'slitlamp.lens_od')} / OS: ${safe(d, 'slitlamp.lens_os')}</span>
                </div>
                <div style="margin-top:5px; color:#d63384;"><strong>Note:</strong> ${safe(d, 'slitlamp.remarks')}</div>
                <div style="margin-top:2px;"><strong>Dilation:</strong> ${safe(d, 'plan.dilation')}</div>
            </div>
        `;
        document.getElementById('opto-details').open = true;
        document.getElementById('diagnosis').value = "";
        document.getElementById('advice').value = "";
        document.querySelector('#med-table tbody').innerHTML = "";
        window.addMedRow();
    };

    window.cancelConsult = function() {
        document.getElementById('consult-section').classList.add('hidden');
        document.getElementById('doc-queue-section').classList.remove('hidden');
        currentVisit = null;
    };

    window.addMedRow = function() {
        const tbody = document.querySelector('#med-table tbody');
        const tr = document.createElement('tr');
        // UPDATED: Added list="med-list"
        tr.innerHTML = `<td><input class="med-name" list="med-list" placeholder="Start typing..."></td><td><input class="med-dose" placeholder="Dose"></td><td><select class="med-freq"><option>1-0-1</option><option>1-1-1</option><option>1-0-0</option><option>0-0-1</option><option>SOS</option></select></td><td><input class="med-dur" placeholder="Days"></td><td><button type="button" onclick="this.closest('tr').remove()" style="color:red;border:none;background:none;">X</button></td>`;
        tbody.appendChild(tr);
    };

    window.saveConsult = async function() {
        if(!currentVisit) return;
        const meds = [];
        document.querySelectorAll('#med-table tbody tr').forEach(tr => {
            const name = tr.querySelector('.med-name').value;
            if(name) meds.push({ name, dose: tr.querySelector('.med-dose').value, freq: tr.querySelector('.med-freq').value, duration: tr.querySelector('.med-dur').value });
        });

        try {
            const btn = document.querySelector('button[type="submit"]'); btn.innerText = "Saving...";
            await updateDoc(doc(db, "visits", currentVisit.firebaseId), {
                doctorData: { diagnosis: document.getElementById('diagnosis').value, advice: document.getElementById('advice').value, meds },
                status: "Completed"
            });
            alert("Saved!"); window.cancelConsult(); btn.innerText = "Save & Finish";
        } catch(e) { alert("Error: " + e.message); }
    };

    window.printRx = function() {
        if(!currentVisit) return;
        const dr = doctorProfiles[loggedInDoctor] || { qual: "", reg: "", desig: "" };
        
        const diag = document.getElementById('diagnosis').value || '-';
        const adv = document.getElementById('advice').value || '-';
        const showDiag = document.getElementById('chk_diagnosis').checked;
        const showAdv = document.getElementById('chk_advice').checked;
        const showMeds = document.getElementById('chk_meds').checked;
        
        let medRows = "";
        if(showMeds) {
            document.querySelectorAll('#med-table tbody tr').forEach(tr => {
                const name = tr.querySelector('.med-name').value;
                if(name) medRows += `<tr><td>${name}</td><td>${tr.querySelector('.med-dose').value}</td><td>${tr.querySelector('.med-freq').value}</td><td>${tr.querySelector('.med-dur').value}</td></tr>`;
            });
        }

        const win = window.open('', '', 'width=800,height=600');
        const content = `<html><head><title>Rx</title><base href="${window.location.href}">
        <style>body{font-family:'Segoe UI',sans-serif;padding:40px;color:#333;} 
        .header-grid{display:grid;grid-template-columns:100px 1fr;gap:20px;align-items:center;border-bottom:3px solid #004085;padding-bottom:15px;margin-bottom:20px;}
        .header-text{text-align:center;} .header-text h2{margin:0;color:#004085;font-size:24px;text-transform:uppercase;} .header-text p{margin:2px 0;font-size:14px;}
        .meta{display:flex;justify-content:space-between;margin-bottom:20px;border-bottom:1px solid #ccc;padding-bottom:10px;align-items:flex-start;}
        .section h4{margin:0 0 8px 0;color:#004085;text-transform:uppercase;font-size:0.9em;border-bottom:1px solid #eee;padding-bottom:3px;display:inline-block;}
        .content{font-size:1.1em;line-height:1.5;margin-bottom:20px;}
        table{width:100%;border-collapse:collapse;} th,td{border-bottom:1px solid #ddd;padding:8px;text-align:left;} th{background-color:#f8f9fa;}
        .footer{margin-top:60px;display:flex;justify-content:space-between;align-items:flex-end;}
        </style></head>
        <body onload="setTimeout(function(){window.print()}, 800)">
            <div class="header-grid">
                <img src="logo.png" style="width:100px;height:auto;">
                <div class="header-text">
                    <h2>MSN Cataract and IOL Hospital</h2>
                    <p><em>(A unit of Kantashree Community Care, A Registered Society)</em></p>
                    <p>Tilak Deka Road, Nagaon, Assam, Pin ‚Äì 782001</p>
                    <p>Mobile : 8486887503 | Govt. Licence No. ‚Äì SHA/205</p>
                </div>
            </div>
            <div class="meta">
                <div style="flex:1;"><strong>Name:</strong> ${currentVisit.patientName}<br><strong>PID:</strong> ${currentVisit.pid} &nbsp;|&nbsp; <strong>Age/Sex:</strong> ${currentVisit.age}Y/${currentVisit.gender}<br><strong>Date:</strong> ${new Date().toLocaleDateString()}</div>
                <div style="flex:1;text-align:right;"><strong style="font-size:1.1em;color:#004085;">${loggedInDoctor}</strong><br><span style="font-size:0.9em;color:#555;">${dr.qual}</span><br><span style="font-size:0.9em;color:#555;">${dr.reg}</span><br><span style="font-size:0.85em;font-weight:bold;">${dr.desig}</span></div>
            </div>
            ${showDiag ? `<div class="section"><h4>Diagnosis</h4><div class="content">${diag.replace(/\n/g, '<br>')}</div></div>` : ''}
            ${showAdv ? `<div class="section"><h4>Advice / Plan</h4><div class="content">${adv.replace(/\n/g, '<br>')}</div></div>` : ''}
            ${showMeds && medRows ? `<div class="section"><h4>Medicines (Rx)</h4><table><thead><tr><th>Medicine</th><th>Dose</th><th>Freq</th><th>Duration</th></tr></thead><tbody>${medRows}</tbody></table></div>` : ''}
            <div class="footer"><div style="font-size:0.8em;color:#777;">A Day Eye Care Institution</div><div style="text-align:center;">______________________<br><strong>Signature</strong></div></div>
        </body></html>`;
        win.document.write(content); win.document.close();
    };
</script>
</body>
</html>