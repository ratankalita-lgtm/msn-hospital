<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doctor Console - MSN Hospital</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .hidden { display: none; }
        .row { display: flex; gap: 15px; margin-bottom: 10px; }
        .col { flex: 1; display: flex; flex-direction: column; }
        textarea, input, select { width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px; font-size: 0.95em; box-sizing: border-box; }
        label { font-weight: 600; color: #495057; margin-bottom: 5px; font-size: 0.85em; text-transform: uppercase; }
        .section-box { background: #fff; border: 1px solid #e9ecef; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .section-header { font-size: 1.1em; font-weight: 700; color: #007bff; border-bottom: 2px solid #f0f4f8; padding-bottom: 10px; margin-bottom: 15px; }
        .compact-grid { display: grid; grid-template-columns: 80px 1fr 1fr; gap: 8px; align-items: center; margin-bottom: 5px; }
        .pgp-grid { display: grid; grid-template-columns: 50px 1fr 1fr 1fr 1fr; gap: 5px; align-items: center; margin-bottom: 5px; }
        .small-input { padding: 6px; font-size: 0.9em; text-align: center; }
        .print-control { display: flex; align-items: center; gap: 5px; font-size: 0.85em; color: #666; margin-left: auto; text-transform: none; cursor: pointer; }
        .status-investigation { background: #fff3cd; color: #856404; padding: 2px 8px; border-radius: 12px; font-size:0.8em; font-weight: bold; }
        .status-ready { background: #d4edda; color: #155724; padding: 2px 8px; border-radius: 12px; font-size:0.8em; font-weight: bold; }
        .dilation-badge { background: #e0cffc; color: #5e35b1; padding: 4px 10px; border-radius: 12px; font-size:0.8em; font-weight: bold; margin-left: 10px; border: 1px solid #b39ddb; }
        .warning-box { background: #fff3cd; color: #856404; padding: 10px; border: 1px solid #ffeeba; border-radius: 6px; margin-bottom: 15px; font-weight: bold; display: flex; align-items: center; gap: 10px; }
        table { width: 100%; border-collapse: separate; border-spacing: 0; }
        th { background: #f8f9fa; color: #495057; padding: 12px; text-align: left; font-weight: 600; border-bottom: 2px solid #dee2e6; }
        td { padding: 12px; border-bottom: 1px solid #dee2e6; vertical-align: middle; }
        tr:hover { background-color: #f8f9fa; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fff; margin: 5% auto; padding: 20px; border-radius: 8px; width: 500px; max-width: 90%; }
        .modal-header { font-size: 1.2em; font-weight: bold; margin-bottom: 15px; display: flex; justify-content: space-between; }
        .close-modal { cursor: pointer; color: #aaa; font-size: 1.5em; }
        .od-input { border: 1px solid #ff9999; background-color: #fff5f5; color: #d60000; }
        .os-input { border: 1px solid #99ccff; background-color: #f0f8ff; color: #004085; }
        /* TOAST NOTIFICATIONS */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; }
        .toast { background: #333; color: white; padding: 12px 20px; border-radius: 4px; margin-bottom: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); animation: slideIn 0.3s ease-out; display: flex; align-items: center; gap: 10px; }
        .toast.success { background: #28a745; }
        .toast.error { background: #dc3545; }
        .toast.warning { background: #ffc107; color: #333; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        /* AUTO-SAVE INDICATOR */
        #autosave-status { position: fixed; bottom: 20px; right: 20px; background: rgba(0,0,0,0.7); color: white; padding: 5px 10px; border-radius: 4px; font-size: 0.8em; display: none; }
        /* DARK MODE */
        @media (prefers-color-scheme: dark) {
            body { background: #121212; color: #e0e0e0; }
            .container { background: #1e1e1e; }
            .card, .section-box, .modal-content { background: #1e1e1e; border-color: #333; }
            input, select, textarea { background: #2a2a2a; color: #fff; border-color: #444; }
            th { background: #2a2a2a; color: #ccc; }
            tr:hover { background-color: #333; }
            .od-input { background: #2a1a1a; border-color: #ff6666; color: #ff9999; }
            .os-input { background: #1a2a2a; border-color: #6699ff; color: #99ccff; }
        }
    </style>
</head>
<body>
<div id="toast-container"></div>
<div id="autosave-status">üíæ Saving...</div>
<div class="container">
    <header class="hospital-header">
        <img src="logo.png" alt="Logo" class="hospital-logo" onerror="this.style.display='none'">
        <div><h2>Doctor Console</h2><p class="text-muted" id="welcome-msg">Welcome</p></div>
        <button class="btn ghost small" onclick="logout()" style="margin-left:auto;">Change Doctor</button>
    </header>

    <section id="doc-queue-section" class="card">
        <div style="display:flex; justify-content:space-between; align-items:center;"><h3>My Patients Queue</h3><div id="connection-status" style="font-size:0.8em; color:orange;">‚óè Connecting...</div></div>
        <table id="doc-queue" style="margin-top:10px;"><thead><tr><th style="width:50px;">OPD</th><th style="width:90px;">PID</th><th>Name</th><th style="width:80px;">Age/Sex</th><th>Address</th><th style="width:100px;">Status</th><th style="width:80px;">Action</th></tr></thead><tbody><tr><td colspan="7" style="text-align:center; padding:20px;">Initializing Database...</td></tr></tbody></table>
    </section>

    <section id="consult-section" class="hidden">
        <div style="background: white; padding: 15px 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; border-left: 5px solid #007bff;">
            <div style="display:flex; align-items:center;"><div><h2 id="p-name" style="margin:0; color:#333; font-size: 1.5em;">-</h2><small id="p-info" style="color:#777; font-size: 0.95em;">PID: -</small></div><span id="dilation-alert" class="dilation-badge hidden">üíß Dilated</span></div>
            <button class="btn ghost" onclick="cancelConsult()">Back to List (Esc)</button>
        </div>
        <div id="age-warning-box" class="warning-box hidden"></div>
        <div id="investigation-result-box" class="hidden" style="background:#d4edda; color:#155724; padding:15px; border:1px solid #c3e6cb; border-radius:8px; margin-bottom:20px;"><strong>üß™ Investigation Report Available:</strong><p id="inv-report-text" style="margin:5px 0 0 0; white-space: pre-wrap; font-weight:bold;"></p></div>
        <form onsubmit="event.preventDefault(); window.printRx();">
            <div class="section-box"><div class="section-header">1. History & Background (Editable)</div><div class="row"><div class="col"><label>Chief Complaint</label><textarea id="ed_cc" rows="2"></textarea></div><div class="col"><label>Ocular History</label><textarea id="ed_oh" rows="2"></textarea></div></div><div class="row"><div class="col"><label>Systemic Diseases / Allergies</label><input id="ed_sys" type="text"></div></div><div style="margin-top: 15px;"><label style="color:#007bff;">Previous Glasses (PGP)</label><div class="pgp-grid" style="background: #f8f9fa; padding: 5px; font-weight: bold; font-size: 0.8em; text-align: center; border-radius:4px;"><div>Eye</div><div>Sph</div><div>Cyl</div><div>Axis</div><div>Add</div></div><div class="pgp-grid"><div style="font-weight:bold; text-align:center; color:#d60000;">OD</div><input id="ed_pgp_sph_od" class="small-input od-input"><input id="ed_pgp_cyl_od" class="small-input od-input"><input id="ed_pgp_ax_od" class="small-input od-input"><input id="ed_pgp_add_od" class="small-input od-input"></div><div class="pgp-grid"><div style="font-weight:bold; text-align:center; color:#004085;">OS</div><input id="ed_pgp_sph_os" class="small-input os-input"><input id="ed_pgp_cyl_os" class="small-input os-input"><input id="ed_pgp_ax_os" class="small-input os-input"><input id="ed_pgp_add_os" class="small-input os-input"></div></div><div style="margin-top: 15px;"><label style="color:#007bff;">External Exam</label><div class="row" style="gap: 10px;"><div class="col"><input id="ed_ext_od" class="od-input" placeholder="OD External"></div><div class="col"><input id="ed_ext_os" class="os-input" placeholder="OS External"></div></div></div></div>
            <div class="section-box"><div class="section-header">2. Clinical Findings</div><div style="display:grid; grid-template-columns: 1fr 1fr; gap:30px;"><div><h5 style="margin:0 0 10px 0; color:#555;">Visual Acuity</h5><div class="compact-grid header"><div>Test</div><div>OD</div><div>OS</div></div><div class="compact-grid"><div>Dist</div><input id="ed_va_od" class="small-input od-input"><input id="ed_va_os" class="small-input os-input"></div><div class="compact-grid"><div>Near</div><input id="ed_va_near_od" class="small-input od-input"><input id="ed_va_near_os" class="small-input os-input"></div><div class="compact-grid"><div>PH</div><input id="ed_ph_od" class="small-input od-input"><input id="ed_ph_os" class="small-input os-input"></div><div style="display:flex; justify-content:space-between; align-items:center; margin-top:20px; margin-bottom:10px;"><h5 style="margin:0; color:#555;">Refraction (Final)</h5><button type="button" class="btn small info" onclick="printGlassesSlipOnly()">üñ®Ô∏è Glasses Slip Only</button></div><div class="pgp-grid" style="background:#f1f3f5; font-weight:bold; font-size:0.8em; text-align:center;"><div>Eye</div><div>Sph</div><div>Cyl</div><div>Axis</div><div>VA</div></div><div class="pgp-grid"><div style="font-weight:bold; text-align:center; color:#d60000;">OD</div><input id="ed_rx_sph_od" class="small-input od-input"><input id="ed_rx_cyl_od" class="small-input od-input"><input id="ed_rx_ax_od" type="number" min="1" max="180" class="small-input od-input"><input id="ed_rx_va_od" class="small-input od-input"></div><div class="pgp-grid"><div style="font-weight:bold; text-align:center; color:#004085;">OS</div><input id="ed_rx_sph_os" class="small-input os-input"><input id="ed_rx_cyl_os" class="small-input os-input"><input id="ed_rx_ax_os" type="number" min="1" max="180" class="small-input os-input"><input id="ed_rx_va_os" class="small-input os-input"></div><div class="pgp-grid" style="margin-top:5px;"><div style="font-size:0.8em; font-weight:bold;">Add</div><input id="ed_rx_add_od" class="small-input od-input" placeholder="OD Add"><input id="ed_rx_add_os" class="small-input os-input" placeholder="OS Add"><div></div><div></div></div></div><div><h5 style="margin:0 0 10px 0; color:#555;">Slit Lamp Examination</h5><div class="compact-grid header"><div>Part</div><div>OD</div><div>OS</div></div><div class="compact-grid"><div>Lids</div><input id="ed_sl_lids_od" class="small-input od-input"><input id="ed_sl_lids_os" class="small-input os-input"></div><div class="compact-grid"><div>Conj</div><input id="ed_sl_conj_od" class="small-input od-input"><input id="ed_sl_conj_os" class="small-input os-input"></div><div class="compact-grid"><div>Cornea</div><input id="ed_sl_corn_od" class="small-input od-input"><input id="ed_sl_corn_os" class="small-input os-input"></div><div class="compact-grid"><div>AC</div><input id="ed_sl_ac_od" class="small-input od-input"><input id="ed_sl_ac_os" class="small-input os-input"></div><div class="compact-grid"><div>Pupil</div><input id="ed_sl_pupil_od" class="small-input od-input"><input id="ed_sl_pupil_os" class="small-input os-input"></div><div class="compact-grid"><div>Lens</div><input id="ed_sl_lens_od" class="small-input od-input"><input id="ed_sl_lens_os" class="small-input os-input"></div><div class="compact-grid" style="background:#fff3cd; padding:5px; border-radius:4px; margin-top:5px;"><div style="font-weight:bold; color:#856404;">IOP</div><input id="ed_iop_od" class="small-input od-input" style="font-weight:bold;"><input id="ed_iop_os" class="small-input os-input" style="font-weight:bold;"></div><div style="margin-top:10px;"><label style="font-size:0.9em;">Remarks</label><input id="ed_sl_remarks" class="small-input" style="text-align:left;"></div></div></div></div>
            <div class="section-box" style="border-top: 5px solid #28a745;">
                <div class="section-header">3. Diagnosis & Treatment</div>
                <div class="row"><div class="col"><div style="display:flex; justify-content:space-between; margin-bottom:5px;"><label>Diagnosis</label><label class="print-control"><input type="checkbox" id="chk_diagnosis" checked> Print</label></div><textarea id="diagnosis" rows="2"></textarea></div></div>
                <div class="row"><div class="col"><div style="display:flex; justify-content:space-between; margin-bottom:5px;"><label>Advice / Plan</label><label class="print-control"><input type="checkbox" id="chk_advice" checked> Print</label></div><div style="display:flex; gap:10px; margin-bottom:5px;"><select id="advice_templates" onchange="applyTemplate(this.value)"><option value="">-- Select Template --</option></select><button type="button" class="btn small" onclick="addNewTemplate()">Add</button><button type="button" class="btn small ghost" onclick="deleteTemplate()" style="color:red;">Del</button></div><textarea id="advice" rows="4"></textarea></div></div>
                <div style="display:flex; align-items:center; gap:20px; margin-top:20px; margin-bottom:5px; background:#f8f9fa; padding:10px; border-radius:5px;"><strong style="color:#555;">Print Options:</strong><label class="print-control"><input type="checkbox" id="chk_meds" checked> Medicines</label><label class="print-control"><input type="checkbox" id="chk_glasses" checked> üëì Spectacle Rx</label></div>
                <table id="med-table" style="width:100%; margin-bottom:10px;"><thead><tr><th style="width:110px;">Eye</th><th>Medicine</th><th>Dose</th><th>Freq</th><th>Dur</th><th style="width:30px;"></th></tr></thead><tbody></tbody></table><button type="button" class="btn small" onclick="window.addMedRow()">+ Add Medicine</button><div class="row" style="margin-top:25px; padding-top:15px; border-top:1px dashed #ccc; align-items:center;"><div class="col" style="flex:0 0 150px;"><label>Follow-up Date:</label></div><div class="col"><input type="date" id="follow_up_date" style="max-width: 200px;"></div></div>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr 1.5fr; gap:10px; margin-bottom:50px;">
                <button type="button" class="btn" onclick="window.sendToInvestigation()" style="background-color: #ffc107; color: #000; border:none; padding:15px; font-size:1.1em;">üî¨ Order Inv.</button>
                <button type="button" class="btn" onclick="openSurgeryModal()" style="background-color: #dc3545; color: white; border:none; padding:15px; font-size:1.1em;">üî™ Surgery Slip</button>
                <button type="button" class="btn" onclick="window.printRx()" style="background-color: #17a2b8; color: white; border:none; padding:15px; font-size:1.1em;">üíæ Save & üñ®Ô∏è Print Rx (Ctrl+P)</button>
            </div>
        </form>
    </section>
</div>
<div id="surgeryModal" class="modal"><div class="modal-content"><div class="modal-header"><span>Generate Admission Slip</span><span class="close-modal" onclick="closeSurgeryModal()">√ó</span></div>
    <div style="background:#f8f9fa; padding:10px; margin-bottom:15px; border-radius:4px; font-weight:bold;">Patient: <span id="surg_patient_name" style="color:#007bff;">-</span></div>
    <div class="row"><div class="col"><label>Eye</label><select id="surg_eye"><option>Right Eye (OD)</option><option>Left Eye (OS)</option></select></div><div class="col"><label>Admission Date</label><input type="date" id="surg_date"></div></div><div class="row"><div class="col"><label>Procedure</label><input id="surg_proc" value="Phacoemulsification + IOL Implantation"></div></div><div class="row"><div class="col"><label>IOL Power</label><input id="surg_power" placeholder="+21.0 D"></div><div class="col"><label>IOL Model</label><input id="surg_model" placeholder="Alcon AcrySof / Indian"></div></div><div class="row"><div class="col"><label>Pre-op Instructions</label><textarea id="surg_notes" rows="2">Start Moxifloxacin Eye Drops 4 times/day 1 day prior to surgery.</textarea></div></div><button class="btn" onclick="printAdmissionSlip()" style="width:100%; margin-top:10px;">Print Admission Slip</button></div></div>
<datalist id="med-list"><option value="Moxifloxacin Eye Drop"></option><option value="Prednisolone Acetate"></option><option value="Carboxymethylcellulose (CMC)"></option><option value="Timolol Maleate"></option><option value="Nepafenac Eye Drop"></option><option value="Tropicamide + Phenylephrine"></option><option value="Atropine Ointment"></option><option value="Ciprofloxacin"></option><option value="Multivitamin Tablet"></option><option value="Paracetamol 500mg"></option><option value="Olopatadine Eye Drop"></option><option value="Brimonidine Tartrate"></option><option value="Dorzolamide"></option><option value="Latanoprost"></option><option value="Sodium Hyaluronate"></option></datalist>
<datalist id="freq-list"><option value="1-0-1"></option><option value="1-1-1"></option><option value="1-0-0"></option><option value="0-0-1"></option><option value="0-1-0"></option><option value="SOS"></option><option value="HS (Bedtime)"></option><option value="Once a week"></option><option value="4 Times/Day"></option><option value="6 Times/Day"></option><option value="Every 2 Hours"></option></datalist>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, doc, updateDoc, onSnapshot, addDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    const firebaseConfig = { apiKey: "AIzaSyBne_-4FcG5DjtUDVwdd1K-XDsHjX0JOEo", authDomain: "msn-hospital.firebaseapp.com", projectId: "msn-hospital", storageBucket: "msn-hospital.firebasestorage.app", messagingSenderId: "525072218332", appId: "1:525072218332:web:5940ec924f59db675adc19", measurementId: "G-FXXZ7STWDJ" };
    const app = initializeApp(firebaseConfig); const db = getFirestore(app);
    window.db = db; window.doc = doc; window.updateDoc = updateDoc;
    let db_visits = []; let currentVisit = null; let loggedInDoctor = "";
    let pendingSaves = []; let isSaving = false;
    const doctorProfiles = { "Dr. Jayanta Boroowa": { qual: "D.O.M.S", reg: "Regd. No ‚Äì 7048", desig: "Medical Director" }, "Dr. Pratibha Chauhan Paul": { qual: "M.B.B.S., D.O.M.S.", reg: "Regd. No. AMC 25792", desig: "Fellow in Comprehensive Ophthalmology, Oculoplasty & Orbit" }, "Dr. Nilutpal Borah": { qual: "MS", reg: "Regd. No. 10139", desig: "Specialist Medical Retina & Diabetic Eye Diseases" }, "Dr. Nilakshi Baruah": { qual: "M.B.B.S., M.S., F.M.R.F", reg: "Regd. No. 17425", desig: "Fellow of Cornea, Anterior Segment & Refractive Surgery" }, "Dr. Sanjay Kr Buragohain": { qual: "MS, DNB", reg: "Regd. No. 11863", desig: "Specialist Neuro‚ÄìOphthalmology & Glaucoma" } };
    
    // --- UTILS ---
    const dict = { "1-0-1": "‡ßß-‡ß¶-‡ßß (‡ß∞‡¶æ‡¶§‡¶ø‡¶™‡ßÅ‡ß±‡¶æ ‡¶Ü‡ß∞‡ßÅ ‡ß∞‡¶æ‡¶§‡¶ø)", "1-1-1": "‡ßß-‡ßß-‡ßß (‡¶§‡¶ø‡¶®‡¶ø‡¶ì ‡¶∏‡¶æ‡¶ú)", "1-0-0": "‡ßß-‡ß¶-‡ß¶ (‡ß∞‡¶æ‡¶§‡¶ø‡¶™‡ßÅ‡ß±‡¶æ)", "0-0-1": "‡ß¶-‡ß¶-‡ßß (‡ß∞‡¶æ‡¶§‡¶ø)", "0-1-0": "‡ß¶-‡ßß-‡ß¶ (‡¶¶‡ßÅ‡¶™‡ß∞‡ßÄ‡ßü‡¶æ)", "SOS": "‡¶™‡ßç‡ß∞‡ßü‡ßã‡¶ú‡¶® ‡¶∏‡¶æ‡¶™‡ßá‡¶ï‡ßç‡¶∑‡ßá", "HS (Bedtime)": "‡ß∞‡¶æ‡¶§‡¶ø ‡¶∂‡ßã‡ß±‡¶æ‡ß∞ ‡¶∏‡¶Æ‡ßü‡¶§", "4 Times/Day": "‡¶¶‡¶ø‡¶®‡¶§ ‡ß™ ‡¶¨‡¶æ‡ß∞", "6 Times/Day": "‡¶¶‡¶ø‡¶®‡¶§ ‡ß¨ ‡¶¨‡¶æ‡ß∞", "Every 2 Hours": "‡¶™‡ßç‡ß∞‡¶§‡¶ø ‡ß® ‡¶ò‡¶®‡ßç‡¶ü‡¶æ‡ß∞ ‡¶Æ‡ßÇ‡ß∞‡ßá ‡¶Æ‡ßÇ‡ß∞‡ßá", "Once a week": "‡¶∏‡¶™‡ßç‡¶§‡¶æ‡¶π‡¶§ ‡ßß ‡¶¨‡¶æ‡ß∞", "Continue": "‡¶ö‡¶≤‡¶æ‡¶á ‡¶•‡¶æ‡¶ï‡¶ø‡¶¨", "Stop": "‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡ß∞‡¶ø‡¶¨", "Right Eye": "‡¶∏‡ßã‡¶Å ‡¶ö‡¶ï‡ßÅ", "Left Eye": "‡¶¨‡¶æ‡¶ì‡¶Å ‡¶ö‡¶ï‡ßÅ", "Both Eyes": "‡¶¶‡ßÅ‡ßü‡ßã ‡¶ö‡¶ï‡ßÅ" };
    function translate(text) { if(!text) return ""; if(dict[text]) return dict[text]; let out = text.toString(); const nums = {'0':'‡ß¶','1':'‡ßß','2':'‡ß®','3':'‡ß©','4':'‡ß™','5':'‡ß´','6':'‡ß¨','7':'‡ß≠','8':'‡ßÆ','9':'‡ßØ'}; out = out.replace(/[0-9]/g, c => nums[c]); return out.replace(/Days/i,"‡¶¶‡¶ø‡¶®").replace(/Weeks/i,"‡¶∏‡¶™‡ßç‡¶§‡¶æ‡¶π").replace(/Months/i,"‡¶Æ‡¶æ‡¶π"); }
    window.formatDate = function(dateString) { if(!dateString) return ""; const d = new Date(dateString); if(isNaN(d.getTime())) return dateString; return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`; }
    function getTodayISO() { const d = new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
    function checkAgeWarnings(age) { const box = document.getElementById('age-warning-box'); box.classList.add('hidden'); box.innerText = ""; if(!age) return; const numAge = parseInt(age); if(isNaN(numAge)) return; if(numAge < 12) { box.innerText = "‚ö† Paediatric patient (Below 12 years)"; box.classList.remove('hidden'); } else if(numAge >= 60) { box.innerText = "‚ö† Senior citizen patient (60 years or above)"; box.classList.remove('hidden'); } }

    document.addEventListener('keydown', (e) => { if(!currentVisit) return; if(e.ctrlKey && e.key === 's') { e.preventDefault(); performSave(); showToast("Saved (Shortcut)", 'success'); } if(e.ctrlKey && e.key === 'p') { e.preventDefault(); window.printRx(); } if(e.key === 'Escape') { e.preventDefault(); cancelConsult(); } });
    window.addEventListener('online', () => { showToast("üü¢ Online: Syncing Data...", 'success'); syncPendingSaves(); });
    window.addEventListener('offline', () => { showToast("üî¥ Offline Mode: Changes queued", 'warning'); });
    async function syncPendingSaves() { while(pendingSaves.length > 0) { const save = pendingSaves.shift(); try { await updateDoc(doc(db, "visits", save.id), save.data); console.log("Synced pending save"); } catch(e) { pendingSaves.unshift(save); break; } } }
    window.showToast = function(msg, type='info') { const toast = document.createElement('div'); toast.className = `toast ${type}`; toast.innerText = msg; document.getElementById('toast-container').appendChild(toast); setTimeout(() => toast.remove(), 3000); }

    window.onload = function() { loggedInDoctor = localStorage.getItem('loggedInDoctor'); if(!loggedInDoctor) { alert("Please login first."); window.location.href = 'index.html'; return; } document.getElementById('welcome-msg').innerText = "Logged in as: " + loggedInDoctor; try { startDoctorSync(); loadTemplates(); } catch(e) { console.error(e); } setInterval(() => { if(currentVisit) performSave(true); }, 30000); };
    window.logout = function() { localStorage.removeItem('loggedInDoctor'); window.location.href = 'index.html'; };
    window.loadTemplates = function() { const select = document.getElementById('advice_templates'); select.innerHTML = '<option value="">-- Select Template --</option>'; try { const saved = JSON.parse(localStorage.getItem('templates_' + loggedInDoctor)) || []; saved.forEach(t => { const opt = document.createElement('option'); opt.value = t.text; opt.text = t.name; select.appendChild(opt); }); } catch(e) { } };
    window.applyTemplate = function(text) { if(!text) return; const box = document.getElementById('advice'); if(!box.value.includes(text)) box.value = box.value ? box.value + "\n" + text : text; document.getElementById('advice_templates').value = ""; };
    window.addNewTemplate = function() { const name = prompt("Template Name:"); if(!name) return; const text = document.getElementById('advice').value.trim(); if(!text) return; const saved = JSON.parse(localStorage.getItem('templates_' + loggedInDoctor)) || []; saved.push({name, text}); localStorage.setItem('templates_' + loggedInDoctor, JSON.stringify(saved)); loadTemplates(); };
    window.deleteTemplate = function() { if(confirm("Delete?")) { const val = document.getElementById('advice_templates').value; let saved = JSON.parse(localStorage.getItem('templates_' + loggedInDoctor)) || []; saved = saved.filter(t => t.text !== val); localStorage.setItem('templates_' + loggedInDoctor, JSON.stringify(saved)); loadTemplates(); } };

    function startDoctorSync() { 
        const statusDiv = document.getElementById('connection-status'); statusDiv.innerText = "‚óè Connecting..."; statusDiv.style.color = "orange";
        onSnapshot(collection(db, "visits"), (snapshot) => { db_visits = snapshot.docs.map(doc => ({ ...doc.data(), firebaseId: doc.id })); statusDiv.innerText = "‚óè Live Sync Active"; statusDiv.style.color = "green"; renderQueue(); }, (error) => { console.error(error); statusDiv.innerText = "‚óè Connection Error"; statusDiv.style.color = "red"; document.querySelector('#doc-queue tbody').innerHTML = `<tr><td colspan="5" style="color:red; text-align:center; padding:20px;">Connection Error. Check Internet.</td></tr>`; }); 
    }
    function renderQueue() {
        const tbody = document.querySelector('#doc-queue tbody'); if(!tbody) return; tbody.innerHTML = '';
        const todayIso = getTodayISO(); 
        const queue = db_visits.filter(v => { 
            if(!v) return false;
            let isToday = (v.isoDate && v.isoDate === todayIso);
            if(!v.isoDate && v.date) isToday = (v.date === new Date().toLocaleDateString()); 
            const isValidStatus = ['Waiting', 'With Doctor', 'Report Ready', 'Investigation'].includes(v.status);
            return isToday && isValidStatus && v.doctor === loggedInDoctor; 
        });
        if(queue.length === 0) { tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:20px;">No patients found today.</td></tr>'; return; }
        queue.sort((a,b) => (a.timestamp || 0) - (b.timestamp || 0));
        queue.forEach(v => {
            const tr = document.createElement('tr');
            let statusBadge = v.status; if(v.status === 'Report Ready') statusBadge = `<span class="status-ready">Report Ready</span>`; if(v.status === 'Investigation') statusBadge = `<span class="status-investigation">Investigation</span>`; if(v.status === 'With Doctor') tr.style.background = "#e8f0fe";
            tr.innerHTML = `<td>${v.opdId}</td><td>${v.pid}</td><td><strong>${v.patientName}</strong></td><td>${v.age}Y</td><td>${v.address || '-'}</td><td>${statusBadge}</td><td><button class="btn small" onclick="window.startConsult('${v.firebaseId}')">${v.status === 'With Doctor' ? 'Resume' : 'Consult'}</button></td>`;
            tbody.appendChild(tr);
        });
    }

    window.startConsult = function(firebaseId) {
        currentVisit = db_visits.find(v => v.firebaseId === firebaseId); 
        if(!currentVisit) { showToast("Error: Patient not found", "error"); return; }
        document.getElementById('doc-queue-section').classList.add('hidden'); document.getElementById('consult-section').classList.remove('hidden');
        document.getElementById('p-name').innerText = currentVisit.patientName; document.getElementById('p-info').innerText = `PID: ${currentVisit.pid}`;
        checkAgeWarnings(currentVisit.age);
        const tmrw = new Date(); tmrw.setDate(tmrw.getDate() + 1); document.getElementById('follow_up_date').min = tmrw.toISOString().split('T')[0];
        document.getElementById('inv-report-text').innerText = ""; 
        const invBox = document.getElementById('investigation-result-box'); if(currentVisit.investigationReport) { invBox.classList.remove('hidden'); document.getElementById('inv-report-text').innerText = currentVisit.investigationReport; } else { invBox.classList.add('hidden'); }
        const d = currentVisit.optoData || {}; const safe = (obj, path) => path.split('.').reduce((acc, part) => acc && acc[part], obj) || '';
        const set = (id, val) => { if(document.getElementById(id)) document.getElementById(id).value = val; };
        const dilationStatus = safe(d, 'plan.dilation');
        if(dilationStatus === 'Dilate') { document.getElementById('dilation-alert').classList.remove('hidden'); } else { document.getElementById('dilation-alert').classList.add('hidden'); }
        set('ed_cc', safe(d, 'history.complaint')); set('ed_oh', safe(d, 'history.ocular_hx'));
        let sys = safe(d, 'history.systemic'); if(safe(d, 'history.allergies')) sys += " / " + safe(d, 'history.allergies'); set('ed_sys', sys);
        set('ed_pgp_sph_od', safe(d, 'pgp.od.sph')); set('ed_pgp_cyl_od', safe(d, 'pgp.od.cyl')); set('ed_pgp_ax_od', safe(d, 'pgp.od.ax')); set('ed_pgp_add_od', safe(d, 'pgp.od.add')); set('ed_pgp_sph_os', safe(d, 'pgp.os.sph')); set('ed_pgp_cyl_os', safe(d, 'pgp.os.cyl')); set('ed_pgp_ax_os', safe(d, 'pgp.os.ax')); set('ed_pgp_add_os', safe(d, 'pgp.os.add')); 
        let ext_od = safe(d, 'external.od.ext'); if(safe(d, 'external.od.eom')) ext_od += " | EOM: " + safe(d, 'external.od.eom'); if(safe(d, 'external.od.ct_dist')) ext_od += " | CT: " + safe(d, 'external.od.ct_dist'); set('ed_ext_od', ext_od);
        let ext_os = safe(d, 'external.os.ext'); if(safe(d, 'external.os.eom')) ext_os += " | EOM: " + safe(d, 'external.os.eom'); if(safe(d, 'external.os.ct_dist')) ext_os += " | CT: " + safe(d, 'external.os.ct_dist'); set('ed_ext_os', ext_os);
        let va_od = safe(d, 'va.od.dist'); if(safe(d, 'va.od.rx')) va_od += " (w/Rx: " + safe(d, 'va.od.rx') + ")"; set('ed_va_od', va_od);
        let va_os = safe(d, 'va.os.dist'); if(safe(d, 'va.os.rx')) va_os += " (w/Rx: " + safe(d, 'va.os.rx') + ")"; set('ed_va_os', va_os);
        set('ed_ph_od', safe(d, 'va.od.ph')); set('ed_ph_os', safe(d, 'va.os.ph')); set('ed_va_near_od', safe(d, 'va.od.near')); set('ed_va_near_os', safe(d, 'va.os.near'));
        set('ed_rx_sph_od', safe(d, 'refraction.od.sph')); set('ed_rx_cyl_od', safe(d, 'refraction.od.cyl')); set('ed_rx_ax_od', safe(d, 'refraction.od.ax')); set('ed_rx_add_od', safe(d, 'refraction.od.add')); set('ed_rx_va_od', safe(d, 'refraction.od.va')); set('ed_rx_sph_os', safe(d, 'refraction.os.sph')); set('ed_rx_cyl_os', safe(d, 'refraction.os.cyl')); set('ed_rx_ax_os', safe(d, 'refraction.os.ax')); set('ed_rx_add_os', safe(d, 'refraction.os.add')); set('ed_rx_va_os', safe(d, 'refraction.os.va'));
        set('ed_sl_lids_od', safe(d, 'slitlamp.od.lids')); set('ed_sl_conj_od', safe(d, 'slitlamp.od.conj')); set('ed_sl_corn_od', safe(d, 'slitlamp.od.corn')); set('ed_sl_ac_od', safe(d, 'slitlamp.od.ac')); set('ed_sl_pupil_od', safe(d, 'slitlamp.od.pupil')); set('ed_sl_lens_od', safe(d, 'slitlamp.lens_od')); set('ed_iop_od', safe(d, 'slitlamp.iop_od')); set('ed_sl_lids_os', safe(d, 'slitlamp.os.lids')); set('ed_sl_conj_os', safe(d, 'slitlamp.os.conj')); set('ed_sl_corn_os', safe(d, 'slitlamp.os.corn')); set('ed_sl_ac_os', safe(d, 'slitlamp.os.ac')); set('ed_sl_pupil_os', safe(d, 'slitlamp.os.pupil')); set('ed_sl_lens_os', safe(d, 'slitlamp.lens_os')); set('ed_iop_os', safe(d, 'slitlamp.iop_os')); set('ed_sl_remarks', safe(d, 'slitlamp.remarks'));
        const docData = currentVisit.doctorData || {};
        document.getElementById('diagnosis').value = docData.diagnosis || ""; document.getElementById('advice').value = docData.advice || ""; document.getElementById('follow_up_date').value = docData.followUp || "";
        document.querySelector('#med-table tbody').innerHTML = ""; if(docData.meds && docData.meds.length > 0) { docData.meds.forEach(m => addMedRow(m)); } else { window.addMedRow(); }
    };

    window.cancelConsult = function() { document.getElementById('consult-section').classList.add('hidden'); document.getElementById('doc-queue-section').classList.remove('hidden'); currentVisit = null; };
    window.addMedRow = function(data = {}) {
        const tbody = document.querySelector('#med-table tbody'); const tr = document.createElement('tr');
        tr.innerHTML = `<td><select class="med-eye" style="width:100%;font-weight:bold;"><option value="Both Eyes">Both Eyes</option><option value="Right Eye">Right Eye</option><option value="Left Eye">Left Eye</option><option value="-">-</option></select></td><td><input class="med-name" list="med-list" placeholder="Medicine" value="${data.name||''}"></td><td><input class="med-dose" placeholder="Dose" value="${data.dose||''}"></td><td><input class="med-freq" list="freq-list" placeholder="Freq" value="${data.freq||''}"></td><td><input class="med-dur" placeholder="Days / Weeks / Continue" value="${data.duration||''}"></td><td><button type="button" onclick="this.closest('tr').remove()" style="color:red;border:none;background:none;font-weight:bold;">X</button></td>`;
        if(data.eye) tr.querySelector('.med-eye').value = data.eye; tbody.appendChild(tr);
    };

    async function performSave(silent = false) {
        if(!currentVisit || isSaving) return; // Fix 1: Guard
        isSaving = true;
        const autoSaveStatus = document.getElementById('autosave-status');
        if(silent) { autoSaveStatus.style.display = 'block'; }
        
        try {
            const fuDate = document.getElementById('follow_up_date').value; // YYYY-MM-DD
            // Fix 2: Safety Check for Vulnerable Patients
            const age = parseInt(currentVisit.age);
            if ((age < 12 || age >= 60) && !fuDate) {
                if(!silent) showToast("‚ö†Ô∏è Alert: Please set Follow-up Date for Paediatric/Senior patient.", 'warning');
                isSaving = false;
                if(silent) setTimeout(() => autoSaveStatus.style.display = 'none', 500);
                return;
            }
            if(fuDate) {
                const todayStr = new Date().toLocaleDateString('en-CA'); 
                if (fuDate <= todayStr) {
                    if(!silent) showToast("Error: Follow-up date must be in the future.", 'error'); 
                    isSaving = false;
                    if(silent) setTimeout(() => autoSaveStatus.style.display = 'none', 500);
                    return;
                }
            }

            const meds = []; 
            document.querySelectorAll('#med-table tbody tr').forEach(tr => { 
                const name = tr.querySelector('.med-name').value; 
                if(name) meds.push({ eye: tr.querySelector('.med-eye').value, name, dose: tr.querySelector('.med-dose').value, freq: tr.querySelector('.med-freq').value, duration: tr.querySelector('.med-dur').value }); 
            });

            let updatedOpto = currentVisit.optoData || {};
            const set = (obj, path, val) => { const k = path.split('.'); let t = obj; k.slice(0,-1).forEach(key=>{ if(!t[key])t[key]={}; t=t[key]; }); t[k.pop()] = val; };
            const ids = ['ed_cc','ed_oh','ed_sys','ed_pgp_sph_od','ed_pgp_cyl_od','ed_pgp_ax_od','ed_pgp_add_od','ed_pgp_sph_os','ed_pgp_cyl_os','ed_pgp_ax_os','ed_pgp_add_os','ed_ext_od','ed_ext_os','ed_va_od','ed_va_os','ed_ph_od','ed_ph_os','ed_va_near_od','ed_va_near_os','ed_rx_sph_od','ed_rx_cyl_od','ed_rx_ax_od','ed_rx_add_od','ed_rx_va_od','ed_rx_sph_os','ed_rx_cyl_os','ed_rx_ax_os','ed_rx_add_os','ed_rx_va_os','ed_sl_lids_od','ed_sl_conj_od','ed_sl_corn_od','ed_sl_ac_od','ed_sl_pupil_od','ed_sl_lens_od','ed_iop_od','ed_sl_lids_os','ed_sl_conj_os','ed_sl_corn_os','ed_sl_ac_os','ed_sl_pupil_os','ed_sl_lens_os','ed_iop_os','ed_sl_remarks'];
            const paths = ['history.complaint','history.ocular_hx','history.systemic','pgp.od.sph','pgp.od.cyl','pgp.od.ax','pgp.od.add','pgp.os.sph','pgp.os.cyl','pgp.os.ax','pgp.os.add','external.od.ext','external.os.ext','va.od.dist','va.os.dist','va.od.ph','va.os.ph','va.od.near','va.os.near','refraction.od.sph','refraction.od.cyl','refraction.od.ax','refraction.od.add','refraction.od.va','refraction.os.sph','refraction.os.cyl','refraction.os.ax','refraction.os.add','refraction.os.va','slitlamp.od.lids','slitlamp.od.conj','slitlamp.od.corn','slitlamp.od.ac','slitlamp.od.pupil','slitlamp.lens_od','slitlamp.iop_od','slitlamp.os.lids','slitlamp.os.conj','slitlamp.os.corn','slitlamp.os.ac','slitlamp.os.pupil','slitlamp.lens_os','slitlamp.iop_os','slitlamp.remarks'];
            ids.forEach((id, i) => set(updatedOpto, paths[i], document.getElementById(id).value));
            
            if(updatedOpto.external) { if(updatedOpto.external.od) { updatedOpto.external.od.eom = ""; updatedOpto.external.od.ct_dist = ""; } if(updatedOpto.external.os) { updatedOpto.external.os.eom = ""; updatedOpto.external.os.ct_dist = ""; } }
            if(updatedOpto.va) { if(updatedOpto.va.od) updatedOpto.va.od.rx = ""; if(updatedOpto.va.os) updatedOpto.va.os.rx = ""; }
            
            // Fix 3: Safer Status Logic
            const newStatus = ["Investigation", "Report Ready"].includes(currentVisit.status) ? currentVisit.status : "Completed";

            const dataToSave = { optoData: updatedOpto, doctorData: { diagnosis: document.getElementById('diagnosis').value, advice: document.getElementById('advice').value, followUp: document.getElementById('follow_up_date').value, meds }, status: newStatus, modifiedAt: new Date().toISOString() };
            if(!navigator.onLine) { pendingSaves.push({ id: currentVisit.firebaseId, data: dataToSave }); if(!silent) showToast("Saved Locally (Offline)", 'warning'); return; }
            await updateDoc(doc(db, "visits", currentVisit.firebaseId), dataToSave); 
            
            // NEW: Create Appointment for Follow-up automatically
            if (dataToSave.doctorData.followUp) {
                const apptDate = dataToSave.doctorData.followUp;
                const q = query(collection(db, "appointments"), 
                    where("pid", "==", currentVisit.pid), 
                    where("date", "==", apptDate));
                const snap = await getDocs(q);
                
                if (snap.empty) {
                    await addDoc(collection(db, "appointments"), {
                        pid: currentVisit.pid,
                        patientName: currentVisit.patientName,
                        phone: currentVisit.phone || "",
                        doctor: loggedInDoctor,
                        date: apptDate,
                        type: "Follow-up",
                        status: "Scheduled",
                        createdAt: new Date().toISOString()
                    });
                    if(!silent) showToast("Follow-up appointment scheduled for " + apptDate, "success");
                }
            }

            if(!silent) showToast("Saved to Cloud!", 'success');
        } catch(e) { 
            if(!silent) showToast("Save Failed: " + e.message, 'error'); 
        } finally {
            isSaving = false;
            if(silent) setTimeout(() => autoSaveStatus.style.display = 'none', 1000);
        }
    }

    window.sendToInvestigation = async function() { const invName = prompt("Enter Investigation Required:"); if(!invName) return; try { await updateDoc(doc(db, "visits", currentVisit.firebaseId), { status: "Investigation", investigationRequest: invName, investigationReport: "" }); alert("Sent to Optometrist."); window.cancelConsult(); } catch(e) { alert(e.message); } };
    window.openSurgeryModal = function() { if(!currentVisit) return; document.getElementById('surg_patient_name').innerText = `${currentVisit.patientName} (${currentVisit.pid})`; document.getElementById('surgeryModal').style.display = "block"; }
    window.closeSurgeryModal = function() { document.getElementById('surgeryModal').style.display = "none"; }

    window.printRx = async function() {
        if(!currentVisit) return;
        if(!document.getElementById('diagnosis').value.trim()) { showToast("‚ö†Ô∏è Diagnosis is required before printing.", 'error'); return; }
        try { await performSave(); } catch(e) { console.error(e); }
        const dr = doctorProfiles[loggedInDoctor] || { qual: "", reg: "", desig: "" };
        const v = (id) => document.getElementById(id) ? document.getElementById(id).value : '';
        const diag = v('diagnosis') || '-'; const adv = v('advice') || '-'; const rawFollowUp = v('follow_up_date');
        const showDiag = document.getElementById('chk_diagnosis').checked; const showAdv = document.getElementById('chk_advice').checked; const showMeds = document.getElementById('chk_meds').checked; const showGlasses = document.getElementById('chk_glasses').checked;
        let medRows = ""; 
        if(showMeds) { 
            document.querySelectorAll('#med-table tbody tr').forEach(tr => { 
                const name = tr.querySelector('.med-name').value; 
                const eye = tr.querySelector('.med-eye').value; 
                const dose = tr.querySelector('.med-dose').value;
                const freq = tr.querySelector('.med-freq').value;
                const dur = tr.querySelector('.med-dur').value;
                if(name) { medRows += `<tr><td><strong>${translate(eye)}</strong></td><td>${name}</td><td>${dose}</td><td>${translate(freq)}</td><td>${translate(dur)}</td></tr>`; }
            }); 
        }
        let glassesTable = "";
        if(showGlasses) { glassesTable = `<div class="section"><h4>Spectacle Prescription / ‡¶ö‡¶∂‡¶Æ‡¶æ‡ß∞ ‡¶™‡ßç‡ß∞‡ßá‡¶õ‡¶ï‡ßç‡ß∞‡¶ø‡¶™‡¶∂‡ßç‡¶Ø‡¶®</h4><table><thead><tr><th>Eye / ‡¶ö‡¶ï‡ßÅ</th><th>Sph / ‡¶ó‡ßã‡¶≤‡¶ï</th><th>Cyl / ‡¶ö‡ßÅ‡¶ô‡¶æ</th><th>Axis / ‡¶Ö‡¶ï‡ßç‡¶∑</th><th>Add / ‡¶ì‡¶ö‡ß∞‡ß∞ ‡¶™‡¶æ‡ß±‡¶æ‡ß∞</th><th>VA / ‡¶¶‡ßÉ‡¶∑‡ßç‡¶ü‡¶ø‡¶∂‡¶ï‡ßç‡¶§‡¶ø</th></tr></thead><tbody><tr><td><b>Right (OD)</b></td><td>${v('ed_rx_sph_od')}</td><td>${v('ed_rx_cyl_od')}</td><td>${v('ed_rx_ax_od')}</td><td>${v('ed_rx_add_od')}</td><td>${v('ed_rx_va_od')}</td></tr><tr><td><b>Left (OS)</b></td><td>${v('ed_rx_sph_os')}</td><td>${v('ed_rx_cyl_os')}</td><td>${v('ed_rx_ax_os')}</td><td>${v('ed_rx_add_os')}</td><td>${v('ed_rx_va_os')}</td></tr></tbody></table></div>`; }
        const win = window.open('', '', 'width=800,height=600');
        const content = `<html><head><title>Rx</title><base href="${window.location.href}"><style>body{font-family:'Segoe UI',sans-serif;padding:40px;color:#333;}.header-grid{display:grid;grid-template-columns:100px 1fr;gap:20px;align-items:center;border-bottom:3px solid #004085;padding-bottom:15px;margin-bottom:20px;}.header-text{text-align:center;}.header-text h2{margin:0;color:#004085;font-size:24px;text-transform:uppercase;}.header-text p{margin:2px 0;font-size:14px;}.meta{display:flex;justify-content:space-between;margin-bottom:20px;border-bottom:1px solid #ccc;padding-bottom:10px;align-items:flex-start;}.section{margin-bottom:15px;}.section h4{margin:0 0 8px 0;color:#004085;text-transform:uppercase;font-size:0.9em;border-bottom:1px solid #eee;padding-bottom:3px;display:inline-block;}.content{font-size:1.1em;line-height:1.5;}table{width:100%;border-collapse:collapse;}th,td{border-bottom:1px solid #ddd;padding:8px;text-align:left;}th{background-color:#f8f9fa;}.footer{margin-top:40px;display:flex;justify-content:space-between;align-items:flex-end;border-top:1px dotted #ccc;padding-top:20px;}</style></head><body onload="setTimeout(function(){window.print()}, 800)"><div class="header-grid"><img src="logo.png" style="width:100px;height:auto;"><div class="header-text"><h2>MSN Cataract and IOL Hospital</h2><p><em>(A unit of Kantashree Community Care)</em></p><p>Tilak Deka Road, Nagaon, Assam, Pin ‚Äì 782001</p><p>‡¶§‡¶ø‡¶≤‡¶ï ‡¶°‡ßá‡¶ï‡¶æ ‡¶™‡¶•, ‡¶®‡¶ó‡¶æ‡¶Å‡¶ì, ‡¶Ö‡¶∏‡¶Æ - ‡ß≠‡ßÆ‡ß®‡ß¶‡ß¶‡ßß</p><p>Mobile : 8486887503 | Govt. Licence No. ‚Äì SHA/205</p></div></div><div class="meta"><div style="flex:1;"><strong>Name / ‡¶®‡¶æ‡¶Æ:</strong> ${currentVisit.patientName}<br><strong>PID:</strong> ${currentVisit.pid} &nbsp;|&nbsp; <strong>Age/Sex:</strong> ${currentVisit.age}Y/${currentVisit.gender}<br><strong>Date / ‡¶§‡¶æ‡ß∞‡¶ø‡¶ñ:</strong> ${window.formatDate(getTodayISO())}</div><div style="flex:1;text-align:right;"><strong style="font-size:1.1em;color:#004085;">${loggedInDoctor}</strong><br><span style="font-size:0.9em;color:#555;">${dr.qual}</span><br><span style="font-size:0.9em;color:#555;">${dr.reg}</span><br><span style="font-size:0.85em;font-weight:bold;">${dr.desig}</span></div></div>${showDiag ? `<div class="section"><h4>Diagnosis / ‡ß∞‡ßã‡¶ó ‡¶®‡¶ø‡ß∞‡ßç‡¶£‡ßü</h4><div class="content">${diag.replace(/\n/g, '<br>')}</div></div>` : ''}${glassesTable}${showAdv ? `<div class="section"><h4>Advice / ‡¶™‡ß∞‡¶æ‡¶Æ‡ß∞‡ßç‡¶∂</h4><div class="content">${adv.replace(/\n/g, '<br>')}</div></div>` : ''}${showMeds && medRows ? `<div class="section"><h4>Medicines (Rx) / ‡¶î‡¶∑‡¶ß</h4><table><thead><tr><th>Eye / ‡¶ö‡¶ï‡ßÅ</th><th>Medicine / ‡¶î‡¶∑‡¶ß</th><th>Dose / ‡¶Æ‡¶æ‡¶§‡ßç‡ß∞‡¶æ</th><th>Freq / ‡¶¨‡¶æ‡ß∞</th><th>Duration / ‡¶∏‡¶Æ‡ßü</th></tr></thead><tbody>${medRows}</tbody></table></div>` : ''}${rawFollowUp ? `<div class="section" style="margin-top:20px; border:2px solid #000; padding:10px; display:inline-block;"><strong>Next Visit / ‡¶™‡ß∞‡ß±‡ß∞‡ßç‡¶§‡ßÄ ‡¶∏‡¶æ‡¶ï‡ßç‡¶∑‡¶æ‡ßé:</strong> <span style="font-size:1.2em; font-weight:bold;">${window.formatDate(rawFollowUp)}</span></div>` : ''}<div class="footer"><div style="font-size:0.8em;color:#777;">A Day Eye Care Institution<br>‡¶è‡¶ï ‡¶¶‡¶ø‡ß±‡¶∏‡ßÄ‡ßü ‡¶ö‡¶ï‡ßÅ‡ß∞ ‡¶ö‡¶ø‡¶ï‡¶ø‡ßé‡¶∏‡¶æ ‡¶™‡ßç‡ß∞‡¶§‡¶ø‡¶∑‡ßç‡¶†‡¶æ‡¶®</div><div style="text-align:center;">______________________<br><strong>Signature / ‡¶∏‡ßç‡¶¨‡¶æ‡¶ï‡ßç‡¶∑‡ß∞</strong></div></div></body></html>`;
        win.document.write(content); win.document.close();
    };

    // --- NEW: PRINT GLASSES SLIP ONLY (Small 1/4 Page Slip) ---
    window.printGlassesSlipOnly = function() {
        if(!currentVisit) return;
        const v = (id) => document.getElementById(id) ? document.getElementById(id).value : '';
        const n = currentVisit.patientName;
        const d = new Date().toLocaleDateString('en-GB'); 
        const win = window.open('', '', 'width=800,height=600');
        
        const content = `<html><head><title>Glasses Rx</title><base href="${window.location.href}"><style>body{font-family:sans-serif;padding:30px;} table{width:100%;border-collapse:collapse;margin-top:20px;} th, td{border:1px solid #000;padding:12px;text-align:center;}</style></head><body onload="setTimeout(function(){window.print();window.close()}, 800)">
            <div style="text-align:center;border-bottom:3px solid #004085;padding-bottom:10px;margin-bottom:20px;">
                <img src="logo.png" style="width:100px;">
                <h2 style="color:#004085;margin:0;">MSN Cataract and IOL Hospital</h2>
                <p>Tilak Deka Road, Nagaon | Phone: 8486887503</p>
            </div>
            <h3 style="text-align:center;text-decoration:underline;">Spectacle Prescription</h3>
            <p><strong>Name:</strong> ${n} &nbsp;&nbsp; <strong>Date:</strong> ${d} &nbsp;&nbsp; <strong>Age:</strong> ${currentVisit.age}Y</p>
            <table><thead><tr><th>Eye</th><th>Sph</th><th>Cyl</th><th>Axis</th><th>Add</th><th>VA</th></tr></thead><tbody><tr><td>OD</td><td>${v('ed_rx_sph_od')}</td><td>${v('ed_rx_cyl_od')}</td><td>${v('ed_rx_ax_od')}</td><td>${v('ed_rx_add_od')}</td><td>${v('ed_rx_va_od')}</td></tr><tr><td>OS</td><td>${v('ed_rx_sph_os')}</td><td>${v('ed_rx_cyl_os')}</td><td>${v('ed_rx_ax_os')}</td><td>${v('ed_rx_add_os')}</td><td>${v('ed_rx_va_os')}</td></tr></tbody></table>
            <br><br><div style="text-align:right;"><strong>${loggedInDoctor}</strong><br>Signature</div>
        </body></html>`;
        win.document.write(content); win.document.close();
    };

    window.openSurgeryModal = function() { document.getElementById('surgeryModal').style.display = "block"; }
    window.closeSurgeryModal = function() { document.getElementById('surgeryModal').style.display = "none"; }
    window.printAdmissionSlip = function() {
        if(!currentVisit) return;
        const eye = document.getElementById('surg_eye').value; const rawDate = document.getElementById('surg_date').value; 
        let dateStr = "To be decided"; if(rawDate) { const parts = rawDate.split('-'); if(parts.length === 3) dateStr = `${parts[2]}/${parts[1]}/${parts[0]}`; }
        const proc = document.getElementById('surg_proc').value; const power = document.getElementById('surg_power').value; const model = document.getElementById('surg_model').value; const notes = document.getElementById('surg_notes').value;
        const win = window.open('', '', 'width=800,height=600');
        const content = `<html><head><title>Admission</title><base href="${window.location.href}"><style>body{font-family:'Segoe UI',sans-serif;padding:40px;color:#333;}.header-grid{display:grid;grid-template-columns:100px 1fr;gap:20px;align-items:center;border-bottom:3px solid #dc3545;padding-bottom:15px;margin-bottom:20px;}.header-text{text-align:center;}.header-text h2{margin:0;color:#dc3545;font-size:24px;text-transform:uppercase;}.table{width:100%;border-collapse:collapse;margin-top:20px;}.table td{padding:12px;border:1px solid #ddd;font-size:1.1em;}.label{font-weight:bold;background:#f8f9fa;width:30%;}</style></head><body onload="window.print()"><div class="header-grid"><img src="logo.png" style="width:100px;"><div class="header-text"><h2>MSN Cataract and IOL Hospital</h2><p>Tilak Deka Road, Nagaon, Assam | Phone: 8486887503</p></div></div><h2 style="text-align:center;text-decoration:underline;">ADMISSION ADVICE</h2><table class="table"><tr><td class="label">Patient Name</td><td>${currentVisit.patientName}</td></tr><tr><td class="label">Age / Sex</td><td>${currentVisit.age} / ${currentVisit.gender}</td></tr><tr><td class="label">Planned Surgery</td><td><b>${proc}</b></td></tr><tr><td class="label">Eye</td><td><b>${eye}</b></td></tr><tr><td class="label">IOL Power</td><td><b>${power}</b></td></tr><tr><td class="label">IOL Model</td><td><b>${model}</b></td></tr><tr><td class="label">Date of Surgery</td><td><b>${dateStr}</b></td></tr><tr><td class="label">Instructions</td><td>${notes}</td></tr></table><div style="margin-top:50px;text-align:right;"><strong>${loggedInDoctor}</strong><br>Signature</div></body></html>`;
        win.document.write(content); win.document.close(); closeSurgeryModal();
    }
</script>
</body>
</html>

### **2. Update `reception.html`**
This update adds the new "Appointments" card below the main grid. It has a list of appointments for a selected date and a simple form to book new ones.

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reception - MSN Hospital</title>
    <link rel="stylesheet" href="style.css">
    <style>
        #search-result li { cursor: pointer; transition: background 0.2s; padding: 12px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; }
        #search-result li:hover { background-color: #f8f9fa; }
        #search-result li.selected { background-color: #e3f2fd; border-left: 4px solid #007bff; }
        .search-grid { display: grid; grid-template-columns: 1fr 1fr auto; gap: 10px; align-items: end; }
        .loading { color: #007bff; font-weight: bold; text-align: center; padding: 10px; }
        .warning-box { background: #fff3cd; color: #856404; padding: 10px; border: 1px solid #ffeeba; border-radius: 6px; margin-bottom: 15px; font-weight: bold; display: none; align-items: center; gap: 10px; }
        .warning-box.active { display: flex; }
        .stats-breakdown { display: flex; gap: 10px; margin-top: 10px; }
        .mini-stat { flex: 1; background: #fff; padding: 8px; border-radius: 6px; text-align: center; border: 1px solid #eee; font-size: 0.85em; }
        .dropdown { position: relative; display: inline-block; }
        .dropdown-menu { display: none; position: absolute; right: 0; background: white; box-shadow: 0 4px 12px rgba(0,0,0,0.15); border-radius: 6px; z-index: 100; min-width: 160px; border: 1px solid #eee; }
        .dropdown:hover .dropdown-menu { display: block; }
        .dropdown-item { padding: 10px 15px; cursor: pointer; display: block; width: 100%; text-align: left; border: none; background: none; transition: 0.2s; }
        .dropdown-item:hover { background-color: #f8f9fa; }
        .dropdown-item.danger { color: #dc3545; }
        /* Appointment Table Styles */
        .appt-row { cursor: pointer; transition: 0.2s; }
        .appt-row:hover { background-color: #f8f9fa; }
    </style>
</head>
<body>
<div id="toast-container"></div>
<div class="container">
    <header class="hospital-header">
        <img src="logo.png" alt="Logo" class="hospital-logo" onerror="this.style.display='none'">
        <div class="hospital-info">
            <h2>MSN Cataract and IOL Hospital</h2>
            <p class="text-muted">Reception Desk | <a href="index.html" style="text-decoration:none; color:var(--primary);">Back to Home</a></p>
        </div>
        <div style="margin-left:auto; font-size:0.8em; text-align:right; color:#777;">
            <div>Shortcuts:</div>
            <div><b>F1</b> Search | <b>F2</b> New | <b>Ctrl+S</b> Save</div>
        </div>
    </header>

    <div class="stats-row">
        <div class="stat-card blue">
            <span class="stat-number" id="stat-total">0</span>
            <span class="stat-label">Total DB</span>
        </div>
        <div class="stat-card green" style="flex:2; display:block; padding:10px 20px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                <span class="stat-label" style="margin:0;">Today's OPD</span>
                <span class="stat-number" id="stat-today" style="font-size:1.5em;">0</span>
            </div>
            <div class="stats-breakdown" id="stats-breakdown">
                <div class="mini-stat">Waiting <strong>0</strong></div>
                <div class="mini-stat">In-Clinic <strong>0</strong></div>
                <div class="mini-stat">Done <strong>0</strong></div>
            </div>
        </div>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 20px;">
        <div style="display:flex; flex-direction:column; gap:20px;">
            
            <section class="card" style="border-top: 4px solid #ffc107;">
                <h3>1. Search Patient (F1)</h3>
                <div class="search-grid">
                    <div><label>Patient ID</label><input id="search_pid" type="text" placeholder="P..." style="text-transform: uppercase;"></div>
                    <div><label>Phone</label><input id="search_phone" type="tel" placeholder="98..."></div>
                    <button type="button" onclick="searchPatient()" class="btn secondary">Find</button>
                </div>
                <ul id="search-result" style="margin-top:10px; max-height: 200px; overflow-y:auto; padding:0;"></ul>
            </section>

            <section class="card" style="border-top: 4px solid #007bff;">
                <h3 style="margin-bottom: 15px;">2. Patient Details (F2)</h3>
                <div id="age-warning-box" class="warning-box"></div>
                
                <form id="registrationForm" onsubmit="return false;">
                    <div class="row">
                        <div class="col"><label>Patient ID</label><input id="patient_id" type="text" placeholder="New" readonly style="background:#e8f0fe; color:#1967d2; font-weight:bold;"></div>
                        <div class="col"><label>Date of Birth</label><input id="dob" type="date" onchange="calculateAge(this.value)"></div>
                    </div>
                    <div class="row">
                        <div class="col wide">
                            <label>Full Name <span style="color:red">*</span></label>
                            <input id="name" type="text" required placeholder="Name" autocomplete="off">
                        </div>
                        <div class="col">
                            <label>Age</label>
                            <input id="age" type="number" placeholder="0" style="width:60px;" oninput="checkAge(this.value)">
                        </div>
                        <div class="col"><label>Sex</label><select id="gender"><option>Male</option><option>Female</option><option>Other</option></select></div>
                    </div>
                    <div class="row">
                        <div class="col wide"><label>Guardian / C/O</label><input id="guardian" type="text"></div>
                        <div class="col">
                            <label>Phone <span style="color:red">*</span></label>
                            <input id="phone" type="tel" required maxlength="10">
                            <div id="phone-error" class="error-text" style="color:red; font-size:0.8em; display:none;"></div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col narrow"><label>Pin</label><input id="pincode" type="text"></div>
                        <div class="col"><label>District</label><input id="district" type="text" value="Nagaon"></div>
                        <div class="col wide"><label>Address</label><input id="address" type="text" list="local-places"><datalist id="local-places"></datalist></div>
                    </div>
                    
                    <div class="row" style="background: #e9f7ef; padding: 10px; border: 1px solid #c3e6cb; border-radius:4px;">
                        <div class="col wide">
                            <label style="color:#155724; font-weight:bold;">Assign Doctor</label>
                            <select id="assigned_doctor" required style="border:1px solid #28a745;">
                                <option value="Dr. Jayanta Boroowa">Dr. Jayanta Boroowa</option>
                                <option value="Dr. Pratibha Chauhan Paul">Dr. Pratibha Chauhan Paul</option>
                                <option value="Dr. Nilutpal Borah">Dr. Nilutpal Borah</option>
                                <option value="Dr. Nilakshi Baruah">Dr. Nilakshi Baruah</option>
                                <option value="Dr. Sanjay Kr Buragohain">Dr. Sanjay Kr Buragohain</option>
                            </select>
                        </div>
                        <div class="col"><label>Type</label><select id="visit_type"><option>New Case</option><option>Review</option><option>Surgery</option></select></div>
                        <div class="col"><label>Fee (‚Çπ)</label><input id="fee" type="number" value="500"></div>
                    </div>

                    <div class="actions" style="margin-top:15px; display:flex; gap:10px;">
                        <button type="button" class="btn" id="saveBtn" onclick="savePatient()">üíæ Save (Ctrl+S)</button>
                        <button type="button" id="printLastBtn" class="btn warning hidden" onclick="printLastSlip()">üñ®Ô∏è Slip (F5)</button>
                        <button type="button" id="updateBtn" class="btn info hidden" onclick="updatePatientOnly()">Update Info</button>
                        <button type="button" class="btn ghost" onclick="resetForm()">Reset</button>
                    </div>
                </form>
            </section>
        </div>

        <div style="display:flex; flex-direction:column; gap:20px;">
            <section class="card">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h3>Today's OPD List</h3>
                    <div style="font-size:0.8em; color:green;">‚óè Live Sync Active</div>
                </div>
                <table id="patients-table" style="margin-top:15px; width:100%;">
                    <thead><tr><th>OPD</th><th>PID</th><th>Name</th><th>Doctor</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody><tr><td colspan="6" class="loading">Connecting...</td></tr></tbody>
                </table>
            </section>

            <section class="card" style="border-top: 4px solid #6f42c1;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h3>üìÖ Appointment Schedule</h3>
                    <input type="date" id="appt_date_picker" onchange="loadAppointments(this.value)" style="padding:5px;">
                </div>
                
                <div style="background:#f8f9fa; padding:10px; border-radius:6px; margin-bottom:10px; display:flex; gap:10px; align-items:center;">
                    <input id="appt_new_name" placeholder="Patient Name" style="flex:2;">
                    <input id="appt_new_phone" placeholder="Phone" style="flex:1;">
                    <button class="btn small info" onclick="bookManualAppointment()">+ Book</button>
                </div>

                <div style="max-height:300px; overflow-y:auto;">
                    <table id="appointments-table" style="width:100%; font-size:0.9em;">
                        <thead><tr><th>Time/Type</th><th>Patient</th><th>Doctor</th><th>Status</th></tr></thead>
                        <tbody><tr><td colspan="4" style="text-align:center; padding:10px; color:#666;">Select a date to view appointments.</td></tr></tbody>
                    </table>
                </div>
            </section>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "[https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js](https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js)";
    import { getFirestore, collection, addDoc, updateDoc, doc, onSnapshot, query, where, getDocs, setDoc, getCountFromServer } 
    from "[https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js](https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js)";

    const firebaseConfig = { apiKey: "AIzaSyBne_-4FcG5DjtUDVwdd1K-XDsHjX0JOEo", authDomain: "msn-hospital.firebaseapp.com", projectId: "msn-hospital", storageBucket: "msn-hospital.firebasestorage.app", messagingSenderId: "525072218332", appId: "1:525072218332:web:5940ec924f59db675adc19", measurementId: "G-FXXZ7STWDJ" };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    window.db = db; window.updateDoc = updateDoc; window.doc = doc; // For global access

    let todayVisits = [];
    let lastSavedData = null; 
    const nagaonPlaces = ["Nagaon Town", "Haibargaon", "Raha", "Kampur", "Dhing", "Rupahi", "Samaguri", "Kaliabor", "Jakhalabandha", "Hojai", "Lanka", "Doboka", "Lumding", "Batadrava", "Juria"];

    // --- INITIALIZATION ---
    window.addEventListener('load', async () => {
        const dl = document.getElementById('local-places');
        nagaonPlaces.forEach(p => { const o = document.createElement('option'); o.value = p; dl.appendChild(o); });
        try { const coll = collection(db, "patients"); const snapshot = await getCountFromServer(coll); document.getElementById('stat-total').innerText = snapshot.data().count; } catch (e) {}
        
        // Init Appointment Date Picker to Today
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('appt_date_picker').value = today;
        loadAppointments(today);
    });

    // --- KEYBOARD SHORTCUTS ---
    document.addEventListener('keydown', function(e) {
        if ((e.ctrlKey || e.metaKey) && e.key === 's') { e.preventDefault(); document.getElementById('saveBtn').click(); }
        if (e.key === 'F1') { e.preventDefault(); document.getElementById('search_pid').focus(); }
        if (e.key === 'F2') { e.preventDefault(); resetForm(); document.getElementById('name').focus(); }
        if (e.key === 'F5') { e.preventDefault(); if(lastSavedData) printLastSlip(); }
    });

    // --- REALTIME QUEUE & STATS ---
    function getTodayISO() { const d = new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }

    const q = query(collection(db, "visits"), where("isoDate", "==", getTodayISO()));
    
    onSnapshot(q, (snapshot) => {
        todayVisits = [];
        const tbody = document.querySelector('#patients-table tbody');
        tbody.innerHTML = '';
        
        let stats = { waiting: 0, clinic: 0, done: 0, total: 0 };

        snapshot.docs.forEach(doc => { 
            const d = { ...doc.data(), id: doc.id };
            todayVisits.push(d);
            
            if(d.status !== 'Cancelled') {
                stats.total++;
                if(d.status === 'Waiting') stats.waiting++;
                else if(['With Doctor','Investigation','Report Ready'].includes(d.status)) stats.clinic++;
                else if(d.status === 'Completed') stats.done++;
            }
        });
        
        todayVisits.sort((a,b) => (a.timestamp || 0) - (b.timestamp || 0));
        
        document.getElementById('stat-today').innerText = stats.total;
        document.getElementById('stats-breakdown').innerHTML = `
            <div class="mini-stat" style="color:#d39e00">Waiting <strong>${stats.waiting}</strong></div>
            <div class="mini-stat" style="color:#0d6efd">In-Clinic <strong>${stats.clinic}</strong></div>
            <div class="mini-stat" style="color:#198754">Done <strong>${stats.done}</strong></div>
        `;

        if (todayVisits.length === 0) { tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px;">No patients yet today.</td></tr>'; return; }

        todayVisits.forEach(v => {
            const tr = document.createElement('tr');
            let badgeClass = 'waiting';
            if(v.status === 'With Doctor') badgeClass = 'doc';
            else if(v.status === 'Investigation') badgeClass = 'investigation';
            else if(v.status === 'Report Ready') badgeClass = 'report';
            else if(v.status === 'Completed') badgeClass = 'completed';
            else if(v.status === 'Cancelled') badgeClass = 'cancelled';

            tr.innerHTML = `
                <td><strong>${v.opdId}</strong></td>
                <td>${v.pid}</td>
                <td>${v.patientName}<br><small>${v.age}Y / ${v.gender}</small></td>
                <td>${v.doctor || '-'}</td>
                <td><span class="badge ${badgeClass}">${v.status}</span></td>
                <td>
                    <div class="dropdown">
                        <button class="btn small info">Options ‚ñº</button>
                        <div class="dropdown-menu">
                            <button class="dropdown-item" onclick="window.printSlip('${v.patientName}', '${v.opdId}', '${v.doctor}', '${v.pid}', '${v.age}', '${v.gender}')">üñ®Ô∏è Print Slip</button>
                            <button class="dropdown-item" onclick="window.quickAction('${v.id}', 'Waiting')">‚è≥ Set Waiting</button>
                            <button class="dropdown-item danger" onclick="window.quickAction('${v.id}', 'Cancelled')">üö´ Cancel</button>
                        </div>
                    </div>
                </td>`;
            tbody.appendChild(tr);
        });
    });

    // --- QUICK ACTIONS ---
    window.quickAction = async function(id, status) {
        if(!confirm(`Change status to ${status}?`)) return;
        try { await updateDoc(doc(db, "visits", id), { status: status }); } 
        catch(e) { alert("Error: " + e.message); }
    };

    // --- APPOINTMENT SYSTEM LOGIC ---
    
    // 1. Load Appointments for Selected Date
    window.loadAppointments = async function(dateStr) {
        const tbody = document.querySelector('#appointments-table tbody');
        tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:10px;">Loading...</td></tr>';
        
        try {
            const q = query(collection(db, "appointments"), where("date", "==", dateStr));
            const snap = await getDocs(q);
            
            if (snap.empty) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:10px; color:#666;">No appointments for this date.</td></tr>';
                return;
            }
            
            tbody.innerHTML = '';
            const appts = snap.docs.map(doc => doc.data());
            
            // Sort by type (Follow-up first)
            appts.sort((a,b) => (a.type === 'Follow-up' ? -1 : 1));
            
            appts.forEach(a => {
                const tr = document.createElement('tr');
                tr.className = 'appt-row';
                let typeBadge = a.type === 'Follow-up' ? '<span class="badge" style="background:#17a2b8;">Follow-up</span>' : '<span class="badge" style="background:#6c757d;">New</span>';
                
                tr.innerHTML = `
                    <td>${typeBadge}</td>
                    <td><strong>${a.patientName}</strong><br><small>${a.phone || '-'}</small></td>
                    <td>${a.doctor || '-'}</td>
                    <td>${a.status}</td>
                `;
                // Click to quick-fill registration form
                tr.onclick = () => {
                    if(confirm(`Load appointment for ${a.patientName}?`)) {
                        document.getElementById('name').value = a.patientName;
                        document.getElementById('phone').value = a.phone || "";
                        if(a.pid) document.getElementById('patient_id').value = a.pid;
                        if(a.doctor) document.getElementById('assigned_doctor').value = a.doctor;
                        document.getElementById('visit_type').value = a.type === 'Follow-up' ? 'Review' : 'New Case';
                    }
                };
                tbody.appendChild(tr);
            });
            
        } catch (e) {
            console.error("Error loading appointments:", e);
            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; color:red;">Error loading data.</td></tr>';
        }
    };

    // 2. Book Manual Appointment
    window.bookManualAppointment = async function() {
        const name = document.getElementById('appt_new_name').value;
        const phone = document.getElementById('appt_new_phone').value;
        const date = document.getElementById('appt_date_picker').value;
        
        if(!name || !date) { alert("Please enter Name and select Date."); return; }
        
        try {
            await addDoc(collection(db, "appointments"), {
                patientName: name,
                phone: phone,
                date: date,
                type: "Manual",
                status: "Scheduled",
                doctor: "Unassigned",
                createdBy: "Reception",
                createdAt: new Date().toISOString()
            });
            
            alert("Appointment Booked!");
            document.getElementById('appt_new_name').value = "";
            document.getElementById('appt_new_phone').value = "";
            loadAppointments(date); // Refresh list
        } catch(e) {
            alert("Error: " + e.message);
        }
    };

    // --- DUPLICATE CHECK ---
    async function checkDuplicate(phone) {
        const q = query(collection(db, "patients"), where("phone", "==", String(phone)));
        const snap = await getDocs(q);
        if (!snap.empty) {
            const p = snap.docs[0].data();
            document.getElementById('phone').classList.add('invalid');
            document.getElementById('phone-error').innerText = `‚ö†Ô∏è Duplicate: ${p.name} (${p.id})`;
            document.getElementById('phone-error').style.display = 'block';
            return p;
        } else {
            document.getElementById('phone').classList.remove('invalid');
            document.getElementById('phone-error').style.display = 'none';
            return null;
        }
    }
    document.getElementById('phone').addEventListener('blur', (e) => checkDuplicate(e.target.value));

    // --- SEARCH ---
    window.searchPatient = async function() {
        const pid = document.getElementById('search_pid').value.trim().toUpperCase();
        const phone = document.getElementById('search_phone').value.trim();
        const resDiv = document.getElementById('search-result');
        
        if(!pid && !phone) return;
        
        resDiv.innerHTML = '<li style="color:#666; justify-content:center;">Searching...</li>';
        
        let q;
        if(pid) q = query(collection(db, "patients"), where("id", "==", pid));
        else if(phone) q = query(collection(db, "patients"), where("phone", "==", String(phone)));

        try {
            const snap = await getDocs(q);
            resDiv.innerHTML = '';
            
            if(snap.empty) { 
                resDiv.innerHTML = '<li style="color:red; justify-content:center;">No patient found.</li>'; 
                return; 
            }
            
            snap.forEach(doc => {
                const p = doc.data();
                const li = document.createElement('li');
                li.innerHTML = `
                    <div>
                        <strong>${p.name}</strong> <small>(${p.age}Y/${p.gender})</small><br>
                        <span style="font-size:0.8em; color:#555;">${p.phone} | ${p.address||''}</span>
                    </div>
                    <div style="text-align:right;">
                        <span class="badge" style="background:#eee; color:#333;">${p.id}</span>
                    </div>`;
                li.onclick = () => { 
                    fillForm(p); 
                    // Highlight logic
                    document.querySelectorAll('#search-result li').forEach(l => l.classList.remove('selected'));
                    li.classList.add('selected');
                };
                resDiv.appendChild(li);
            });
        } catch (e) { resDiv.innerHTML = '<li style="color:red">Error searching DB</li>'; }
    }

    function fillForm(p) {
        document.getElementById('patient_id').value = p.id; document.getElementById('name').value = p.name; document.getElementById('age').value = p.age; document.getElementById('dob').value = p.dob || ''; document.getElementById('gender').value = p.gender; document.getElementById('phone').value = p.phone; document.getElementById('address').value = p.address || ''; document.getElementById('guardian').value = p.guardian || ''; document.getElementById('district').value = p.district || 'Nagaon'; document.getElementById('pincode').value = p.pincode || ''; document.getElementById('visit_type').value = "Review"; document.getElementById('fee').value = "300"; 
        document.getElementById('updateBtn').classList.remove('hidden'); window.checkAge(p.age);
    }

    // --- SAVE LOGIC ---
    window.savePatient = async function() {
        // Safety Check for "Edit Mode" accidental save
        if (!document.getElementById('updateBtn').classList.contains('hidden')) {
            if(!confirm("‚ö†Ô∏è Patient loaded. Create a NEW VISIT for today?\n(Click Cancel to just update patient info)")) return;
        }

        const name = document.getElementById('name').value; const phone = document.getElementById('phone').value; const doctor = document.getElementById('assigned_doctor').value;
        if(!name || !phone || !doctor) { alert("Please fill Name, Phone, and select a Doctor."); return; }
        if(!/^\d{10}$/.test(phone)) { alert("Phone number must be exactly 10 digits."); return; }

        // Duplicate Check before save (if not explicitly creating repeat visit)
        const isEditMode = document.getElementById('updateBtn').classList.contains('hidden') === false;
        if(!isEditMode) {
            const dup = await checkDuplicate(phone);
            if(dup && !confirm(`‚ö†Ô∏è Patient ${dup.name} already exists with this phone.\n\nCreate duplicate entry anyway?`)) return;
        }
        
        // Prevent duplicate visit on SAME day
        const pidInput = document.getElementById('patient_id').value;
        if(pidInput && pidInput !== 'New') {
             const alreadyBooked = todayVisits.find(v => v.pid === pidInput && v.status !== 'Cancelled');
             if(alreadyBooked) {
                 alert(`‚ö†Ô∏è This patient is already booked today (OPD ${alreadyBooked.opdId}).`);
                 return;
             }
        }

        const btn = document.getElementById('saveBtn'); btn.innerText = "Processing..."; btn.disabled = true;
        try {
            const age = document.getElementById('age').value; const gender = document.getElementById('gender').value; const dob = document.getElementById('dob').value;
            const isNew = !pidInput || pidInput === 'New' || pidInput === ''; let finalPid = pidInput;
            
            if(isNew) {
                const yr = new Date().getFullYear().toString().substr(-2); const rnd = Math.floor(1000 + Math.random() * 9000); finalPid = `P-${yr}${rnd}`; 
                await setDoc(doc(db, "patients", finalPid), { id: finalPid, name, age, gender, phone: String(phone), dob, address: document.getElementById('address').value, guardian: document.getElementById('guardian').value, district: document.getElementById('district').value, pincode: document.getElementById('pincode').value, createdAt: new Date().toISOString() });
            }

            // Fix: Use Unique Timestamp Token for OPD ID
            const opdId = Date.now().toString().slice(-5);
            
            // Saving Address for Doctor View
            await addDoc(collection(db, "visits"), {
                pid: finalPid, patientName: name, age, gender, phone: String(phone),
                address: document.getElementById('address').value,
                doctor, opdId, status: "Waiting",
                date: new Date().toLocaleDateString('en-GB'), isoDate: getTodayISO(),
                type: document.getElementById('visit_type').value, fee: document.getElementById('fee').value, timestamp: Date.now()
            });

            alert("‚úÖ Saved! OPD ID: " + opdId);
            lastSavedData = { name, opdId, doctor, pid: finalPid, age, gender }; document.getElementById('printLastBtn').classList.remove('hidden'); document.getElementById('saveBtn').innerText = "Saved ‚úÖ";
        } catch(e) { alert("Error: " + e.message); btn.innerText = "üíæ Save (Ctrl+S)"; btn.disabled = false; } 
    }

    window.printLastSlip = function() { if(!lastSavedData) return; window.printSlip(lastSavedData.name, lastSavedData.opdId, lastSavedData.doctor, lastSavedData.pid, lastSavedData.age, lastSavedData.gender); if(confirm("Slip Printed. Clear form?")) resetForm(); };
    
    window.updatePatientOnly = async function() {
        const pid = document.getElementById('patient_id').value; if(!pid || pid === 'New') return;
        try {
            const btn = document.getElementById('updateBtn'); btn.innerText = "Updating...";
            await updateDoc(doc(db, "patients", pid), { name: document.getElementById('name').value, age: document.getElementById('age').value, phone: String(document.getElementById('phone').value), gender: document.getElementById('gender').value, dob: document.getElementById('dob').value, address: document.getElementById('address').value, district: document.getElementById('district').value, pincode: document.getElementById('pincode').value, guardian: document.getElementById('guardian').value });
            alert("Patient Details Updated!"); btn.innerText = "Update Info";
        } catch(e) { alert(e.message); }
    }

    window.printSlip = function(name, opd, docName, pid, age, sex) {
        const win = window.open('', '', 'width=400,height=500');
        win.document.write(`<html><body style="font-family:sans-serif; text-align:center; padding:20px;"><img src="logo.png" style="width:80px;"><h3>MSN Cataract & IOL Hospital</h3><p>OPD SLIP</p><hr><h1 style="font-size:3em; margin:10px 0;">${opd}</h1><p><strong>Date:</strong> ${new Date().toLocaleDateString('en-GB')}</p><p><strong>Name:</strong> ${name}</p><p><strong>PID:</strong> ${pid} &nbsp;|&nbsp; <strong>${age}Y / ${sex}</strong></p><p><strong>Doctor:</strong> ${docName}</p><hr><small>Please wait for your turn.</small></body></html>`);
        win.document.close(); win.onload = function() { win.print(); win.close(); };
    }

    window.resetForm = function() { document.getElementById('registrationForm').reset(); document.getElementById('patient_id').value = ""; document.getElementById('search-result').innerHTML = ""; document.getElementById('updateBtn').classList.add('hidden'); document.getElementById('printLastBtn').classList.add('hidden'); document.getElementById('saveBtn').innerText = "üíæ Save (Ctrl+S)"; document.getElementById('saveBtn').disabled = false; document.getElementById('age-warning-box').className = "warning-box"; document.getElementById('phone').classList.remove('invalid'); document.getElementById('phone-error').style.display='none'; document.getElementById('age').readOnly=false; lastSavedData = null; }
    
    // Lock age if DOB is set
    window.calculateAge = function(dob) { if(!dob) return; const d = new Date(dob); const diff = Date.now() - d.getTime(); const age = Math.abs(new Date(diff).getUTCFullYear() - 1970); document.getElementById('age').value = age; document.getElementById('age').readOnly = true; window.checkAge(age); }
    window.checkAge = function(age) { const box = document.getElementById('age-warning-box'); if(!age) { box.className="warning-box"; return; } if(age < 12) { box.innerText = "‚ö†Ô∏è Paediatric Patient (Child)"; box.className="warning-box active"; } else if(age >= 60) { box.innerText = "‚ö†Ô∏è Senior Citizen"; box.className="warning-box active"; } else { box.className="warning-box"; } }
</script>
</body>
</html>