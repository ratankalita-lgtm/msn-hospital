<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doctor Console - MSN Hospital</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .hidden { display: none; }
        .row { display: flex; gap: 15px; margin-bottom: 10px; }
        .col { flex: 1; display: flex; flex-direction: column; }
        
        /* Modern Input Styling */
        textarea, input, select { 
            width: 100%; 
            padding: 10px; 
            border: 1px solid #ced4da; 
            border-radius: 5px; 
            font-size: 0.95em; 
            font-family: 'Segoe UI', sans-serif;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
            box-sizing: border-box;
        }
        textarea:focus, input:focus, select:focus {
            border-color: #80bdff;
            outline: 0;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }
        label { font-weight: 600; color: #495057; margin-bottom: 5px; font-size: 0.9em; }

        /* Section Styling */
        .section-box {
            background: #fff;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }
        .section-header {
            font-size: 1.1em;
            font-weight: 700;
            color: #007bff;
            border-bottom: 2px solid #f0f4f8;
            padding-bottom: 10px;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Compact Grids for Data */
        .compact-grid { display: grid; grid-template-columns: 80px 1fr 1fr; gap: 8px; align-items: center; margin-bottom: 5px; }
        .compact-grid.header { font-weight: bold; background: #f8f9fa; padding: 8px; border-radius: 4px; color: #555; font-size: 0.85em; }
        .small-input { padding: 6px; font-size: 0.9em; text-align: center; }

        /* PGP Grid Specifics */
        .pgp-grid { display: grid; grid-template-columns: 60px 1fr 1fr 1fr 1fr; gap: 5px; align-items: center; margin-bottom: 5px; }
        
        .print-control { display: flex; align-items: center; gap: 5px; font-size: 0.85em; color: #666; margin-left: auto; }
        .status-investigation { background: #fff3cd; color: #856404; padding: 2px 8px; border-radius: 12px; font-size:0.8em; font-weight: bold; }
        .status-ready { background: #d4edda; color: #155724; padding: 2px 8px; border-radius: 12px; font-size:0.8em; font-weight: bold; }
        
        /* Queue Table */
        table { width: 100%; border-collapse: separate; border-spacing: 0; }
        th { background: #f8f9fa; color: #495057; padding: 12px; text-align: left; font-weight: 600; border-bottom: 2px solid #dee2e6; }
        td { padding: 12px; border-bottom: 1px solid #dee2e6; vertical-align: middle; }
        tr:last-child td { border-bottom: none; }
        tr:hover { background-color: #f8f9fa; }

    </style>
</head>
<body>

<div class="container">
    <header class="hospital-header">
        <img src="logo.png" alt="Logo" class="hospital-logo" onerror="this.style.display='none'">
        <div>
            <h2>Doctor Console</h2>
            <p class="text-muted" id="welcome-msg">Welcome</p>
        </div>
        <button class="btn ghost small" onclick="logout()" style="margin-left:auto;">Change Doctor</button>
    </header>

    <section id="doc-queue-section" class="card">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3>My Patients Queue</h3>
            <span style="color:green; font-size:0.8em;">‚óè Live Sync Active</span>
        </div>
        <table id="doc-queue" style="margin-top:10px;">
            <thead>
                <tr>
                    <th>OPD</th>
                    <th>Patient</th>
                    <th>Type</th>
                    <th>Status</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                <tr><td colspan="5" style="text-align:center; padding:20px;">Loading...</td></tr>
            </tbody>
        </table>
    </section>

    <section id="consult-section" class="hidden">
        
        <div style="background: white; padding: 15px 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; border-left: 5px solid #007bff;">
            <div>
                <h2 id="p-name" style="margin:0; color:#333; font-size: 1.5em;">-</h2>
                <small id="p-info" style="color:#777; font-size: 0.95em;">PID: -</small>
            </div>
            <button class="btn ghost" onclick="cancelConsult()">Back to List</button>
        </div>

        <div id="investigation-result-box" class="hidden" style="background:#d4edda; color:#155724; padding:15px; border:1px solid #c3e6cb; border-radius:8px; margin-bottom:20px;">
            <strong>üß™ Investigation Report Available:</strong>
            <p id="inv-report-text" style="margin:5px 0 0 0; white-space: pre-wrap; font-weight:bold;"></p>
        </div>
        
        <form onsubmit="event.preventDefault(); window.saveAndFinish();">
            
            <div class="section-box">
                <div class="section-header">1. History & Background (Editable)</div>
                
                <div class="row">
                    <div class="col">
                        <label>Chief Complaint</label>
                        <textarea id="ed_cc" rows="2" placeholder="e.g. Diminished vision..."></textarea>
                    </div>
                    <div class="col">
                        <label>Ocular History</label>
                        <textarea id="ed_oh" rows="2" placeholder="e.g. Cat Sx 2020..."></textarea>
                    </div>
                </div>
                <div class="row">
                    <div class="col">
                        <label>Systemic Diseases / Allergies</label>
                        <input id="ed_sys" type="text" placeholder="e.g. Diabetes, HTN...">
                    </div>
                </div>

                <div style="margin-top: 15px;">
                    <label style="color:#007bff;">Previous Glasses (PGP)</label>
                    <div class="pgp-grid" style="background: #f8f9fa; padding: 5px; border-radius: 4px; font-weight: bold; font-size: 0.85em; text-align: center;">
                        <div>Eye</div><div>Sph</div><div>Cyl</div><div>Axis</div><div>Add</div>
                    </div>
                    <div class="pgp-grid">
                        <div style="font-weight:bold; text-align:center;">OD</div>
                        <input id="ed_pgp_sph_od" class="small-input"><input id="ed_pgp_cyl_od" class="small-input"><input id="ed_pgp_ax_od" class="small-input"><input id="ed_pgp_add_od" class="small-input">
                    </div>
                    <div class="pgp-grid">
                        <div style="font-weight:bold; text-align:center;">OS</div>
                        <input id="ed_pgp_sph_os" class="small-input"><input id="ed_pgp_cyl_os" class="small-input"><input id="ed_pgp_ax_os" class="small-input"><input id="ed_pgp_add_os" class="small-input">
                    </div>
                </div>

                <div style="margin-top: 15px;">
                    <label style="color:#007bff;">External Exam</label>
                    <div class="row" style="gap: 5px;">
                        <input id="ed_ext_od" placeholder="OD External">
                        <input id="ed_ext_os" placeholder="OS External">
                    </div>
                </div>
            </div>

            <div class="section-box">
                <div class="section-header">2. Clinical Findings</div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:30px;">
                    
                    <div>
                        <h5 style="margin:0 0 10px 0; color:#555;">Visual Acuity</h5>
                        <div class="compact-grid header"><div>Test</div><div>OD</div><div>OS</div></div>
                        <div class="compact-grid"><div>Dist</div><input id="ed_va_od" class="small-input"><input id="ed_va_os" class="small-input"></div>
                        <div class="compact-grid"><div>Near</div><input id="ed_va_near_od" class="small-input"><input id="ed_va_near_os" class="small-input"></div>
                        <div class="compact-grid"><div>PH</div><input id="ed_ph_od" class="small-input"><input id="ed_ph_os" class="small-input"></div>

                        <h5 style="margin:20px 0 10px 0; color:#555;">Refraction</h5>
                        <div class="pgp-grid" style="background:#f1f3f5; padding:5px; border-radius:4px; font-weight:bold; font-size:0.8em; text-align:center;">
                            <div>Eye</div><div>Sph</div><div>Cyl</div><div>Axis</div><div>VA</div>
                        </div>
                        <div class="pgp-grid">
                            <div style="font-weight:bold; text-align:center;">OD</div>
                            <input id="ed_rx_sph_od" class="small-input"><input id="ed_rx_cyl_od" class="small-input"><input id="ed_rx_ax_od" class="small-input"><input id="ed_rx_va_od" class="small-input">
                        </div>
                         <div class="pgp-grid">
                            <div style="font-weight:bold; text-align:center;">OS</div>
                            <input id="ed_rx_sph_os" class="small-input"><input id="ed_rx_cyl_os" class="small-input"><input id="ed_rx_ax_os" class="small-input"><input id="ed_rx_va_os" class="small-input">
                        </div>
                        <div class="pgp-grid" style="margin-top:5px;">
                             <div style="font-size:0.8em; font-weight:bold;">Add</div>
                             <input id="ed_rx_add_od" class="small-input" placeholder="OD Add">
                             <input id="ed_rx_add_os" class="small-input" placeholder="OS Add">
                             <div></div><div></div>
                        </div>
                    </div>

                    <div>
                        <h5 style="margin:0 0 10px 0; color:#555;">Slit Lamp Examination</h5>
                        <div class="compact-grid header"><div>Part</div><div>OD</div><div>OS</div></div>
                        
                        <div class="compact-grid"><div>Lids</div><input id="ed_sl_lids_od" class="small-input"><input id="ed_sl_lids_os" class="small-input"></div>
                        <div class="compact-grid"><div>Conj</div><input id="ed_sl_conj_od" class="small-input"><input id="ed_sl_conj_os" class="small-input"></div>
                        <div class="compact-grid"><div>Cornea</div><input id="ed_sl_corn_od" class="small-input"><input id="ed_sl_corn_os" class="small-input"></div>
                        <div class="compact-grid"><div>AC</div><input id="ed_sl_ac_od" class="small-input"><input id="ed_sl_ac_os" class="small-input"></div>
                        <div class="compact-grid"><div>Pupil</div><input id="ed_sl_pupil_od" class="small-input"><input id="ed_sl_pupil_os" class="small-input"></div>
                        <div class="compact-grid"><div>Lens</div><input id="ed_sl_lens_od" class="small-input"><input id="ed_sl_lens_os" class="small-input"></div>
                        
                        <div class="compact-grid" style="background:#fff3cd; padding:5px; border-radius:4px; margin-top:5px;">
                            <div style="font-weight:bold; color:#856404;">IOP</div><input id="ed_iop_od" class="small-input" style="font-weight:bold;"><input id="ed_iop_os" class="small-input" style="font-weight:bold;">
                        </div>
                        <div style="margin-top:10px;">
                            <label style="font-size:0.9em;">Remarks</label>
                            <input id="ed_sl_remarks" class="small-input" style="text-align:left;">
                        </div>
                    </div>
                </div>
            </div>

            <div class="section-box" style="border-top: 5px solid #28a745;">
                <div class="section-header">3. Diagnosis & Treatment</div>

                <div class="row">
                    <div class="col">
                        <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                            <label>Diagnosis</label>
                            <label class="print-control"><input type="checkbox" id="chk_diagnosis" checked> Print</label>
                        </div>
                        <textarea id="diagnosis" rows="2"></textarea>
                    </div>
                </div>

                <div class="row">
                    <div class="col">
                        <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                            <label>Advice / Plan</label>
                            <label class="print-control"><input type="checkbox" id="chk_advice" checked> Print</label>
                        </div>
                        <div style="display:flex; gap:10px; margin-bottom:5px;">
                            <select id="advice_templates" onchange="applyTemplate(this.value)">
                                <option value="">-- Select Template --</option>
                            </select>
                            <button type="button" class="btn small" onclick="addNewTemplate()">Add</button>
                            <button type="button" class="btn small ghost" onclick="deleteTemplate()" style="color:red;">Del</button>
                        </div>
                        <textarea id="advice" rows="4"></textarea>
                    </div>
                </div>

                <div style="display:flex; justify-content:space-between; align-items:center; margin-top:20px; margin-bottom:5px;">
                    <label>Medicines (Rx)</label>
                    <label class="print-control"><input type="checkbox" id="chk_meds" checked> Print</label>
                </div>
                
                <table id="med-table" style="width:100%; margin-bottom:10px;">
                    <thead>
                        <tr>
                            <th style="width:90px;">Eye</th>
                            <th>Medicine</th>
                            <th>Dose</th>
                            <th>Freq</th>
                            <th>Dur</th>
                            <th style="width:30px;"></th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <button type="button" class="btn small" onclick="window.addMedRow()">+ Add Medicine</button>

                <div class="row" style="margin-top:25px; padding-top:15px; border-top:1px dashed #ccc; align-items:center;">
                    <div class="col" style="flex:0 0 150px;">
                        <label>Follow-up Date:</label>
                    </div>
                    <div class="col">
                        <input type="date" id="follow_up_date" style="max-width: 200px;">
                    </div>
                </div>
            </div>

            <div style="display:flex; gap:15px; margin-bottom:50px;">
                <button type="submit" class="btn" style="flex:1; padding:15px; font-size:1.1em;">Save & Finish</button>
                <button type="button" class="btn" onclick="window.sendToInvestigation()" style="background-color: #ffc107; color: #000; border:none; flex:1;">üî¨ Order Investigation</button>
                <button type="button" class="btn" onclick="window.printRx()" style="background-color: #17a2b8; color: white; border:none; flex:1;">üíæ Save & üñ®Ô∏è Print Rx</button>
            </div>
        </form>
    </section>
</div>

<datalist id="med-list">
    <option value="Moxifloxacin Eye Drop"><option value="Prednisolone Acetate"><option value="Carboxymethylcellulose (CMC)"><option value="Timolol Maleate"><option value="Nepafenac Eye Drop"><option value="Tropicamide + Phenylephrine"><option value="Atropine Ointment"><option value="Ciprofloxacin"><option value="Multivitamin Tablet"><option value="Paracetamol 500mg"><option value="Olopatadine Eye Drop"><option value="Brimonidine Tartrate"><option value="Dorzolamide"><option value="Latanoprost"><option value="Sodium Hyaluronate">
</datalist>

<datalist id="freq-list">
    <option value="1-0-1"><option value="1-1-1"><option value="1-0-0"><option value="0-0-1"><option value="0-1-0"><option value="SOS"><option value="HS (Bedtime)"><option value="Once a week"><option value="4 Times/Day"><option value="6 Times/Day"><option value="Every 2 Hours">
</datalist>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, doc, updateDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBne_-4FcG5DjtUDVwdd1K-XDsHjX0JOEo",
        authDomain: "msn-hospital.firebaseapp.com",
        projectId: "msn-hospital",
        storageBucket: "msn-hospital.firebasestorage.app",
        messagingSenderId: "525072218332",
        appId: "1:525072218332:web:5940ec924f59db675adc19",
        measurementId: "G-FXXZ7STWDJ"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    window.db = db; window.doc = doc; window.updateDoc = updateDoc;

    let db_visits = [];
    let currentVisit = null;
    let loggedInDoctor = "";

    const doctorProfiles = {
        "Dr. Jayanta Boroowa": { qual: "D.O.M.S", reg: "Regd. No ‚Äì 7048", desig: "Medical Director" },
        "Dr. Pratibha Chauhan Paul": { qual: "M.B.B.S., D.O.M.S.", reg: "Regd. No. AMC 25792", desig: "Fellow in Comprehensive Ophthalmology, Oculoplasty & Orbit" },
        "Dr. Nilutpal Borah": { qual: "MS", reg: "Regd. No. 10139", desig: "Specialist Medical Retina & Diabetic Eye Diseases" },
        "Dr. Nilakshi Baruah": { qual: "M.B.B.S., M.S., F.M.R.F", reg: "Regd. No. 17425", desig: "Fellow of Cornea, Anterior Segment & Refractive Surgery" },
        "Dr. Sanjay Kr Buragohain": { qual: "MS, DNB", reg: "Regd. No. 11863", desig: "Specialist Neuro‚ÄìOphthalmology & Glaucoma" }
    };

    window.onload = function() {
        loggedInDoctor = localStorage.getItem('loggedInDoctor');
        if(!loggedInDoctor) { alert("Please login first."); window.location.href = 'index.html'; return; }
        document.getElementById('welcome-msg').innerText = "Logged in as: " + loggedInDoctor;
        startDoctorSync();
        loadTemplates();
    };

    window.logout = function() { localStorage.removeItem('loggedInDoctor'); window.location.href = 'index.html'; };

    window.loadTemplates = function() {
        const select = document.getElementById('advice_templates');
        select.innerHTML = '<option value="">-- Select Template --</option>';
        const saved = JSON.parse(localStorage.getItem('templates_' + loggedInDoctor)) || [];
        saved.forEach(t => { const opt = document.createElement('option'); opt.value = t.text; opt.text = t.name; select.appendChild(opt); });
    };
    window.applyTemplate = function(text) {
        if(!text) return;
        const box = document.getElementById('advice');
        if(!box.value.includes(text)) box.value = box.value ? box.value + "\n" + text : text;
        document.getElementById('advice_templates').value = "";
    };
    window.addNewTemplate = function() {
        const name = prompt("Template Name:"); if(!name) return;
        const text = document.getElementById('advice').value.trim(); if(!text) return;
        const saved = JSON.parse(localStorage.getItem('templates_' + loggedInDoctor)) || [];
        saved.push({name, text});
        localStorage.setItem('templates_' + loggedInDoctor, JSON.stringify(saved));
        loadTemplates();
    };
    window.deleteTemplate = function() {
        if(confirm("Delete?")) {
            const val = document.getElementById('advice_templates').value;
            let saved = JSON.parse(localStorage.getItem('templates_' + loggedInDoctor)) || [];
            saved = saved.filter(t => t.text !== val);
            localStorage.setItem('templates_' + loggedInDoctor, JSON.stringify(saved));
            loadTemplates();
        }
    };

    function startDoctorSync() {
        onSnapshot(collection(db, "visits"), (snapshot) => {
            db_visits = snapshot.docs.map(doc => ({ ...doc.data(), firebaseId: doc.id }));
            renderQueue(); 
        });
    }

    function renderQueue() {
        const tbody = document.querySelector('#doc-queue tbody');
        if(!tbody) return;
        tbody.innerHTML = '';
        const todayIso = new Date().toLocaleDateString('en-CA'); 
        const queue = db_visits.filter(v => {
            const isToday = (v.isoDate && v.isoDate === todayIso) || (v.date === new Date().toLocaleDateString());
            const isValidStatus = ['Waiting', 'With Doctor', 'Report Ready'].includes(v.status);
            return isToday && isValidStatus && v.doctor === loggedInDoctor;
        });

        if(queue.length === 0) { tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px;">No patients found.</td></tr>'; return; }

        queue.forEach(v => {
            const tr = document.createElement('tr');
            let statusBadge = v.status;
            if(v.status === 'Report Ready') statusBadge = `<span class="status-ready">Report Ready</span>`;
            if(v.status === 'Investigation') statusBadge = `<span class="status-investigation">Investigation</span>`;
            if(v.status === 'With Doctor') tr.style.background = "#e8f0fe";
            
            tr.innerHTML = `<td>${v.opdId}</td><td><strong>${v.patientName}</strong><br><small>${v.age}Y/${v.gender}</small></td><td>${v.type}</td><td>${statusBadge}</td><td><button class="btn small" onclick="window.startConsult('${v.opdId}')">${v.status === 'With Doctor' ? 'Resume' : 'Consult'}</button></td>`;
            tbody.appendChild(tr);
        });
    }

    window.startConsult = function(opdId) {
        currentVisit = db_visits.find(v => v.opdId === opdId);
        if(!currentVisit) return;

        document.getElementById('doc-queue-section').classList.add('hidden');
        document.getElementById('consult-section').classList.remove('hidden');
        document.getElementById('p-name').innerText = currentVisit.patientName;
        document.getElementById('p-info').innerText = `PID: ${currentVisit.pid}`;

        // -- POPULATE INVESTIGATION BOX --
        const invBox = document.getElementById('investigation-result-box');
        if(currentVisit.investigationReport) {
            invBox.classList.remove('hidden');
            document.getElementById('inv-report-text').innerText = currentVisit.investigationReport;
        } else {
            invBox.classList.add('hidden');
        }

        // -- POPULATE DATA --
        const d = currentVisit.optoData || {};
        const safe = (obj, path) => path.split('.').reduce((acc, part) => acc && acc[part], obj) || '';

        // 1. History & PGP (NOW MAPPED TO INPUTS)
        document.getElementById('ed_cc').value = safe(d, 'history.complaint');
        document.getElementById('ed_oh').value = safe(d, 'history.ocular_hx');
        // Combine systemic/allergy for display if separate, or map directly if you prefer separate fields
        let sys = safe(d, 'history.systemic');
        if(safe(d, 'history.allergies')) sys += " / " + safe(d, 'history.allergies');
        document.getElementById('ed_sys').value = sys;
        
        document.getElementById('ed_pgp_sph_od').value = safe(d, 'pgp.od.sph');
        document.getElementById('ed_pgp_cyl_od').value = safe(d, 'pgp.od.cyl');
        document.getElementById('ed_pgp_ax_od').value = safe(d, 'pgp.od.ax');
        document.getElementById('ed_pgp_add_od').value = safe(d, 'pgp.od.add');

        document.getElementById('ed_pgp_sph_os').value = safe(d, 'pgp.os.sph');
        document.getElementById('ed_pgp_cyl_os').value = safe(d, 'pgp.os.cyl');
        document.getElementById('ed_pgp_ax_os').value = safe(d, 'pgp.os.ax');
        document.getElementById('ed_pgp_add_os').value = safe(d, 'pgp.os.add');
        
        document.getElementById('ed_ext_od').value = safe(d, 'external.od.ext');
        document.getElementById('ed_ext_os').value = safe(d, 'external.os.ext');

        // 2. Vision & Refraction
        document.getElementById('ed_va_od').value = safe(d, 'va.od.dist');
        document.getElementById('ed_va_os').value = safe(d, 'va.os.dist');
        document.getElementById('ed_ph_od').value = safe(d, 'va.od.ph');
        document.getElementById('ed_ph_os').value = safe(d, 'va.os.ph');
        document.getElementById('ed_va_near_od').value = safe(d, 'va.od.near');
        document.getElementById('ed_va_near_os').value = safe(d, 'va.os.near');

        document.getElementById('ed_rx_sph_od').value = safe(d, 'refraction.od.sph');
        document.getElementById('ed_rx_cyl_od').value = safe(d, 'refraction.od.cyl');
        document.getElementById('ed_rx_ax_od').value = safe(d, 'refraction.od.ax');
        document.getElementById('ed_rx_add_od').value = safe(d, 'refraction.od.add');
        document.getElementById('ed_rx_va_od').value = safe(d, 'refraction.od.va');

        document.getElementById('ed_rx_sph_os').value = safe(d, 'refraction.os.sph');
        document.getElementById('ed_rx_cyl_os').value = safe(d, 'refraction.os.cyl');
        document.getElementById('ed_rx_ax_os').value = safe(d, 'refraction.os.ax');
        document.getElementById('ed_rx_add_os').value = safe(d, 'refraction.os.add');
        document.getElementById('ed_rx_va_os').value = safe(d, 'refraction.os.va');
        
        // 3. Slit Lamp
        document.getElementById('ed_sl_lids_od').value = safe(d, 'slitlamp.od.lids');
        document.getElementById('ed_sl_conj_od').value = safe(d, 'slitlamp.od.conj');
        document.getElementById('ed_sl_corn_od').value = safe(d, 'slitlamp.od.corn');
        document.getElementById('ed_sl_ac_od').value = safe(d, 'slitlamp.od.ac');
        document.getElementById('ed_sl_pupil_od').value = safe(d, 'slitlamp.od.pupil');
        document.getElementById('ed_sl_lens_od').value = safe(d, 'slitlamp.lens_od');
        document.getElementById('ed_iop_od').value = safe(d, 'slitlamp.iop_od');

        document.getElementById('ed_sl_lids_os').value = safe(d, 'slitlamp.os.lids');
        document.getElementById('ed_sl_conj_os').value = safe(d, 'slitlamp.os.conj');
        document.getElementById('ed_sl_corn_os').value = safe(d, 'slitlamp.os.corn');
        document.getElementById('ed_sl_ac_os').value = safe(d, 'slitlamp.os.ac');
        document.getElementById('ed_sl_pupil_os').value = safe(d, 'slitlamp.os.pupil');
        document.getElementById('ed_sl_lens_os').value = safe(d, 'slitlamp.lens_os');
        document.getElementById('ed_iop_os').value = safe(d, 'slitlamp.iop_os');
        document.getElementById('ed_sl_remarks').value = safe(d, 'slitlamp.remarks');

        // Doctor Data
        const docData = currentVisit.doctorData || {};
        document.getElementById('diagnosis').value = docData.diagnosis || "";
        document.getElementById('advice').value = docData.advice || "";
        document.getElementById('follow_up_date').value = docData.followUp || "";
        
        document.querySelector('#med-table tbody').innerHTML = "";
        if(docData.meds && docData.meds.length > 0) {
            docData.meds.forEach(m => addMedRow(m));
        } else {
            window.addMedRow();
        }
    };

    window.cancelConsult = function() {
        document.getElementById('consult-section').classList.add('hidden');
        document.getElementById('doc-queue-section').classList.remove('hidden');
        currentVisit = null;
    };

    window.addMedRow = function(data = {}) {
        const tbody = document.querySelector('#med-table tbody');
        const tr = document.createElement('tr');
        tr.innerHTML = `<td><select class="med-eye" style="width:100%;font-weight:bold;"><option value="OU">OU</option><option value="OD">OD</option><option value="OS">OS</option><option value="-">-</option></select></td><td><input class="med-name" list="med-list" placeholder="Medicine" value="${data.name||''}"></td><td><input class="med-dose" placeholder="Dose" value="${data.dose||''}"></td><td><input class="med-freq" list="freq-list" placeholder="Freq" value="${data.freq||''}"></td><td><input class="med-dur" placeholder="Days" value="${data.duration||''}"></td><td><button type="button" onclick="this.closest('tr').remove()" style="color:red;border:none;background:none;font-weight:bold;">X</button></td>`;
        if(data.eye) tr.querySelector('.med-eye').value = data.eye;
        tbody.appendChild(tr);
    };

    async function performSave() {
        if(!currentVisit) return;
        
        const meds = [];
        document.querySelectorAll('#med-table tbody tr').forEach(tr => {
            const name = tr.querySelector('.med-name').value;
            if(name) meds.push({ eye: tr.querySelector('.med-eye').value, name, dose: tr.querySelector('.med-dose').value, freq: tr.querySelector('.med-freq').value, duration: tr.querySelector('.med-dur').value });
        });

        // Rewrite Opto Data with Edits
        let updatedOpto = currentVisit.optoData || {};
        const set = (obj, path, val) => { const k = path.split('.'); let t = obj; k.slice(0,-1).forEach(key=>{ if(!t[key])t[key]={}; t=t[key]; }); t[k.pop()] = val; };
        
        // 1. History
        set(updatedOpto, 'history.complaint', document.getElementById('ed_cc').value);
        set(updatedOpto, 'history.ocular_hx', document.getElementById('ed_oh').value);
        set(updatedOpto, 'history.systemic', document.getElementById('ed_sys').value);

        // 2. PGP & External
        set(updatedOpto, 'pgp.od.sph', document.getElementById('ed_pgp_sph_od').value);
        set(updatedOpto, 'pgp.od.cyl', document.getElementById('ed_pgp_cyl_od').value);
        set(updatedOpto, 'pgp.od.ax', document.getElementById('ed_pgp_ax_od').value);
        set(updatedOpto, 'pgp.od.add', document.getElementById('ed_pgp_add_od').value);

        set(updatedOpto, 'pgp.os.sph', document.getElementById('ed_pgp_sph_os').value);
        set(updatedOpto, 'pgp.os.cyl', document.getElementById('ed_pgp_cyl_os').value);
        set(updatedOpto, 'pgp.os.ax', document.getElementById('ed_pgp_ax_os').value);
        set(updatedOpto, 'pgp.os.add', document.getElementById('ed_pgp_add_os').value);

        set(updatedOpto, 'external.od.ext', document.getElementById('ed_ext_od').value);
        set(updatedOpto, 'external.os.ext', document.getElementById('ed_ext_os').value);
        
        // 3. Vision
        set(updatedOpto, 'va.od.dist', document.getElementById('ed_va_od').value);
        set(updatedOpto, 'va.os.dist', document.getElementById('ed_va_os').value);
        set(updatedOpto, 'va.od.ph', document.getElementById('ed_ph_od').value);
        set(updatedOpto, 'va.os.ph', document.getElementById('ed_ph_os').value);
        set(updatedOpto, 'va.od.near', document.getElementById('ed_va_near_od').value);
        set(updatedOpto, 'va.os.near', document.getElementById('ed_va_near_os').value);

        // 4. Refraction
        set(updatedOpto, 'refraction.od.sph', document.getElementById('ed_rx_sph_od').value);
        set(updatedOpto, 'refraction.od.cyl', document.getElementById('ed_rx_cyl_od').value);
        set(updatedOpto, 'refraction.od.ax', document.getElementById('ed_rx_ax_od').value);
        set(updatedOpto, 'refraction.od.add', document.getElementById('ed_rx_add_od').value);
        set(updatedOpto, 'refraction.od.va', document.getElementById('ed_rx_va_od').value);

        set(updatedOpto, 'refraction.os.sph', document.getElementById('ed_rx_sph_os').value);
        set(updatedOpto, 'refraction.os.cyl', document.getElementById('ed_rx_cyl_os').value);
        set(updatedOpto, 'refraction.os.ax', document.getElementById('ed_rx_ax_os').value);
        set(updatedOpto, 'refraction.os.add', document.getElementById('ed_rx_add_os').value);
        set(updatedOpto, 'refraction.os.va', document.getElementById('ed_rx_va_os').value);

        // 5. Slit Lamp
        set(updatedOpto, 'slitlamp.od.lids', document.getElementById('ed_sl_lids_od').value);
        set(updatedOpto, 'slitlamp.od.conj', document.getElementById('ed_sl_conj_od').value);
        set(updatedOpto, 'slitlamp.od.corn', document.getElementById('ed_sl_corn_od').value);
        set(updatedOpto, 'slitlamp.od.ac', document.getElementById('ed_sl_ac_od').value);
        set(updatedOpto, 'slitlamp.od.pupil', document.getElementById('ed_sl_pupil_od').value);
        set(updatedOpto, 'slitlamp.lens_od', document.getElementById('ed_sl_lens_od').value);
        set(updatedOpto, 'slitlamp.iop_od', document.getElementById('ed_iop_od').value);

        set(updatedOpto, 'slitlamp.os.lids', document.getElementById('ed_sl_lids_os').value);
        set(updatedOpto, 'slitlamp.os.conj', document.getElementById('ed_sl_conj_os').value);
        set(updatedOpto, 'slitlamp.os.corn', document.getElementById('ed_sl_corn_os').value);
        set(updatedOpto, 'slitlamp.os.ac', document.getElementById('ed_sl_ac_os').value);
        set(updatedOpto, 'slitlamp.os.pupil', document.getElementById('ed_sl_pupil_os').value);
        set(updatedOpto, 'slitlamp.lens_os', document.getElementById('ed_sl_lens_os').value);
        set(updatedOpto, 'slitlamp.iop_os', document.getElementById('ed_iop_os').value);
        
        set(updatedOpto, 'slitlamp.remarks', document.getElementById('ed_sl_remarks').value);

        await updateDoc(doc(db, "visits", currentVisit.firebaseId), {
            optoData: updatedOpto,
            doctorData: { 
                diagnosis: document.getElementById('diagnosis').value, 
                advice: document.getElementById('advice').value, 
                followUp: document.getElementById('follow_up_date').value,
                meds 
            },
            status: "Completed"
        });
    }

    window.sendToInvestigation = async function() {
        const invName = prompt("Enter Investigation Required:");
        if(!invName) return;
        try {
            await updateDoc(doc(db, "visits", currentVisit.firebaseId), {
                status: "Investigation",
                investigationRequest: invName,
                investigationReport: "" 
            });
            alert("Sent to Optometrist."); window.cancelConsult();
        } catch(e) { alert(e.message); }
    };

    window.saveAndFinish = async function() {
        try {
            const btn = document.querySelector('button[type="submit"]'); btn.innerText = "Saving...";
            await performSave();
            alert("Saved Successfully!"); window.cancelConsult(); btn.innerText = "Save & Finish";
        } catch(e) { alert("Error: " + e.message); }
    };

    window.printRx = async function() {
        if(!currentVisit) return;
        try { await performSave(); } catch(e) { console.error(e); }
        const dr = doctorProfiles[loggedInDoctor] || { qual: "", reg: "", desig: "" };
        const diag = document.getElementById('diagnosis').value || '-';
        const adv = document.getElementById('advice').value || '-';
        const followUp = document.getElementById('follow_up_date').value;
        const showDiag = document.getElementById('chk_diagnosis').checked;
        const showAdv = document.getElementById('chk_advice').checked;
        const showMeds = document.getElementById('chk_meds').checked;
        let medRows = "";
        if(showMeds) {
            document.querySelectorAll('#med-table tbody tr').forEach(tr => {
                const name = tr.querySelector('.med-name').value;
                const eye = tr.querySelector('.med-eye').value;
                if(name) medRows += `<tr><td><strong>${eye}</strong></td><td>${name}</td><td>${tr.querySelector('.med-dose').value}</td><td>${tr.querySelector('.med-freq').value}</td><td>${tr.querySelector('.med-dur').value}</td></tr>`;
            });
        }
        const win = window.open('', '', 'width=800,height=600');
        const content = `<html><head><title>Rx</title><base href="${window.location.href}"><style>body{font-family:'Segoe UI',sans-serif;padding:40px;color:#333;}.header-grid{display:grid;grid-template-columns:100px 1fr;gap:20px;align-items:center;border-bottom:3px solid #004085;padding-bottom:15px;margin-bottom:20px;}.header-text{text-align:center;}.header-text h2{margin:0;color:#004085;font-size:24px;text-transform:uppercase;}.header-text p{margin:2px 0;font-size:14px;}.meta{display:flex;justify-content:space-between;margin-bottom:20px;border-bottom:1px solid #ccc;padding-bottom:10px;align-items:flex-start;}.section h4{margin:0 0 8px 0;color:#004085;text-transform:uppercase;font-size:0.9em;border-bottom:1px solid #eee;padding-bottom:3px;display:inline-block;}.content{font-size:1.1em;line-height:1.5;margin-bottom:20px;}table{width:100%;border-collapse:collapse;}th,td{border-bottom:1px solid #ddd;padding:8px;text-align:left;}th{background-color:#f8f9fa;}.footer{margin-top:40px;display:flex;justify-content:space-between;align-items:flex-end;border-top:1px dotted #ccc;padding-top:20px;}</style></head><body onload="setTimeout(function(){window.print()}, 800)"><div class="header-grid"><img src="logo.png" style="width:100px;height:auto;"><div class="header-text"><h2>MSN Cataract and IOL Hospital</h2><p><em>(A unit of Kantashree Community Care)</em></p><p>Tilak Deka Road, Nagaon, Assam, Pin ‚Äì 782001</p><p>‡¶§‡¶ø‡¶≤‡¶ï ‡¶°‡ßá‡¶ï‡¶æ ‡¶™‡¶•, ‡¶®‡¶ó‡¶æ‡¶Å‡¶ì, ‡¶Ö‡¶∏‡¶Æ - ‡ß≠‡ßÆ‡ß®‡ß¶‡ß¶‡ßß</p><p>Mobile : 8486887503 | Govt. Licence No. ‚Äì SHA/205</p></div></div><div class="meta"><div style="flex:1;"><strong>Name / ‡¶®‡¶æ‡¶Æ:</strong> ${currentVisit.patientName}<br><strong>PID:</strong> ${currentVisit.pid} &nbsp;|&nbsp; <strong>Age/Sex:</strong> ${currentVisit.age}Y/${currentVisit.gender}<br><strong>Date / ‡¶§‡¶æ‡ß∞‡¶ø‡¶ñ:</strong> ${new Date().toLocaleDateString('en-IN')}</div><div style="flex:1;text-align:right;"><strong style="font-size:1.1em;color:#004085;">${loggedInDoctor}</strong><br><span style="font-size:0.9em;color:#555;">${dr.qual}</span><br><span style="font-size:0.9em;color:#555;">${dr.reg}</span><br><span style="font-size:0.85em;font-weight:bold;">${dr.desig}</span></div></div>${showDiag ? `<div class="section"><h4>Diagnosis / ‡ß∞‡ßã‡¶ó ‡¶®‡¶ø‡ß∞‡ßç‡¶£‡ßü</h4><div class="content">${diag.replace(/\n/g, '<br>')}</div></div>` : ''}${showAdv ? `<div class="section"><h4>Advice / ‡¶™‡ß∞‡¶æ‡¶Æ‡ß∞‡ßç‡¶∂</h4><div class="content">${adv.replace(/\n/g, '<br>')}</div></div>` : ''}${showMeds && medRows ? `<div class="section"><h4>Medicines (Rx) / ‡¶î‡¶∑‡¶ß</h4><table><thead><tr><th>Eye / ‡¶ö‡¶ï‡ßÅ</th><th>Medicine / ‡¶î‡¶∑‡¶ß</th><th>Dose / ‡¶Æ‡¶æ‡¶§‡ßç‡ß∞‡¶æ</th><th>Freq / ‡¶¨‡¶æ‡ß∞</th><th>Duration / ‡¶∏‡¶Æ‡ßü</th></tr></thead><tbody>${medRows}</tbody></table></div>` : ''}${followUp ? `<div class="section" style="margin-top:20px; border:2px solid #000; padding:10px; display:inline-block;"><strong>Next Visit / ‡¶™‡ß∞‡ß±‡ß∞‡ßç‡¶§‡ßÄ ‡¶∏‡¶æ‡¶ï‡ßç‡¶∑‡¶æ‡ßé:</strong> <span style="font-size:1.2em; font-weight:bold;">${new Date(followUp).toLocaleDateString('en-IN')}</span></div>` : ''}<div class="footer"><div style="font-size:0.8em;color:#777;">A Day Eye Care Institution<br>‡¶è‡¶ï ‡¶¶‡¶ø‡ß±‡¶∏‡ßÄ‡ßü ‡¶ö‡¶ï‡ßÅ‡ß∞ ‡¶ö‡¶ø‡¶ï‡¶ø‡ßé‡¶∏‡¶æ ‡¶™‡ßç‡ß∞‡¶§‡¶ø‡¶∑‡ßç‡¶†‡¶æ‡¶®</div><div style="text-align:center;">______________________<br><strong>Signature / ‡¶∏‡ßç‡¶¨‡¶æ‡¶ï‡ßç‡¶∑‡ß∞</strong></div></div></body></html>`;
        win.document.write(content); win.document.close();
    };
</script>
</body>
</html>